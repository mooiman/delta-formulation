%-------------------------------------------------------------------------------
\chapter{2D Shallow water equations}
%-------------------------------------------------------------------------------
Consider the non-linear wave equation
%\begin{subequations}
%    \begin{align}
%        \pdiff{h}{t} + \nabla \dotp \vec{q} & = 0,
%        \\
%        \pdiff{\vec{q}}{t} +  \nabla \dotp \left( \frac{\vec{q}\vec{q}^T}{h} \right) + \half g \nabla h^2 + gh\nabla z_b +   c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right) & = 0,
%    \end{align}
%\end{subequations}
%or
\begin{subequations}
    \begin{align}
    \pdiff{h}{t} & + \nabla \dotp \vec{q}  = 0,
    \\
    \pdiff{\vec{q}}{t} & + \nabla \dotp \left( \frac{\vec{q}\vec{q}^T}{h} \right) + gh \nabla \zeta +
    \nonumber \\
    & + c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right)
    - \nabla \dotp \left( \nu h \left(  \nabla \vec{q}/h + \nabla \vec{q}^T/h \right) \right) = 0,
    \\
    \zeta & = h + z_b,
\end{align}
\end{subequations}
with
\begin{symbollist}
    \item[$\zeta$] Water level  w.r.t.\ reference plane ($\zeta = h + z_b$), \bunit{\metre}.
    \item[$h$] Water depth ($h = \zeta - z_b$), \bunit{\metre}.
    \item[$z_b$] Bed level  w.r.t.\ reference plane, \bunit{\metre}.
    \item[$\vec{q}$] Flow, defined as $\vec{q} = (q, r)^T = (hu, hv)^T$, \bunit{\square\metre\per\second}.
    \item[$\vec{u}$] Velocity vector, defined as $\vec{u} = (u, v)^T$, \bunit{\metre\per\second}.
    \item[$c_f$] Bed shear stress coefficient, \bunit{-}.
    \begin{itemize}
        \item[Ch\'ezy:] $c_f = g/C^2$
    \end{itemize}
    \item[$C$] Ch\'ezy coefficient, \bunit{\metre^{\half}\, \second^{-1}}.

    \item[$g$] Acceleration due to gravity, \bunit{\metre\per\square\second}.
    \item[$\nu$] Kinematic viscosity, \bunit{\square\metre\per\second}.
\end{symbollist}
\vspace{1cm}
\begin{figure}[H]
    \centering
    \begin{center}
        \def\svgwidth{1.0\textwidth} % scaling text
        \resizebox{0.9\textwidth}{!}{
            \input{figures/definition_variables.pdf_tex}
        }
    \end{center}
    \caption{Definition sketch of water level ($\zeta$), bed level ($z_b$) and total water depth ($h$)}\label{fig:definition_variables_2d}
\end{figure}

\subsection*{Finite Volume approach}
Integrating the equations over a finite volume $\Omega$ yields:
%\begin{subequations}
%    \begin{align}
%        \int_\Omega \pdiff{h}{t}\, d\omega
%        + \int_\Omega \nabla \dotp \vec{q}\, d\omega & = 0,
%        \label{eq:pressure_dependent_on_h_a} \\
%        \int_\Omega \pdiff{\vec{q}}{t}\, d\omega
%        + \int_\Omega \nabla \dotp \left( \frac{\vec{q}\vec{q}^T}{h} \right)\, d\omega
%        + \int_\Omega \half  \nabla \left( g h^2 \right) \, d\omega
%        + \int_\Omega gh\nabla z_b\, d\omega + \int_\Omega c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right)\, d\omega & = 0,
%        \label{eq:pressure_dependent_on_h_b}
%    \end{align}
%    \label{eq:pressure_dependent_on_h}
%\end{subequations}
%or
\begin{subequations}
\begin{align}
    \int_\Omega \pdiff{h}{t}\, d\omega &
    + \int_\Omega \nabla \dotp \vec{q}\, d\omega  = 0,
    \label{eq:pressure_dependent_on_zeta_a}
    \\
    \int_\Omega \pdiff{\vec{q}}{t}\, d\omega &
    + \int_\Omega \nabla \dotp \left( \frac{\vec{q}\vec{q}^T}{h} \right)\, d\omega
    + \int_\Omega gh \nabla \zeta\, d\omega +
    \nonumber \\
    & + \int_\Omega c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right)\, d\omega
    - \int_\Omega \nabla \dotp \left( \nu h \left(  \nabla \vec{q}/h + \nabla \vec{q}^T/h \right) \right)\, d\omega = 0,
    \label{eq:pressure_dependent_on_zeta_b}
    \\
    \int_\Omega \zeta\, d\omega &
    = \int_\Omega h\, d\omega + \int_\Omega z_b\, d\omega,
    \label{eq:pressure_dependent_on_zeta_c}
\end{align}
\label{eq:pressure_dependent_on_zeta}
\end{subequations}

The 'linear' shallow water equations in curvilinear coordinates read:
\begin{align}
&J \pdiff{h}{t} +\pdiff{}{\xi} \left( y_{\eta}\, q - x_{\eta}\, r \right) + \pdiff{}{\eta} \left( -y_{\xi}\, q + x_{\xi}\, r \right) = 0,
\label{eq:continuity_curvi}
\\*
&J \pdiff{q}{t} + g h \left( y_{\eta}\, \pdiff{\zeta}{\xi} - y_{\xi}\, \pdiff{\zeta}{\eta} \right) = 0, & \textit{q-momentum eq.}
 \label{eq:q_momentum_curvi}
\\*
&J \pdiff{r}{t} + g h \left( -x_{\eta}\, \pdiff{\zeta}{\xi} + x_{\xi}\, \pdiff{\zeta}{\eta} \right) = 0, & \textit{r-momentum eq.}
 \label{eq:r_momentum_curvi}
\end{align}

%-------------------------------------------------------------------------------
\section{Space discretization, structured}
\begin{figure}[h]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \import{figures}{cartesian_grid_interior_2d.pdf_tex}
        }
    \end{center}
    \caption[Definition of the grid to solve the 2D-shallow water equations in the interior area]{Definition of the grid to solve the 2D-shallow water equations in the interior area. The black dots indicate the location of the quadrature points, and black diamonds the flux points.}
    \label{fig:2d_structured_grid}
\end{figure}
For the space discretizations of an arbitrary function $u$ on the quadrature point of a sub-control volume the following space interpolations are used, $u \in \{h,q,r\}$:
\begin{align}
    \left. u\right|_{i+\quart, j+\quart} & \approx \frac{1}{16}\left( 9u_{i, j} + 3 u_{i+1,j} + u_{i+1, j+1} + 3  u_{i, j+1}\right)
    \\
    \left.u\right|_{i+\half, j+\quart} & \approx \frac{1}{8} \left( 3 u_{i,j} + 3 u_{i+1,j} + u_{i+1, j+1} + u_{i, j+1} \right)
    \\
    \left. u \right|_{i+\quart, j+\half} & \approx \frac{1}{8} \left( 3 u_{i, j} + u_{i+1, j+1} + u_{i+1, j}  + 3 u_{i, j+1} \right)
\end{align}
See for the locations \autoref{fig:2d_structured_grid}.
%-------------------------------------------------------------------------------
\subsection{Discretizations continuity equation}
The discretization of continuity \autoref{eq:continuity_curvi} will be presented term by term.
%-------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the continuity equation reads:
\begin{align}
    J \int_{\Omega} \pdiff{h}{t}\, d\omega
\end{align}
which will be approximated by the sum of the integral over the sub-control volumes.
On a structured grid one control volume ($cv$) around a node consist of four sub-control volumes ($scv_i$, $i\in\{0,1,2,3\}$).
\begin{align}
    J_{cv}\int_{cv} \pdiff{h}{t}\, d\omega &=
    J_{scv_0}\int_{scv_0} \pdiff{h}{t}\, d\omega +
    J_{scv_1}\int_{scv_1} \pdiff{h}{t}\, d\omega +
    \nonumber \\*
    &\quad
    +J_{scv_2}\int_{scv_2} \pdiff{h}{t}\, d\omega +
    J_{scv_3}\int_{scv_3} \pdiff{h}{t}\, d\omega
\end{align}
For a curvilinear grid we get:
\begin{align}
    J_{cv}\int_{cv} \pdiff{h}{t}\, d\omega \approx &
    J_{scv_0}\Dtinv \left( h^{n+1,p+1}_{i-\quart, j-\quart} -  h^{n+1,n}_{i-\quart, j-\quart} \right) +
    \nonumber \\*
    &J_{scv_1}\Dtinv \left( h^{n+1,p+1}_{i+\quart, j-\quart} -  h^{n+1,n}_{i+\quart, j-\quart} \right) +
    \nonumber \\*
    &J_{scv_2}\Dtinv \left( h^{n+1,p+1}_{i+\quart, j+\quart} -  h^{n+1,n}_{i+\quart, j+\quart} \right) +
    \nonumber \\*
    &J_{scv_3}\Dtinv \left( h^{n+1,p+1}_{i-\quart, j+\quart} -  h^{n+1,n}_{i-\quart, j+\quart} \right)
\end{align}
with $J_{scv_i}$ the area of the sub control volume $i$.
For cartesian coordinates we have $J_{scv_i} = \quart \Dx\Dy$.

Just looking to the quadrature point of $scv_2$ as part of the control volume for node $(i,j)$ the discretization reads:
\begin{align}
    &J_{scv_2}\Dtinv \left( h^{n+1}_{i+\quart, j+\quart} -  h^{n+1,n}_{i+\quart, j+\quart} \right) =
    \\*
    &= J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9h^{n+1}_{i, j} + 3 h^{n+1}_{i+1,j}  + 3  h^{n+1}_{i, j+1} + h^{n+1}_{i+1, j+1}\right) \right. +
    \\*
    &\quad - \left. \frac{1}{16}\left( 9 h^{n}_{i, j} +  3 h^{n}_{i+1,j}  + 3  h^{n}_{i, j+1} + h^{n}_{i+1, j+1}\right)\right]
\end{align}
Written in \deltaformulation  it reads:
\begin{align}
    &J_{scv_2}\Dtinv \left( h^{n+1}_{i+\quart, j+\quart} -  h^{n}_{i+\quart, j+\quart} \right) =
    \nonumber \\*
    &=J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9 \Delta h^{n+1,p+1}_{i, j} + 3 \Delta q^{n+1,p+1}_{i+1,j+1}  + 3 \Delta q^{n+1,p+1}_{i, j+1} + \Delta h^{n+1,p+1}_{i+1, j+1}\right) \right] +
    \nonumber \\*
    & + J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9 h^{n+1,p}_{i, j} + 3 h^{n+1,p}_{i+1,j}  + 3 h^{n+1,p}_{i, j+1} + h^{n+1,p+1}_{i+1, j+1}\right) \right. +
    \nonumber \\*
    &\quad - \left. \frac{1}{16}\left( 9h^{n}_{i, j} +  3 h^{n}_{i+1,j}  + 3  h^{n}_{i, j+1} + h^{n}_{i+1, j+1}\right)\right]
\end{align}
with
\begin{align}
    J_{scv_2} &= x_\xi y_\eta - y_\xi x_\eta
\end{align}
where $x_\xi$, $y_\eta$, $y_\xi$ and $x_\eta$ at the quadrature point $qp$ are
\begin{align}
    x_{\xi_{qp}}  & = \quart ( 3 (x_{i+1,j} - x_{i,j}) + 1 (x_{i+1,j+1} - x_{i,j+1}) )
    \label{eq:scv2_dx_dxi}
    \\
    y_{\eta_{qp}} & = \quart ( 3 (y_{i,j+1} - y_{i,j}) + 1 (y_{i+1,j+1} - y_{i+1,j}) )
    \label{eq:scv2_dy_deta}
    \\
    y_{\xi_{qp}}  & = \quart ( 3 (y_{i+1,j} - y_{i,j}) + 1 (y_{i+1,j+1} - y_{i,j+1}) )
    \label{eq:scv2_dy_dxi}
    \\
    x_{\eta_{qp}} & = \quart ( 3 (x_{i,j+1} - x_{i,j}) + 1 (x_{i+1,j+1} - x_{i+1,j})  )
    \label{eq:scv2_dx_deta}
\end{align}
%-------------------------------------------------------------------------------
\subsubsection{Mass flux}
The discretization of the mass flux term of the continuity equation
\begin{align}
    \oint_{\partial\Omega_{\xi\eta}} \left( \left( y_{\eta} q - x_{\eta} r \right)n_\xi + \left( -y_{\xi} q + x_{\xi} r \right) n_\eta \right)\, dl
\end{align}
will be given is this section (\autoref{eq:transformed_mass_flux}, multiplied by $J$).
Where $\vec{n} = (n_\xi, n_\eta)^T$ is the outward normal vector.

The linearization in time reads:
\begin{align}
    \oint_{\partial\Omega_{\xi\eta}} \Big[&\left( y_\eta\left(q^{n+\theta, p} + \theta \Delta q\right) - x_\eta \left( r^{n+\theta, p} + \theta \Delta r  \right)
    \right) n_{\xi}
    \nonumber\\*
    &\qquad  + \left(-y_\xi\left(r^{n+\theta, p} + \theta \Delta r\right) +
      x_\xi\left( r^{n+\theta, p} + \theta \Delta r  \right) \right) n_\eta
      \Big]\, dl
\end{align}
This terms need to be computed for each of the control volume faces, taken into account the outward normal.
Eight faces on a structured grid.
For the quadrature point $(i+\half, j+\quart)$ where $\vec{n} = (1,0)^T$ and $\norm{dl} = \half$, reads:
\begin{align}
&\left( y_\eta\left(q^{n+\theta, p} + \theta \Delta q\right) - x_\eta \left( r^{n+\theta, p} + \theta \Delta r  \right)
    \right) n_{\xi}  \norm{dl} \approx
    \\
  &\approx \left[ \half y_\eta\left( q^{n+\theta, p} + \theta \Delta q \right)  -
  \half x_\eta \left( r^{n+\theta, p} + \theta \Delta r  \right) \right] n_\xi
\end{align}
with
\begin{align}
    & y_\eta\big|_{i+\half, j+\quart} = \half \left( y_{i,j+1} - y_{i, j} \right) +
    \half \left( y_{i+1,j+1} - y_{i+1, j} \right)
    \\*
    & x_\eta\big|_{i+\half, j+\quart} = \quart \left(3 \left( x_{i+1,j} - x_{i, j} \right) +
 \left( x_{i+1,j+1} - x_{i, j+1} \right) \right)
\end{align}
and for terms related to $q$ we get (similar for $r$):
\begin{align}
    q\big|^{n+\theta,p}_{i+\half, j+\quart} &= \frac{1}{8}\left(3 q^{n+\theta,p}_{i,j} + 3 q^{n+\theta,p}_{i+1,j} + 1 q^{n+\theta,p}_{i,j+1} + 1 q^{n+\theta,p}_{i+1,j+1} \right)
    \label{eq:belong_to_rhs}
    \\
    \theta \Delta q\big|_{i+\half, j+\quart} &= \theta\frac{1}{8}\left(3 \Delta q_{i,j} + 3 \Delta q_{i+1,j} + 1 \Delta q_{i,j+1} + 1 \Delta q_{i+1,j+1} \right) \label{eq:belong_to_matrix}
\end{align}
\Autoref{eq:belong_to_rhs} is part of the right hand side and \autoref{eq:belong_to_matrix} is a part of the matrix coefficients.
%-------------------------------------------------------------------------------
\subsection{Discretizations momentum equations}
The discretization of momentum \autoref{eq:pressure_dependent_on_zeta_b} will be presented term by term.
%--------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the momentum equation is only shown for the $q$-momentum equation, the time derivative for the $r$-momentum equation is similar. The time derivative for the $q$-momentum equation reads:
\begin{align}
    J \int_{\Omega} \pdiff{q}{t}\, d\omega
\end{align}
which will be approximated by the sum of the integral over the sub-control volumes.
On a structured grid one control volume ($cv$) around a node consist of four sub-control volumes ($scv_i$, $i\in\{0,1,2,3\}$).
For a curvilinear grid we get:
\begin{align}
    \int_{cv} \pdiff{q}{t}\, d\omega \approx &
    J_{scv_0} \Dtinv \left( q^{n+1}_{i-\quart, j-\quart} -  q^{n}_{i-\quart, j-\quart} \right) +
    \nonumber \\*
    &J_{scv_1} \Dtinv \left( q^{n+1}_{i+\quart, j-\quart} -  q^{n}_{i+\quart, j-\quart} \right) +
    \nonumber \\*
    &J_{scv_3} \Dtinv \left( q^{n+1}_{i+\quart, j+\quart} -  q^{n}_{i+\quart, j+\quart} \right) +
    \nonumber \\*
    &J_{scv_3} \Dtinv \left( q^{n+1}_{i-\quart, j+\quart} -  q^{n}_{i-\quart, j+\quart} \right)
\end{align}
with $J_{scv_i}$ the area of the sub control volume $i$, for cartesian coordinates we have $J_{scv_i} = \quart \Dx\Dy$.

Just looking to the quadrature point of $scv_2$ as part of the control volume for node $(i,j)$ the discretization reads:
\begin{align}
    &J_{scv_2}\Dtinv \left( q^{n+1}_{i+\quart, j+\quart} -  q^{n+1,n}_{i+\quart, j+\quart} \right) =
    \\*
    &= J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9q^{n+1}_{i, j} + 3 q^{n+1}_{i+1,j}  + 3  q^{n+1}_{i, j+1} + q^{n+1}_{i+1, j+1}\right) \right. +
    \\*
    &\quad - \left. \frac{1}{16}\left( 9 q^{n}_{i, j} +  3 q^{n}_{i+1,j}  + 3  q^{n}_{i, j+1} + q^{n}_{i+1, j+1}\right)\right]
\end{align}
Written in \deltaformulation  it reads:
\begin{align}
    &J_{scv_2}\Dtinv \left( q^{n+1}_{i+\quart, j+\quart} -  q^{n}_{i+\quart, j+\quart} \right) =
    \nonumber \\*
    &=J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9 \Delta q^{n+1,p+1}_{i, j} + 3 \Delta q^{n+1,p+1}_{i+1,j+1}  + 3 \Delta q^{n+1,p+1}_{i, j+1} + \Delta q^{n+1,p+1}_{i+1, j+1}\right) \right] +
    \nonumber \\*
    & + J_{scv_2}\Dtinv \left[ \frac{1}{16}\left( 9 q^{n+1,p}_{i, j} + 3 q^{n+1,p}_{i+1,j}  + 3 q^{n+1,p}_{i, j+1} + q^{n+1,p+1}_{i+1, j+1}\right) \right. +
    \nonumber \\*
    &\quad - \left. \frac{1}{16}\left( 9q^{n}_{i, j} +  3 q^{n}_{i+1,j}  + 3  q^{n}_{i, j+1} + q^{n}_{i+1, j+1}\right)\right]
\end{align}
with
\begin{align}
    J_{scv_2} &= x_\xi y_\eta - y_\xi x_\eta
\end{align}
where $x_\xi$, $y_\eta$, $y_\xi$ and $x_\eta$ at the quadrature point $qp$ are
\begin{align}
    x_{\xi_{qp}}  & = \quart ( 3 (x_{i+1,j} - x_{i,j}) + 1 (x_{i+1,j+1} - x_{i,j+1}) )
    \\
    y_{\eta_{qp}} & = \quart ( 3 (y_{i,j+1} - y_{i,j}) + 1 (y_{i+1,j+1} - y_{i+1,j}) )
    \\
    y_{\xi_{qp}}  & = \quart ( 3 (y_{i+1,j} - y_{i,j}) + 1 (y_{i+1,j+1} - y_{i,j+1}) )
    \\
    x_{\eta_{qp}} & = \quart ( 3 (x_{i,j+1} - x_{i,j}) + 1 (x_{i+1,j+1} - x_{i+1,j})  )
\end{align}

%--------------------------------------------------------------------------------
\subsubsection{Pressure term} \label{sec:linearized_pressure_zeta}
In this section we use that the pressure term is dependent on $\zeta$.
The discretization of the pressure term
\begin{align}
    &g h \left( y_{\eta}\, \pdiff{\zeta}{\xi} - y_{\xi}\, \pdiff{\zeta}{\eta} \right), \qquad &\textit{$q$-momentum eq.}
    \\*
    &g h \left( -x_{\eta}\, \pdiff{\zeta}{\xi} + x_{\xi}\, \pdiff{\zeta}{\eta} \right). \qquad &\textit{$r$-momentum eq.}
\end{align}
will be given in this section (multiplied by $J$).
The integral over a control volume will be the sum of integrals over the sub control volumes.
On a structured grid one control volume ($cv$) around a node consist of four sub-control volumes ($scv_i$, $i\in\{0,1,2,3\}$).
Thus
\begin{align}
    gh \nabla \zeta\big|_{sc} =
    gh \nabla \zeta\big|_{scv_0} +
    gh \nabla \zeta\big|_{scv_1} +
    gh \nabla \zeta\big|_{scv_2} +
    gh \nabla \zeta\big|_{scv_3}
\end{align}
%
%--------------------------------------------------------------------------------
\paragraph*{$q$-momentum}
Considering one sub-control volume and only for the $x$-direction (similar for the $y$-direction) then the linearization in time reads:
\begin{align}
    & g h \left( y_{\eta}\, \pdiff{\zeta}{\xi} - y_{\xi}\, \pdiff{\zeta}{\eta} \right) \approx
    \\
%    & \approx g h^{n+\theta,p+1}_{qp} \left( y_{\eta_{qp}}\pdiff{\zeta^{n+\theta,p+1}_{qp}}{\xi}
%    - y_{\xi_{qp}}\, \pdiff{\zeta^{n+\theta,p+1}_{qp}}{\eta} \right)\approx \\
   & \approx g \left( h^{n+\theta,p}_{qp} + \theta \Delta h_{qp}\right)  \times
   \\*
   & \qquad \times \left( y_{\eta_{qp}}\, \pdiff{}{\xi}\left(\zeta^{n+\theta,p}_{qp} + \theta \Delta \zeta_{qp} \right)
 - y_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} + \theta \Delta \zeta_{qp}   \right)
   \right)
\end{align}
with $qp$ the location of the quadrature point in the sub-control volume.
Assume that the higher order terms are negligible then the discretization for each of the 4 sub-control volumes reads:
%
\begin{align}
&g h^{n+\theta,p}_{qp} \left( y_{\eta_{qp}}\pdiff{}{\xi}\left( \zeta^{n+\theta,p}_{qp} \right)
- y_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} \right) \right) +
\\
&\qquad + g h^{n+\theta,p}_{qp} \left( y_{\eta_{qp}}\pdiff{}{\xi}\left(\theta\Delta \zeta_{qp}\right)
- y_{\xi_{qp}}\, \pdiff{}{\eta} \left(\theta\Delta\zeta_{qp} \right)
\right) +
\\
&\qquad + g
\left( y_{\eta_{qp}}\, \pdiff{}{\xi}\left(\zeta^{n+\theta,p}_{qp} \right)
 - y_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} \right)
\right)\theta \Delta h_{qp}
\end{align}
Just looking to the quadrature point of $scv_2$ as part of the control volume for node $(i,j)$ the discretization reads (term by term):
\begin{align}
    h^{n+\theta, p}_{i+\quart, j+\quart} & \approx
    \frac{1}{16}\left( 9h^{n+\theta, p}_{i, j} + 3 h^{n+\theta, p}_{i+1,j} + h^{n+\theta, p}_{i+1, j+1} + 3  h^{n+\theta, p}_{i, j+1}\right)
    \\*
    \pdiff{\zeta^{n+\theta, p}_{i+\quart, j+\quart}}{\xi} & \approx
   \left[ 3 \left(\zeta_{i+1,j} - \zeta_{i,j}\right) + \left( \zeta_{i+1,j+1} - \zeta_{i,j+1}\right) \right]
   \\*
\pdiff{\zeta^{n+\theta, p}_{i+\quart, j+\quart}}{\eta} & \approx
\left[ 3 \left(\zeta_{i,j+1} - \zeta_{i,j}\right) + \left( \zeta_{i+1,j+1} - \zeta_{i+1,j}\right) \right]
\\*
   \pdiff{\Delta \zeta^{n+1, p+1}_{i+\quart, j+\quart}}{\xi} & \approx
   \quart\left[ 3 \left(\Delta\zeta_{i+1,j} - \Delta\zeta_{i,j}\right) + \left(\Delta\zeta_{i+1,j+1} - \Delta\zeta_{i,j+1} \right) \right]
\\*
   \pdiff{\Delta \zeta^{n+1, p+1}_{i+\quart, j+\quart}}{\eta} & \approx
\quart\left[ 3 \left(\Delta\zeta_{i,j+1} - \Delta\zeta_{i,j}\right) + \left(\Delta\zeta_{i+1,j+1} - \Delta\zeta_{i+1,j} \right) \right]
\\*
   \Delta h^{n+1,p+1}_{i+\quart, j+\quart} & \approx
   \frac{1}{16}\left( 9\Delta h_{i, j} + 3 \Delta h_{i+1,j} + \Delta h_{i+1, j+1} + 3  \Delta h_{i, j+1}\right)
\end{align}
%
%--------------------------------------------------------------------------------
\paragraph*{$r$-momentum}
For the $r$-momentum equation:
\begin{align}
    & g h \left( -x_{\eta}\, \pdiff{\zeta}{\xi} + x_{\xi}\, \pdiff{\zeta}{\eta} \right) \approx
    \\
    %    & \approx g h^{n+\theta,p+1}_{qp} \left( y_{\eta_{qp}}\pdiff{\zeta^{n+\theta,p+1}_{qp}}{\xi}
    %    - y_{\xi_{qp}}\, \pdiff{\zeta^{n+\theta,p+1}_{qp}}{\eta} \right)\approx \\
    & \approx g \left( h^{n+\theta,p}_{qp} + \theta \Delta h_{qp}\right)  \times
    \\*
    & \qquad \times \left( -x_{\eta_{qp}}\, \pdiff{}{\xi}\left(\zeta^{n+\theta,p}_{qp} + \theta \Delta \zeta_{qp} \right)
    + x_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} + \theta \Delta \zeta_{qp}   \right)
    \right)
\end{align}
with $qp$ the location of the quadrature point in the sub-control volume.
The discretization for each of the 4 sub-control volumes reads:
%
\begin{align}
    &g h^{n+\theta,p}_{qp} \left( -x_{\eta_{qp}}\pdiff{}{\xi}\left( \zeta^{n+\theta,p}_{qp} \right)
    +x_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} \right) \right) +
    \\
    &\qquad + g h^{n+\theta,p}_{qp} \left( -x_{\eta_{qp}}\pdiff{}{\xi}\left(\theta\Delta \zeta_{qp}\right)
    + x_{\xi_{qp}}\, \pdiff{}{\eta} \left(\theta\Delta\zeta_{qp} \right)
    \right) +
    \\
    &\qquad + g
    \left(- x_{\eta_{qp}}\, \pdiff{}{\xi}\left(\zeta^{n+\theta,p}_{qp} \right)
    +x_{\xi_{qp}}\, \pdiff{}{\eta}\left(\zeta^{n+\theta,p}_{qp} \right)
    \right)\theta \Delta h_{qp}
\end{align}
%--------------------------------------------------------------------------------
\subsubsection{Convection}
The discretization of the convection term
\begin{align}
    &\oint_{\partial\Omega_{\xi\eta}} \left[  \left( y_{\eta}q - x_{\eta} r \right) \frac{q}{h}  n_\xi + \left( -y_{\xi}q  + x_{\xi}r\right) \frac{q}{h} n_\eta \right] \, dl,\qquad \textit{$q$-momentum eq.}
    \\
    &\oint_{\partial\Omega_{\xi\eta}} \left[  \left( y_{\eta}q - x_{\eta} r \right) \frac{r}{h}  n_\xi + \left( -y_{\xi}q  + x_{\xi}r\right) \frac{r}{h} n_\eta \right] \, dl,\qquad \textit{$r$-momentum eq.}
\end{align}
will be given in this section (\autoref{eq:transformed_convection_x}, multiplied with $J$).
Where $\vec{n} = (n_\xi, n_\eta)^T$ is the outward normal vector.

Considering one sub-control volume and only for the $x$-direction (similar for the
$y$-direction) then the linearization in time reads:
%
\begin{align}
    \oint_{\partial\Omega_{\xi\eta}} & \Bigg[\left( y_\eta\left(q^{n+\theta, p} + \theta \Delta q\right) - x_\eta \left( r^{n+\theta, p} + \theta \Delta r  \right) \right)
    \frac{q^{n+\theta, p} + \theta \Delta q}{h^{n+\theta, p} + \theta \Delta h} n_{\xi} +
    \nonumber\\*
    &\quad  + \left(-y_\xi\left(q^{n+\theta, p} + \theta \Delta q\right) +
    x_\xi\left( r^{n+\theta, p} + \theta \Delta r \right) \right) \frac{q^{n+\theta, p} + \theta \Delta q}{h^{n+\theta, p} + \theta \Delta h} n_\eta
    \Bigg]\, dl
\end{align}
These terms need to be computed for each of the control volume faces, taken
into account the outward normal. Eight faces on a structured grid.

The linearization in time for the $q$-momentum equation reads (see \autoref{eq:2d_convection_q_equation}):
%
\begin{align}
& \half \left( y_\eta q^{n+\theta, p} - x_\eta r^{n+\theta, p} \right)
\frac{q^{n+\theta, p}}{h^{n+\theta, p}} n_{\xi}
+ \half \left(-y_\xi q^{n+\theta, p} +
x_\xi r^{n+\theta, p} \right) \frac{q^{n+\theta, p}}{h^{n+\theta, p}} n_\eta +
\\
& + \half \theta \Delta h \Bigg[
\left( \frac{- y_\eta (q^{n+\theta, p})^2 + x_\eta {q^{n+\theta, p} r^{n+\theta, p}}}{(h^{n+\theta, p})^2} \right) n_\xi+
\left( \frac{- x_\xi q^{n+\theta, p}r^{n+\theta, p} + y_\xi (r^{n+\theta, p})^2}{(h^{n+\theta, p})^2} \right) n_\eta
\Bigg]+
\\
& + \half \theta \Delta q \Bigg[
\left( \frac{   2y_\eta q^{n+\theta, p} - x_\eta r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\xi +
\left( \frac{ - 2y_\xi  q^{n+\theta, p} + x_\xi  r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\eta
\Bigg] +
\\
& + \half \theta \Delta r \Bigg[
 \left( \frac{ - x_\eta q^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\xi +
 \left( \frac{   x_\xi  q^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\eta
\Bigg]
\end{align}
and for the $r$-momentum equation:
%
\begin{align}
    \oint_{\partial\Omega_{\xi\eta}} & \Bigg[ \left( y_{\eta}\left(q^{n+\theta, p} + \theta \Delta q\right) - x_{\eta} \left(r^{n+\theta, p} + \theta \Delta r\right) \right) \frac{r^{n+\theta, p} + \theta \Delta r}{h^{n+\theta, p} + \theta \Delta h}  n_\xi +
    \nonumber \\*
    &\quad + \left( -y_{\xi}\left(q^{n+\theta, p} + \theta \Delta q\right)  + x_{\xi}\left(r^{n+\theta, p} + \theta \Delta r\right)\right) \frac{r^{n+\theta, p} + \theta \Delta r}{h^{n+\theta, p} + \theta \Delta h} n_\eta \Bigg] \, dl
\end{align}
The linearization in time for the $r$-momentum equation reads (see \autoref{eq:2d_convection_r_equation}):
\begin{align}
& \half \left( y_\eta q^{n+\theta, p} - x_\eta r^{n+\theta, p} \right)
\frac{r^{n+\theta, p}}{h^{n+\theta, p}} n_{\xi}
+ \half \left(-y_\xi q^{n+\theta, p} +
x_\xi r^{n+\theta, p} \right) \frac{r^{n+\theta, p}}{h^{n+\theta, p}} n_\eta +
\\
& + \half \theta \Delta h \Bigg[
\left( \frac{- y_\eta q^{n+\theta, p} r^{n+\theta, p} + x_\eta (r^{n+\theta, p})^2}{(h^{n+\theta, p})^2}
\right) n_\xi +
\left( \frac{y_\xi q^{n+\theta, p}r^{n+\theta, p} - x_\xi  (r^{n+\theta, p})^2}{(h^{n+\theta, p})^2}
\right) n_\eta
\Bigg] +
\\
& + \half \theta \Delta q \Bigg[
\left( \frac{   y_\eta r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\xi +
\left( \frac{ - y_\xi  r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\eta
\Bigg]
\\
& + \half \theta \Delta r \Bigg[
\left( \frac{  y_\eta q^{n+\theta, p} - 2 x_\eta r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\xi+
\left( \frac{- y_\xi  q^{n+\theta, p} + 2 x_\xi  r^{n+\theta, p}}{h^{n+\theta, p}} \right) n_\eta
\Bigg] +
\end{align}

These terms need to be computed for each of the control volume faces, taken into account the outward normal.
Eight faces on a cartesian/curvilinear grid.

%--------------------------------------------------------------------------------
\subsubsection{Bed shear stress}
The bed shear stress  term in vector notation reads:
\begin{align}
    \int_\Omega c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right)\, d\omega.
\end{align}
The components for the two momentum equations read:
\begin{align}
    F_q = \int_\Omega c_f \left( \frac{q\abs{\vec{q}}}{h^2} \right)\, d\omega, \qquad \textit{q-momentum eq.}
    \\
    F_r = \int_\Omega c_f \left( \frac{r\abs{\vec{q}}}{h^2} \right)\, d\omega, \qquad \textit{r-momentum eq.}
\end{align}
and $\abs{\vec{q}} = \sqrt{q^2 + r^2}$.
To avoid the discontinuity in the first derivative around zero, the absolute function will be approximated by (the Newton iteration process needs $C^1$--continue functions)
\begin{align}
    \abs{\vec{q}} \approx \abs{\widetilde{\vec{q}}} = \left( (q^2 + r^2)^2 + \eps^4 \right)^\quart.
\end{align}
The bed shear stress then reads:
\begin{align}
    F_q \approx \Dx\Dy\, c_f \left( \frac{q\abs{\widetilde{\vec{q}}}}{h^2} \right), \qquad \textit{q-momentum eq.}
    \\
    F_r \approx \Dx\Dy\, c_f \left( \frac{r\abs{\widetilde{\vec{q}}}}{h^2} \right), \qquad \textit{r-momentum eq.}
\end{align}
The Jacobian for the bed shear stress $F(h,q,r)$ reads:
\begin{align}
%    &\begin{pmatrix}
%    J_{11} &  J_{12} &  J_{13}
%    \\
%     J_{21} &  J_{22} &  J_{23}
%    \end{pmatrix}
%    \rightarrow
    &\begin{pmatrix}
        \pdiff{F_q}{h} & \pdiff{F_q}{q} & \pdiff{F_q}{r}
        \\
        \pdiff{F_r}{h} & \pdiff{F_r}{q} & \pdiff{F_r}{r}
    \end{pmatrix}
    =
    \\
    &=
    \begin{pmatrix}
       -2c_f \frac{q\abs{\widetilde{\vec{q}}}}{h^3}
       & c_f\frac{\abs{\widetilde{\vec{q}}}}{h^2}
       + c_f \frac{q}{h^2} \frac{q(q^2+ r^2)}{\abs{\widetilde{\vec{q}}}^3}
       & c_f \frac{q}{h^2}\frac{r(q^2+ r^2)}{\abs{\widetilde{\vec{q}}}^3}
       \\
       -2c_f \frac{r\abs{\widetilde{\vec{q}}}}{h^3}
       & c_f \frac{r}{h^2}\frac{q(q^2+ r^2)}{\abs{\widetilde{\vec{q}}}^3}
       & c_f\frac{\abs{\widetilde{\vec{q}}}}{h^2}
       + c_f \frac{r}{h^2}\frac{r(q^2+ r^2)}{\abs{\widetilde{\vec{q}}}^3}
    \end{pmatrix}
\end{align}
All these coefficients of the Jacobian should be evaluated at the quadrature point of the sub-control volumes and evaluated at time level $(n+\theta,p)$.
The same applies also for the right hand side and evaluated at time level $(n+\theta,p)$.

The linearization in time for the $q$-momentum equation reads (see \autoref{eq:2d_convection_q_equation}):
\begin{align}
        &c_f \left( \frac{q^{n+\theta,p}_{qp}\abs{\widetilde{\vec{q}^{n+\theta,p}}}}{(h^{n+\theta,p}_{qp})^2} \right)
        - \left( 2 c_f \frac{ q^{n+\theta,p}_{qp} \abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}} }{(h^{n+\theta,p}_{qp})^3} \right) \theta \Delta h_{qp} +
        \\*
        & \quad +
        \left( c_f \frac{\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}}{(h^{n+\theta,p}_{qp})^2}
        + c_f \frac{q^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \frac{q^{n+\theta,p}_{qp}\left( (q^{n+\theta,p}_{qp})^2 + (r^{n+\theta,p}_{qp})^2 \right) }{\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}^3} \right) \theta \Delta q_{qp} +
        \\*
        & \quad + \left( c_f \frac{q^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2}
        \frac{ r^{n+\theta,p}_{qp} \left( (q^{n+\theta,p}_{qp})^2 + (r^{n+\theta,p}_{qp})^2  \right)}
        {\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}^3 } \right) \theta \Delta r_{qp}
 \end{align}
and for the $r$-momentum equation:
\begin{align}
        &c_f \left( \frac{r^{n+\theta,p}_{qp}\abs{\widetilde{\vec{q}^{n+\theta,p}}}}{(h^{n+\theta,p}_{qp})^2} \right)
        - \left( 2 c_f \frac{ r^{n+\theta,p}_{qp} \abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}} {(h^{n+\theta,p}_{qp})^3} \right) \theta \Delta h_{qp} +
        \\*
        & \quad + \left(
         c_f \frac{r^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2}\frac{q^{n+\theta,p}_{qp}\left( (q^{n+\theta,p}_{qp})^2 + (r^{n+\theta,p}_{qp})^2 \right)}
        {\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}^3 }
        \right) \theta \Delta q_{qp} +
        \\*
        &\quad + \left( c_f \frac{\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}}{(h^{n+\theta,p}_{qp})^2}
        + c_f \frac{r^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \frac{r^{n+\theta,p}_{qp}\left( (q^{n+\theta,p}_{qp})^2 + (r^{n+\theta,p}_{qp})^2 \right) }{\abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}}^3}  \right) \theta \Delta r_{qp}
\end{align}
with
\begin{align}
    \abs{\widetilde{\vec{q}^{n+\theta,p}_{qp}}} = \left( (q^2_{qp} + r^2_{qp})^2 + \eps^4 \right)^\quart.
\end{align}
These terms need to be computed for each quadrature points ($qp$) of the sub-control volumes.
%--------------------------------------------------------------------------------
\subsubsection{Viscosity}
The viscosity term in vector notation reads:
\begin{align}
    \int_\Omega \nabla \dotp \left( \nu h \left(  \nabla (\vec{q}/h) + \nabla (\vec{q}^T/h) \right) \right)\, d\omega =
    \oint_{\Omega}  \left( \nu h \left( \nabla (\vec{q}/h) + \nabla (\vec{q}^T/h) \right) \right) \dotp \vec{n}\, dl
\end{align}
with $\vec{n} = (n_x, n_y)^T$ the outward normal vector.
Written in components ($\vec{q} = (q, r)^T$):
\begin{align}
    &\oint_{\Omega}  \left( \nu h \left( \nabla (\vec{q}/h) + \nabla (\vec{q}^T/h) \right) \right) \dotp \vec{n}\, dl =
    \\
    & =
    \oint_{\Omega} \nu h
    \left(
    \begin{pmatrix}
    \pdiff{(q/h)}{x} & \pdiff{(q/h)}{y}
    \\
    \pdiff{(r/h)}{x} & \pdiff{(r/h)}{y}
    \end{pmatrix}
    +
    \begin{pmatrix}
    \pdiff{(q/h)}{x} & \pdiff{(r/h)}{x}
    \\
    \pdiff{(q/h)}{y} & \pdiff{(r/h)}{y}
   \end{pmatrix}
   \right)
    \dotp \vec{n}\, dl
\end{align}
The components for the two momentum equations read:
\begin{align}
    F_q
    & = \oint_{\Omega} \nu h
    \left[ 2\pdiff{(q/h)}{x} n_x
    + \left(\pdiff{(q/h)}{y} + \pdiff{(r/h)}{x}\right)n_y \right] \, dl
    \qquad \textit{q-momentum eq.}
    \\
    F_r
    & = \oint_{\Omega}  \nu h
    \left[ \left(\pdiff{(r/h)}{x} + \pdiff{(q/h)}{y}\right)n_x
    + 2\pdiff{(r/h)}{y} n_y \right] \, dl
    \qquad \textit{r-momentum eq.}
\end{align}
Written in linear terms for the derivative which read:
\begin{align}
    & \nu h \pdiff{(q/h)}{x} = \nu \left( \pdiff{q}{x} - \frac{q}{h}\pdiff{h}{x} \right),
%    \\
    \quad \nu h \pdiff{(q/h)}{y} = \nu \left( \pdiff{q}{y} - \frac{q}{h}\pdiff{h}{y} \right),
    \\
    & \nu h \pdiff{(r/h)}{x} = \nu \left( \pdiff{r}{x} - \frac{r}{h}\pdiff{h}{x} \right),
%    \\
    \quad \nu h \pdiff{(r/h)}{y} = \nu \left( \pdiff{r}{y} - \frac{r}{h}\pdiff{h}{y} \right)
\end{align}
then the equations for the momentum equations read:
\begin{align}
    F_q
    & = \oint_{\Omega}
    \left[ 2 \nu \left( \pdiff{q}{x} - \frac{q}{h}\pdiff{h}{x}\right)  n_x
    + \left(\nu \left( \pdiff{q}{y} - \frac{q}{h}\pdiff{h}{y} \right) +
    \nu \left( \pdiff{r}{x} - \frac{r}{h}\pdiff{h}{x} \right) \right)n_y \right] \, dl
    \\
    F_r
    & = \oint_{\Omega}
    \left[ \left(\nu \left( \pdiff{r}{x} - \frac{r}{h}\pdiff{h}{x} \right)
    + \nu \left( \pdiff{q}{y} - \frac{q}{h}\pdiff{h}{y} \right) \right)n_x
    + 2 \nu \left( \pdiff{r}{y} - \frac{r}{h}\pdiff{h}{y} \right) n_y \right] \, dl
\end{align}

These equations need to be  discretized on the quadrature points $qp$ at the control volume faces.
The discretization is first  given for expression $\cal{A}$ (using result from \autoref{sec:jacobians_with_non_linear_quotient_term} for the quotient):
\begin{align}
     & \nu_{qp} \pdiff{q^{n+\theta, p+1}_{qp}}{x}  -
    \nu_{qp} \frac{q^{n+\theta, p+1}}{h^{n+\theta, p+1}_{qp}}\pdiff{ h^{n+\theta, p+1}_{qp}}{x} \approx
    \\*
    & \approx
%    \nu_{qp} \pdiff{(q^{n+\theta,p}_{qp} +  \theta \Delta q_{qp})}{x}
%    - \nu_{qp} \frac{(q^{n+\theta,p}_{qp} +  \theta \Delta q_{qp})}{h^{n+\theta,p}_{qp}} (1 -  \frac{1}{h^{n+\theta,p}_{qp}}\theta \Delta h_{qp})  \pdiff{(h^{n+\theta,p}_{qp} +  \theta \Delta h_{qp})}{x} =
%    \\*
%    & =
    \nu_{qp} \pdiff{q^{n+\theta,p}_{qp}}{x} + \nu_{qp} \pdiff{}{x}(\theta \Delta q_{qp}) +
    \nonumber \\
    &- \nu_{qp} \left(
    \frac{q^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} - \frac{q^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \theta \Delta h_{qp} +
    \frac{1}{h^{n+\theta,p}_{qp}} \theta \Delta q_{qp}
    \right)\left(  \pdiff{h^{n+\theta,p}_{qp}}{x} + \pdiff{}{x}(\theta \Delta h_{qp}) \right) \approx
    \\
    & \approx
    \underbrace{\nu_{qp} \left( \pdiff{q^{n+\theta,p}_{qp}}{x} - \frac{q^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \pdiff{h^{n+\theta,p}_{qp}}{x} \right)}_{\textit {to right hand side}} +
    %
    \\*
& + \underbrace{\nu_{qp}  \frac{q^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \pdiff{h^{n+\theta,p}_{qp}}{x}}_{{\cal{A}}_1} \theta \Delta h_{qp}
+ \underbrace{\left(- \nu_{qp} \frac{1}{h^{n+\theta,p}_{qp}}  \pdiff{h^{n+\theta,p}_{qp}}{x}\right)}_{{\cal{B}}_1} \theta \Delta q_{qp}
    \\*
    & +
    \underbrace{\nu_{qp}}_{{\cal{C}}_1} \pdiff{}{x}(\theta \Delta q_{qp}) +
    \underbrace{\left(-\nu_{qp} \frac{q^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}}\right)}_{{\cal{D}}_1}
     \pdiff{}{x}(\theta \Delta h_{qp})
\end{align}
the terms $O(\Delta h\pdiff{\Delta h}{x}, \Delta q \pdiff{\Delta h}{x})$ are assumed to negligible.
In a similar way for the other three expressions:
\begin{align}
    & \nu_{qp} \pdiff{q^{n+\theta, p+1}_{qp}}{y}  -
\nu_{qp} \frac{q^{n+\theta, p+1}}{h^{n+\theta, p+1}_{qp}}\pdiff{ h^{n+\theta, p+1}_{qp}}{y} \approx
\\
    & \approx
\underbrace{\nu_{qp} \left( \pdiff{q^{n+\theta,p}_{qp}}{y} - \frac{q^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \pdiff{h^{n+\theta,p}_{qp}}{y} \right)}_{\textit {to right hand side}} +
%
\\*
& + \underbrace{\nu_{qp}  \frac{q^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \pdiff{h^{n+\theta,p}_{qp}}{y}}_{{\cal{A}}_2} \theta \Delta h_{qp}
+ \underbrace{\left(- \nu_{qp} \frac{1}{h^{n+\theta,p}_{qp}}  \pdiff{h^{n+\theta,p}_{qp}}{y}\right)}_{{\cal{B}}_2} \theta \Delta q_{qp}
\\*
& +
\underbrace{\nu_{qp}}_{{\cal{C}}_2} \pdiff{}{y}(\theta \Delta q_{qp}) +
\underbrace{\left(-\nu_{qp} \frac{q^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \right)}_{{\cal{D}}_2} \pdiff{}{y}(\theta \Delta h_{qp})
\end{align}
and
\begin{align}
    & \nu_{qp} \pdiff{r^{n+\theta, p+1}_{qp}}{x}  -
\nu_{qp} \frac{r^{n+\theta, p+1}}{h^{n+\theta, p+1}_{qp}}\pdiff{ h^{n+\theta, p+1}_{qp}}{x} \approx
\\
    & \approx
\underbrace{\nu_{qp} \left( \pdiff{r^{n+\theta,p}_{qp}}{x} - \frac{r^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \pdiff{h^{n+\theta,p}_{qp}}{x} \right)}_{\textit {to right hand side}} +
%
\\*
& + \underbrace{\nu_{qp}  \frac{r^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \pdiff{h^{n+\theta,p}_{qp}}{x}}_{{\cal{A}}_3} \theta \Delta h_{qp}
+ \underbrace{\left(- \nu_{qp} \frac{1}{h^{n+\theta,p}_{qp}}  \pdiff{h^{n+\theta,p}_{qp}}{x}\right)}_{{\cal{B}}_3} \theta \Delta r_{qp}
\\*
& +
\underbrace{\nu_{qp}}_{{\cal{C}}_3} \pdiff{}{x}(\theta \Delta r_{qp}) +
\underbrace{\left( -\nu_{qp} \frac{r^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \right)}_{{\cal{D}}_3} \pdiff{}{x}(\theta \Delta h_{qp})
\end{align}
and
\begin{align}
    & \nu_{qp} \pdiff{r^{n+\theta, p+1}_{qp}}{y}  -
\nu_{qp} \frac{r^{n+\theta, p+1}}{h^{n+\theta, p+1}_{qp}}\pdiff{ h^{n+\theta, p+1}_{qp}}{y} \approx
\\
    & \approx
\underbrace{\nu_{qp} \left( \pdiff{r^{n+\theta,p}_{qp}}{y} - \frac{r^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \pdiff{h^{n+\theta,p}_{qp}}{y} \right)}_{\textit {to right hand side}} +
%
\\*
& + \underbrace{\nu_{qp}  \frac{r^{n+\theta,p}_{qp}}{(h^{n+\theta,p}_{qp})^2} \pdiff{h^{n+\theta,p}_{qp}}{y}}_{{\cal{A}}_4} \theta \Delta h_{qp}
+ \underbrace{\left(- \nu_{qp} \frac{1}{h^{n+\theta,p}_{qp}}  \pdiff{h^{n+\theta,p}_{qp}}{y}\right)}_{{\cal{B}}_4} \theta \Delta r_{qp}
\\*
& +
\underbrace{\nu_{qp}}_{{\cal{C}}_4} \pdiff{}{y}(\theta \Delta r_{qp}) +
\underbrace{\left( -\nu_{qp} \frac{r^{n+\theta,p}_{qp}}{h^{n+\theta,p}_{qp}} \right)}_{{\cal{D}}_4} \pdiff{}{y}(\theta \Delta h_{qp})
\end{align}



This terms need to be computed for each of the control volume faces, taken into account the outward normal.
Eight faces on a cartesian/curvilinear grid.


%%--------------------------------------------------------------------------------
%\subsubsection{Pressure term, dependent on $h$}
%In this section we use that the pressure term is dependent on $h$.
%\begin{align}
%    \int_{\Omega_i} \half  \nabla \left( g h^2\right) \, d\omega & =
%    \int_{\partial\Omega_i} \half  g h^2 \vec{\hat n}\, dl \label{eq:2d_press_term}
%\end{align}
%The linearization of the pressure term in the momentum equation around iteration level $p$ read:
%\begin{align}
%    \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2  & =
%    \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2
%    + g h^{n+\theta,p+1}_{\partial\Omega_i} \left({h}^{n+\theta,p+1} - {h}^{n+\theta,p}\right) =
%    \\
%    & = \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2 + \theta  g h^{n+\theta,p+1}_{\partial\Omega_j} \Delta {h}^{n+1,p+1}
%\end{align}
%
%The component in $x$-direction read:
%\begin{align}
%    \int_{\partial\Omega_i} & \half  g h^2 \vec{\hat n} \dotp \vec{i_x}\, dl \approx
%    \nonumber \\
%    \approx  & \Dy \left( \half g \left(h^{n+\theta,p}_{i+\half,j}\right)^2 + \theta  g h^{n+\theta,p+1}_{i+\half,j} \Delta {h}^{n+1,p+1}_{i+\half,j}  \right) +
%    \nonumber \\
%    - & \Dy \left( \half g \left(h^{n+\theta,p}_{i-\half,j}\right)^2 + \theta  g h^{n+\theta,p+1}_{i-\half,j} \Delta {h}^{n+1,p+1}_{i-\half,j}  \right)
%\end{align}
%The component in $y$-direction read:
%\begin{align}
%    \int_{\partial\Omega_i} & \half  g h^2 \vec{\hat n} \dotp \vec{i_y}\, dl \approx
%    \nonumber \\
%    \approx  & \Dx \left( \half g \left(h^{n+\theta,p}_{i,j+\half}\right)^2 + \theta  g h^{n+\theta,p+1}_{i,j+\half} \Delta {h}^{n+1,p+1}_{i,j+\half}  \right) +
%    \nonumber \\
%    - & \Dx \left( \half g \left(h^{n+\theta,p}_{i,j-\half}\right)^2 + \theta  g h^{n+\theta,p+1}_{i,j-\half} \Delta {h}^{n+1,p+1}_{i,j-\half}  \right)
%\end{align}
%%-------------------------------------------------------------------------------
%\section{Space discretization, unstructured}
%\notyet
%------------------------------------------------------------------------------
\subsection{Discretization at boundary}
For the 2D non-linear wave equations (\autoref{eq:pressure_dependent_on_zeta}) at each boundary boundary conditions need to be prescribed, the number of boundary conditions depends on the flow direction on the boundary.
Considering a hyperbolic system, if the flow is flowing into the domain two boundary conditions need to prescribed and when the flow is flowing out the domain just one boundary need to prescribed.
This is according the characteristic theory of 2D hyperbolic systems \citep{DaubertEtGraffe1967}.
The ingoing information is called the \textbf{essential} boundary condition (Dirichlet or Neumann condition).
And a boundary condition to handle the outgoing wave is called the \textbf{natural} boundary condition.
So for inflow there are \textbf{two essential} and \textbf{one natural} boundary condition and for outflow there is \textbf{one} \textbf{essential} boundary condition and \textbf{two} \textbf{natural} boundary conditions.

The natural boundary condition is always located at the boundary of a control volume and the essential (the genuine) boundary condition is always located inside the last control volume of the grid, as indicated in \autoref{fig:structured_grid_along_straight_boundary}.
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_along_straight_boundary_essential_natural_2.pdf_tex}
        }
    \end{center}
    \caption[Definition of the grid to solve the 2D-shallow water equations at the boundary]{Dotted lines indicate the border of the control volumes. The natural boundary condition is located at the boundary of a control volume, the orange line and the essential boundary condition is located inside the last control volume, the cyan-colored line.
    The black diamonds are the location of the quadrature points at the boundary.}
    \label{fig:structured_grid_along_straight_boundary}
\end{figure}

The boundary conditions in this section are presented for the left/west boundary.
First the \textbf{essential} boundary conditions are discussed and after that the \textbf{natural} boundary condition.
A similar derivation can be given for right/east boundary.

%------------------------------------------------------------------------------
\subsubsection{Essential boundary condition}
The \textbf{essential} boundary condition is to be assumed somewhere in the first control volume, ($x_{i_{bc}}$ with $i_{bc} \in [i-\half, i+\half]$ ).
For simplicity the boundary condition is chosen to be on node $i=1$ (location $x_{1}$).

\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_along_straight_boundary_essential.pdf_tex}
        }
    \end{center}
    \caption{Essential boundary condition, dotted lines indicate the border of the control volumes.}    \label{fig:structured_grid_along_straight_boundary_essential}
\end{figure}
The \textbf{essential} boundary condition for the left/west boundary at $x_{1}$ reads, describing the ingoing wave (indicated with $h^+$, $q^+$, $r^+$) with as less as possible disturbing the outgoing wave (\autoref{eq:left_right_going_equations}):
\begin{align}
    \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} & = F(t)
    \label{eq:essential_conv_2d_1}
    \\
    \left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h^{+}}{t} - \pdiff{q^{+}}{t} & = 0
    \label{eq:essential_conv_2d_2}
\end{align}
\Autoref{eq:essential_conv_2d_2} means that the ingoing wave does not disturb the outgoing wave.
And we assume normal incoming waves, which means that $r^+=0$.

The \textbf{essential} boundary condition for the right/east boundary at $x_{I+\half}$ reads, describing the ingoing wave (indicated with $h^-$, $q^-$, $r^-$) with as less as possible disturbing the outgoing wave (\autoref{eq:left_right_going_equations}):\begin{align}
    \left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h^{-}}{t} - \pdiff{q^{-}}{t} & = G(t)
    \label{eq:essential_conv_2d_3}
    \\
    \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{-}}{t} + \pdiff{q^{-}}{t} & = 0
    \label{eq:essential_conv_2d_4}
\end{align}
\Autoref{eq:essential_conv_2d_4} means that the ingoing wave does not disturb the outgoing wave.
%--------------------------------------------------------------------------------
\paragraph*{Given water level at left/west boundary}

% \todo{Is the following assumption correct: if $\zeta_{\textit{given}} = f(t)$  is then $\lpdiff{q}{t}=0$}

Adding the equations (\eqref{eq:essential_conv_2d_1} $+$ \eqref{eq:essential_conv_2d_2}) yields
\begin{align}
    2 \sqrt{gh} \pdiff{h}{t} & = F(t)
\end{align}
%
So the essential boundary condition for incoming signal (if $\lpdiff{z_b}{t} = 0$) reads
\begin{align}
    {\boxed{
            \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  = 2 \sqrt{gh} \pdiff{\zeta_{\textit{given}}}{t}  + \eps(\zeta_{\textit{given}} - \zeta)
    }}\label{eq:essential_bc_2d_zeta}
\end{align}
a correction term is added, to prevent drifting away of the solution (an integration constant is missing).
The variable $\eps$ has dimension \bunit{\metre\per\square\second}.

The discretization of  boundary \autoref{eq:essential_bc_zeta} at $x=i+\half$ reads (when $\lpdiff{z_b}{t}=0$):
\begin{align}
    &\left(\sqrt{gh^{n+\theta,p+1}} - \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  =
    \nonumber \\*
    & = 2 \sqrt{gh^{n+\theta,p+1}} \pdiff{\zeta_{\textit{given}}}{t}
    + \eps \left( (\zeta_{\textit{given}} -z_b) - h^{n+1,p}   \right)
\end{align}
%--------------------------------------------------------------------------------
\paragraph*{Given water flux at left/west boundary}
Subtracting the equations (\eqref{eq:essential_conv_2d_1} $-$ \eqref{eq:essential_conv_2d_2}), yields:
\begin{align}
    - 2 \frac{q}{h}\pdiff{h}{t}  + 2 \pdiff{q}{t} & =  F(h, q, t)
\end{align}
So the essential boundary condition for incoming signal reads
\begin{align}
    & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    - 2 \frac{q}{h}\pdiff{h}{t}  + 2 \pdiff{q}{t} \label{eq:essential_conv_2d_5}
    %        \\
    %       & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %       - 2 \frac{q}{h} \frac{h}{h\sqrt{gh} + q} \pdiff{q}{t}   + 2 \pdiff{q}{t}
    %       \\
    %       & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %- 2 \frac{q}{h\sqrt{gh} + q} \pdiff{q}{t}   + 2 \pdiff{q}{t}
\end{align}
Using \autoref{eq:essential_conv_2d_2} (ingoing information does not disturb outgoing information)
\begin{align}
    &\left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h^{+}}{t} - \pdiff{q^{+}}{t} = 0
    \Rightarrow
    \pdiff{h^{+}}{t}   =
    \frac{1}{\sqrt{gh} + \frac{q}{h}}\pdiff{q^{+}}{t}\label{eq:essential_conv_2d_6}
    %\frac{h^{+}}{h\sqrt{gh} + q} \pdiff{q^{+}}{t} \label{eq:essential_conv_2d_4}
\end{align}
substituting \autoref{eq:essential_conv_2d_6} into the right hand side of \autoref{eq:essential_conv_2d_5}, yields
\begin{align}
    %        & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %        2 \left( 1 -  \frac{q}{h\sqrt{gh} + q} \right)\pdiff{q}{t}
    %        \\
    %        & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %    2 \left( \frac{h\sqrt{gh} + q}{h\sqrt{gh} + q} -  \frac{q}{h\sqrt{gh} + q} \right)\pdiff{q}{t}
    %        \\
    &{\boxed{
            \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
            2 \left( \frac{\sqrt{gh}}{\sqrt{gh} + \frac{q}{h}} \right)\pdiff{q_{\textit{given}}}{t} + \eps(q_{\textit{given}} - q)
    }}\label{eq:essential_bc_2d_q}
\end{align}
a correction term is added, to prevent drifting away of the solution (an integration constant is missing).
The variable $\eps$ has dimension \bunit{\per\second}.
The discretization of  boundary \autoref{eq:essential_bc_2d_q} at $x=i+\half$ reads
\begin{align}
    &\left(\sqrt{gh^{n+\theta,p+1}} - \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}} \right) \pdiff{h}{t} + \pdiff{q}{t} =
    \nonumber \\*
    & = 2 \left(  \frac{\sqrt{gh^{n+\theta,p+1}}}{\sqrt{gh^{n+\theta,p+1}} + \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}}} \right) \pdiff{q_{\textit{given}}}{t} + \eps \left( q_{\textit{given}} - q^{n+1,p}   \right)
\end{align}



%
%--------------------------------------------------------------------------------
\paragraph*{Given water level at left/west boundary}

% \todo{Is the following assumption correct: if $\zeta_{\textit{given}} = f(t)$  is then $\lpdiff{q}{t}=0$}

Adding the equations (\eqref{eq:essential_conv_1} $+$ \eqref{eq:essential_conv_2}) yields
\begin{align}
    2 \sqrt{gh} \pdiff{h}{t} & = F(t)
\end{align}
%
So the essential boundary condition for incoming signal (if $\lpdiff{z_b}{t} = 0$) reads
\begin{align}
    {\boxed{
            \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  = 2 \sqrt{gh} \pdiff{\zeta_{\textit{given}}}{t}  + \eps(\zeta_{\textit{given}} - \zeta)
    }}\label{eq:essential_bc_zeta}
\end{align}
a correction term is added, to prevent drifting away of the solution (an integration constant is missing).
The variable $\eps$ has dimension \bunit{\metre\per\square\second}.

The discretization of  boundary \autoref{eq:essential_bc_zeta} at $x=i+\half$ reads
\begin{align}
    &\left(\sqrt{gh^{n+\theta,p+1}} - \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  =
    \nonumber \\*
    & = 2 \sqrt{gh^{n+\theta,p+1}} \pdiff{\zeta_{\textit{given}}}{t}
    + \eps \left( (\zeta_{\textit{given}} -z_b) - h^{n+1,p}   \right)
\end{align}

%------------------------------------------------------------------------------
\subsubsection{Natural boundary condition}
The \textbf{natural} boundary condition for the left/west boundary, describing the undisturbed outgoing wave, reads (\autoref{eq:left_right_going_equations}):
\begin{align}
    - \left(\sqrt{gh} + \frac{q}{h}\right) \underbrace{ \left(\pdiff{h}{t} + \pdiff{q}{x} + \ldots \right) }_{\text{continuity eq.}} + \underbrace{\left(\pdiff{q}{t} + g h \pdiff{\zeta}{x}+\ldots\right)}_{\text{momentum eq.}} = 0
\end{align}
where $q$ is normal to this boundary.
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_along_straight_boundary_natural.pdf_tex}
        }
    \end{center}
    \caption{Natural boundary condition ($i=1$), dotted lines indicate the border of the control volumes.
             The diamonds indicate the quadrature points.}
    \label{fig:structured_grid_along_straight_boundary_natural}
\end{figure}
%------------------------------------------------------------------------------
\paragraph*{Time derivative, continuity equation}
At the left/west boundary ($x_{i-\half, j-\quart}$ with $i=1$) the time discretization of the continuity equation for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \left.\int_\Gamma\pdiff{h}{t}\, ds \right|_{i-\half, j-\quart} & \approx  \frac{\half\Dy_{i-\half, j-\half}}{\Dt}   \left(  h^{n+1}_{i-\half, j-\quart} - h^{n}_{i-\half, j-\quart} \right)
\end{align}
with $\Dy_{i-\half, j-\half} = y_{i-\half, j} - y_{i-\half, j-1}$.

A diffusion like term is added to the boundary equation to damp the reflection of spurious waves.
A coefficient $\alpha_{\it bnd}$ is placed before that extra term, the optimal value of this coefficient is taken from the analysis in \citet{transpeq-analysisdiscretizationinsidedomain_boundaries.mw}.
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dt}\left[ \frac{1}{2} \left( h^{n+1,p+1}_{i-1, j-\quart} + h^{n+1,p+1}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2} \left( h^{n+1,p+1}_{i-1, j-\quart} - 2 h^{n+1,p+1}_{i, j-\quart} + h^{n+1,p+1}_{i+1, j-\quart}  \right) \right. +
    \nonumber \\*
    & \qquad  - \left. \left(
    \frac{1}{2} \left( h^{n}_{i-1, j-\quart} + h^{n}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( h^{n}_{i-1, j-\quart} - 2 h^{n}_{i, j-\quart} + h^{n}_{i+1, j-\quart}  \right) \right)
    \right]
\end{align}
After rearranging the equation to the \deltaformulation, the implicit and the explicit part reads:
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dt}  \left( \half \left( \Delta h^{n+1, p+1}_{i-1, j-\quart} + \Delta h^{n+1, p+1}_{i, j-\quart} \right) \right. +
    \nonumber \\*
    & \qquad + \left. \frac{\alpha_{\it bnd}}{2}\left( \Delta h^{n+1,p+1}_{i-1, j-\quart} - 2 \Delta h^{n+1,p+1}_{i, j-\quart} + \Delta h^{n+1,p+1}_{i+1, j-\quart} \right) \right) +
    \nonumber \\
    & \qquad + \frac{\half\Dy_{i-\half, j-\half}}{\Dt} \left\{ \half \left( h^{n+1, p}_{i-1, j-\quart} + h^{n+1, p}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2}\left(  h^{n+1,p}_{i-1, j-\quart} - 2 h^{n+1,p}_{i, j-\quart}  + h^{n+1,p}_{i+1, j-\quart} \right) + \right.
    \nonumber \\*
    &
    \qquad \left. - \left( \frac{1}{2} \left( h^{n}_{i-1, j-\quart} + h^{n}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( h^{n}_{i-1, j-\quart} - 2 h^{n}_{i, j-\quart} + h^{n}_{i+1, j-\quart}  \right) \right) \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Mass flux, continuity equation}
At the left/west boundary ($x_{i-\half, j-\quart}$ with $i=1$) the discretization of the mass flux for the \textbf{natural} boundary condition, describing the outgoing wave (assuming $\lpdiff{r}{y} = 0$), reads:
%\todo{Is assumption that  $\lpdiff{r}{y} = 0$, OK?}
\begin{align}
    \int_\Gamma \pdiff{q}{x}\, ds & \approx \frac{\half\Dy_{i-\half, j-\half}}{\Dx} \left(  q^{n+\theta, p+1}_{i} - q^{n+\theta, p+1}_{i-1} \right)
\end{align}
which will be approximated by
\begin{align}
    &\frac{\half\Dy_{i-\half, j-\half}}{\Dx} \left( \left( q^{n+\theta, p}_{i, j-\quart} + \theta \Delta q^{n+1, p+1}_{i, j-\quart}\right)
    - \left( q^{n+\theta, p+1}_{i-1, j-\quart} + \theta \Delta q^{n+1, p+1}_{i-1, j-\quart}\right) \right)
    \\
    \Leftrightarrow &
    \\
    &\frac{\half\Dy_{i-\half, j-\half}}{\Dx} \theta \left( \Delta q^{n+1, p+1}_{i, j-\quart} - \Delta q^{n+1, p+1}_{i-1, j-\quart}\right) +
    \frac{1}{\Dx} \left\{ q^{n+\theta, p}_{i, j-\quart} - q^{n+\theta, p+1}_{i-1, j-\quart} \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Time derivative, momentum equation}
At the left/west boundary ($x_{i-\half, j-\quart}$ with $i=1$) the time discretization of the momentum equation for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \left. \int_\Gamma\pdiff{q}{t}\, ds \right|_{i-\half, j-\quart} & \approx \frac{\half\Dy_{i-\half, j-\half}}{\Dt} \left(  q^{n+1}_{i-\half, j-\quart} - q^{n}_{i-\half, j-\quart} \right)
\end{align}
A diffusion like term is added to the boundary equation to damp the reflection of spurious waves.
A coefficient $\alpha_{\it bnd}$ is placed before that extra term, the optimal value of this coefficient is taken from the analysis in \citet{transpeq-analysisdiscretizationinsidedomain_boundaries.mw}.
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dt}\left[ \frac{1}{2} \left( q^{n+1,p+1}_{i-1, j-\quart} + q^{n+1,p+1}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2} \left( q^{n+1,p+1}_{i-1, j-\quart} - 2 q^{n+1,p+1}_{i, j-\quart} + q^{n+1,p+1}_{i+1, j-\quart}  \right) \right. +
    \nonumber \\*
    & \qquad  - \left. \left(
    \frac{1}{2} \left( q^{n}_{i-1, j-\quart} + q^{n}_{i, j-\quart} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( q^{n}_{i-1, j-\quart} - 2 q^{n}_{i, j-\quart} + q^{n}_{i+1, j-\quart}  \right) \right)
    \right]
\end{align}
After rearranging the equation to the \deltaformulation, the implicit and the explicit part reads:
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dt}  \left( \half \left( \Delta q^{n+1, p+1}_{i-1, j-\quart} + \Delta q^{n+1, p+1}_{i, j-\quart} \right) \right. +
    \nonumber \\*
    & \qquad + \left. \frac{\alpha_{\it bnd}}{2}\left( \Delta q^{n+1,p+1}_{i-1, j-\quart} - 2 \Delta q^{n+1,p+1}_{i, j-\quart} + \Delta q^{n+1,p+1}_{i+1, j-\quart} \right) \right) +
    \nonumber \\
    & \qquad +  \frac{\half\Dy_{i-\half, j-\half}}{\Dt} \left\{ \half \left( q^{n+1, p}_{i-1, j-\quart} + q^{n+1, p}_{i, j-\quart} \right) + \frac{\alpha_{\it bnd}}{2}\left( q^{n+1,p}_{i-1, j-\quart} - 2 q^{n+1,p}_{i, j-\quart}  + q^{n+1,p}_{i+1, j-\quart} \right) + \right.
    \nonumber \\*
    & \qquad
    \left.  - \frac{1}{2} \left( q^{n}_{i-1, j-\quart} + q^{n}_{i, j-\quart} \right) - \frac{\alpha_{\it bnd}}{2} \left( q^{n}_{i-1, j-\quart} - 2 q^{n}_{i, j-\quart} + q^{n}_{i+1, j-\quart}  \right) \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Pressure term, momentum equation}
At the left/west boundary ($x_{i-\half, j-\quart}$ with $i=1$) the discretization of the pressure term for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \left. \int_\Gamma\left(gh \pdiff{\zeta}{x}\right)\, ds \right|_{i-\half, j-\quart} \approx
    & \half\Dy_{i-\half, j-\half} \ g h^{n+\theta,p+1}_{i-\half, j-\quart} \pdiff{}{x} \left( \zeta^{n+\theta,p+1}_{i-\half, j-\quart}\right)
\end{align}
In a formulation of the shallow-water equations, where the equation for the free-surface level $\zeta$ reduces to $\zeta = h + z_b$ (excluding drying and flooding), the equations can be simplified, because $\Delta \zeta = \Delta h$ (when $z_b$ is not time dependent).
In this case, the contributions to the $\Delta \zeta$-equations need to be incorporated in the $\Delta h$-equations.
The pressure term will then be approximated by
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dx} g h^{n+\theta,p}_{i-\half, j-\quart} \left( \zeta^{n+\theta,p}_{i, j-\quart} - \zeta^{n+\theta,p}_{i-1, j-\quart}  \right) +
    \nonumber \\*
    & \qquad + \frac{\half\Dy_{i-\half, j-\half}}{\Dx}  g \left( \zeta^{n+\theta,p}_{i, j-\quart} - \zeta^{n+\theta,p}_{i-1, j-\quart} \right) \theta \Delta h^{n+1, p+1}_{i-\half, j-\quart} +
    \nonumber \\*
    & \qquad +   \frac{\half\Dy_{i-\half, j-\half}}{\Dx} g h^{n+\theta, p}_{i-\half, j-\quart}
    \theta \left( \Delta \zeta^{n+1,p+1}_{i, j-\quart}  - \Delta \zeta^{n+1,p+1}_{i-1, j-\quart}\right)
\end{align}
After rearranging the equation into an implicit and an explicit part it reads:
\begin{align}
    & \frac{\half\Dy_{i-\half, j-\half}}{\Dx}  g \left( \zeta^{n+\theta,p}_{i, j-\quart} - \zeta^{n+\theta,p}_{i-1, j-\quart} \right) \theta \Delta h^{n+1, p+1}_{i-\half, j-\quart} +
    \\
    & \qquad +
    \frac{\half\Dy_{i-\half, j-\half}}{\Dx} g h^{n+\theta, p}_{i-\half, j-\quart}
    \theta \left( \Delta \zeta^{n+1,p+1}_{i}  - \Delta \zeta^{n+1,p+1}_{i-1, j-\quart}\right) +
    \nonumber \\*
    & \qquad + \left\{
    \frac{\half\Dy_{i-\half, j-\half}}{\Dx} g h^{n+\theta,p}_{i-\half} \left( \zeta^{n+\theta,p}_{i, j-\quart} - \zeta^{n+\theta,p}_{i-1, j-\quart}  \right)  \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Convection, momentum equation}
%The convection term in the interior of the domain reads
%\begin{align}
%    &\nabla \dotp \frac{\vec{q}\vec{q}^T}{h}.
%\end{align}
%Integrated along a line element of the boundary yields
%\begin{align}
%    &\int_\Gamma \left[ \nabla \dotp \frac{\vec{q}\vec{q}^T}{h}\right] \, d\Gamma =
%    \\
%    &
%    \int_\Gamma \left[ \nabla \dotp  \frac{1}{h}\begin{pmatrix} q \\ r \end{pmatrix} \begin{pmatrix} q & r \end{pmatrix}\right] \, d\Gamma =
%    \\
%    &=\int_\Gamma \left[ \nabla \dotp
%    \begin{pmatrix}
%        qq/h & qr/h \\
%        rq/h & rr/h
%    \end{pmatrix}
%    \right] \, d\Gamma
%    =\int_\Gamma
%    \begin{pmatrix}
%        \pdiff{qq/h}{x} + \pdiff{rq/h}{y} \\
%        \pdiff{qr/h}{x} + \pdiff{rr/h}{y}
%    \end{pmatrix}
%    \, d\Gamma
%\end{align}
The finite volume flux through the boundary line element $ds$ yields
\begin{align}
    &\int_\Gamma \left( \nabla \dotp \frac{\vec{q}\vec{q}^T}{h}\right) \, ds =
    \int_\Gamma
    \begin{pmatrix}
        \pdiff{qq/h}{x} + \pdiff{rq/h}{y} \\
        \pdiff{qr/h}{x} + \pdiff{rr/h}{y}
    \end{pmatrix}
    \dotp \vec{n}\, ds
    = \\
    & =
    \left[ \left( \pdiff{qq/h}{x} + \pdiff{rq/h}{y} \right) n_x +
    \left( \pdiff{qr/h}{x} + \pdiff{rr/h}{y} \right) n_y \right] \norm{ds}
\end{align}
with $\vec{n} = (n_x, n_y)^T$ the outward normal vector.

Written in linear terms for the derivative they read:
\begin{align}
    \pdiff{(qq/h)}{x} &= \frac{2q}{h}\pdiff{q}{x} -\frac{q^2}{h^2} \pdiff{h}{x}
    \\*
    \pdiff{(rq/h)}{y} &= \frac{q}{h}\pdiff{r}{y} + \frac{r}{h}\pdiff{q}{y} - \frac{rq}{h^2} \pdiff{h}{y}
    \\*
    \pdiff{(qr/h)}{x} &= \frac{r}{h}\pdiff{q}{x} + \frac{q}{h}\pdiff{r}{x} - \frac{qr}{h^2} \pdiff{h}{x}
    \\*
    \pdiff{(rr/h)}{y} &= \frac{2r}{h}\pdiff{q}{y} -\frac{r^2}{h^2} \pdiff{h}{y}
\end{align}

Consider on a cartesian grid the boundary at the west/left side of the domain, ranging over the interval $\left[ \vec{x}_{i-\half, j-\half}, \vec{x}_{i-\half, j+\half} \right]$.
In case we have normal flow at the boundary ($r=0$) this boundary term reads:
\begin{align}
    \int^{y_{j+\half}}_{y_{j-\half}}\left(
    \pdiff{qq/h}{x}
    \right) \, ds \approx
    \half\Dy_{i-\half, j-\half}\left.\pdiff{qq/h}{x}\right|_{i-\half, j-\quart} + \half \Dy_{i-\half, j+\half}\left.\pdiff{qq/h}{x}\right|_{i-\half, j+\quart}
\end{align}
which will be approximated at the quatrature point $qp$ by
\begin{align}
    & \left. \left( \frac{2q}{h}\pdiff{q}{x} - \frac{q^2}{h^2}\pdiff{h}{x}\right) \right|_{qp}
    \approx
    \\
    & \qquad \approx \underbrace{\frac{2q^{n+\theta, p}_{qp}}{ h^{n+\theta, p}_{qp}} \pdiff{}{x}\left( q^{n+\theta, p}_{qp} \right)
        - \frac{(q^{n+\theta, p}_{qp})^2}{(h^{n+\theta, p}_{qp})^2} \pdiff{}{x} \left( h^{n+\theta, p}_{qp} \right)}_{\textit{ to right hand side}} +
    \nonumber \\
    & \qquad + \underbrace{\left( -\frac{2q^{n+\theta, p}_{qp}}{ (h^{n+\theta, p}_{qp})^2}  \pdiff{}{x} \left( q^{n+\theta,p}_{qp}  \right)
        + \frac{2(q^{n+\theta, p}_{qp})^2}{(h^{n+\theta, p}_{qp})^3} \pdiff{}{x} \left( h^{n+\theta,p} _{qp} \right)
        \right)}_{\cal A} \theta \Delta h^{n+1, p+1}_{qp} +
    \nonumber \\
    & \qquad + \underbrace{\left( \frac{2}{ h^{n+\theta, p}_{qp}} \pdiff{}{x} \left( q^{n+\theta, p}_{qp} \right)
        -  \frac{2q^{n+\theta, p}_{qp}}{(h^{n+\theta, p}_{qp})^2} \pdiff{}{x} \left( h^{n+\theta, p}_{qp} \right)
        \right)}_{\cal B} \theta \Delta q^{n+1, p+1}_{qp} +
    \nonumber \\
    &
    \qquad + \underbrace{\left(- \frac{(q^{n+\theta, p}_{qp})^2}{(h^{n+\theta, p}_{qp})^2} \right)}_{\cal C} \theta \pdiff{}{x} \left( \Delta h^{n+1, p+1}_{qp} \right)
    + \underbrace{\frac{2q^{n+\theta, p}_{qp}}{ h^{n+\theta, p}_{qp}}}_{\cal D} \theta \pdiff{}{x} \left(  \Delta q^{n+1, p+1}_{qp} \right)
\end{align}
where $\cal{A}$, $\cal{B}$, $\cal{C}$ and $\cal{D}$ multiplied by $\theta$ are the coefficients in the matrix of the \deltaformulation.

%------------------------------------------------------------------------------
\paragraph*{Bed shear stress, momentum equation}
The bed shear stress  term at the boundary  reads:
\begin{align}
    \int_\Gamma c_f \left( \frac{\vec{q}\abs{\vec{q}}}{h^2} \right)\, ds.
\end{align}
The components for the two momentum equations read:
\begin{align}
    F_q = \int_\Gamma c_f \left( \frac{q\abs{\vec{q}}}{h^2} \right)\, ds, \qquad \textit{q-momentum eq.}
    \\
    F_r = \int_\Gamma c_f \left( \frac{r\abs{\vec{q}}}{h^2} \right)\, ds, \qquad \textit{r-momentum eq.}
\end{align}
\notyet
%------------------------------------------------------------------------------
\subsection{Discretization at corner}
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.8\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_at_corner_point_essential.pdf_tex}
        }
    \end{center}
    \caption{Coefficients for the mass-matrix in 2-dimensions on a structured grid at a corner. No line integrals are performed in the corner.}
    \label{fig:structured_grid_at_corner}
\end{figure}
%------------------------------------------------------------------------------
\subsubsection{Weakly reflective boundary conditions}
Consider the following weakly reflective boundary conditions.

For inflow:
\begin{align}
    q_{i+\half} + \sqrt{gh_{i+\half}} &= \sqrt{gh^\infty_{i+\half}}, \quad \text{inflow}
    \\
    r_{i+\half} &= 0, \quad \text{inflow}
\end{align}
For outflow:
\begin{align}
    \left.\pdiff{r}{y}\right|_{i+\half} &= 0, \quad \text{outflow}
    \\
    q_{i+\half} - \sqrt{gh_{i+\half}} & = 0, \quad \text{outflow}
\end{align}