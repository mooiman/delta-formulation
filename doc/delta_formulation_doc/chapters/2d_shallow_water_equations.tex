%-------------------------------------------------------------------------------
\chapter{2-D Shallow water equations}
%-------------------------------------------------------------------------------
Consider the non-linear wave equation
\begin{subequations}
    \begin{align}
        \pdiff{h}{t} + \nabla \dotp \vec{q} & = 0,
        \\
        \pdiff{\vec{q}}{t} +  \nabla \dotp \left( \vec{q}\vec{q}^T/h\right) + \half g \nabla h^2 & = -gh\nabla z_b,
    \end{align}
\end{subequations}
or
\begin{subequations}
    \begin{align}
    \pdiff{h}{t} + \nabla \dotp \vec{q} & = 0,
    \\
    \pdiff{\vec{q}}{t} +  \nabla \dotp \left( \vec{q}\vec{q}^T/h\right) + gh \nabla \zeta & = 0,
    \\
    \zeta & = h + z_b,
\end{align}
\end{subequations}
with
\begin{symbollist}
    \item[$\zeta$] Water level  w.r.t.\ reference plane ($\zeta = h + z_b$), \bunit{\metre}.
    \item[$h$] Water depth ($h = \zeta - z_b$), \bunit{\metre}.
    \item[$z_b$] Bed level  w.r.t.\ reference plane, \bunit{\metre}.
    \item[$\vec{q}$] Flow, defined as $\vec{q} = (q, r)^T = (hu, hv)^T$, \bunit{\square\metre\per\second}.
    \item[$\vec{u}$] Velocity vector, defined as $\vec{u} = (u, v)^T$, \bunit{\metre\per\second}.
    \item[$g$] Acceleration due to gravity, \bunit{\metre\per\square\second}.
\end{symbollist}
\subsection*{Finite Volume approach}
Integrating the equations over a finite volume $\Omega$ yields:
\begin{subequations}
    \begin{align}
        \int_\Omega \pdiff{h}{t}\, d\omega
        + \int_\Omega \nabla \dotp \vec{q}\, d\omega & = 0,
        \label{eq:pressure_dependent_on_h_a} \\
        \int_\Omega \pdiff{\vec{q}}{t}\, d\omega
        + \int_\Omega \nabla \dotp \left( \vec{q}\vec{q}^T/h\right)\, d\omega
        + \int_\Omega \half  \nabla \left( g h^2 \right) \, d\omega & =
        - \int_\Omega gh\nabla z_b\, d\omega,
        \label{eq:pressure_dependent_on_h_b}
    \end{align}
    \label{eq:pressure_dependent_on_h}
\end{subequations}
or
\begin{subequations}
\begin{align}
    \int_\Omega \pdiff{h}{t}\, d\omega + \int_\Omega \nabla \dotp \vec{q}\, d\omega & = 0,
    \\
    \int_\Omega \pdiff{\vec{q}}{t}\, d\omega
    + \int_\Omega \nabla \dotp \left( \vec{q}\vec{q}^T/h\right)\, d\omega
    + \int_\Omega gh \nabla \zeta\, d\omega & = 0,
    \\
    \int_\Omega \zeta\, d\omega & = \int_\Omega h\, d\omega + \int_\Omega z_b\, d\omega,
\end{align}
\label{eq:pressure_dependent_on_zeta}
\end{subequations}

%-------------------------------------------------------------------------------
\section{Space discretization, structured}
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_interior_2d.pdf_tex}
        }
    \end{center}
    \caption[Definition of the grid to solve the 2D-shallow water equations in the interior area]{Coefficients for the mass-matrix and the control volume in 2-dimensions in the interior area, on a structured grid. The black dots indicate the location of the quadrature points, and black diamonds the flux points.}
    \label{fig:2d_structured_grid}
\end{figure}
For the space discretizations of an arbitrary function $u$ on the quadrature point of a sub-control volume the following space interpolations are used, $u \in \{h,q,r\}$:
\begin{align}
    \left. u\right|_{i+\quart, j+\quart} & \approx \frac{1}{16}\left( 9u_{i, j} + 3 u_{i+1,j}  + 3  u_{i, j+1} + u_{i+1, j+1}\right)
    \\
    \left. \pdiff{u}{x}\right|_{i+\quart, j+\quart} & \approx \quart \left( 3 u_{i+1,j} - 3 u_{i,j} + u_{i+1, j+1} - u_{i, j+1} \right)
    \\
    \left. \pdiff{u}{y}\right|_{i+\quart, j+\quart} & \approx \quart \left( 3 u_{i, j+1} - 3 u_{i, j} + u_{i+1, j+1} - u_{i+1, j}\right)
\end{align}
See for the locations \autoref{fig:2d_structured_grid}.
%-------------------------------------------------------------------------------
\subsection{Discretizations continuity equation}
The discretization of continuity \autoref{eq:pressure_dependent_on_h_a} will be presented term by term.
%-------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the continuity equation reads:
\begin{align}
    \int_{\Omega} \pdiff{h}{t}\, d\omega
\end{align}
which will be approximated by the sum of the integral over the sub-control volumes.
On a structured grid one control volume ($cv$) around a node consist of four sub-control volumes ($scv_i$, $i\in\{1,2,3,4\}$).
\begin{align}
    \int_{cv} \pdiff{h}{t}\, d\omega =
    \int_{scv_1} \pdiff{h}{t}\, d\omega +
    \int_{scv_2} \pdiff{h}{t}\, d\omega +
    \int_{scv_3} \pdiff{h}{t}\, d\omega +
    \int_{scv_4} \pdiff{h}{t}\, d\omega
\end{align}
For a cartesian grid we get:
\begin{align}
    \int_{cv} \pdiff{h}{t}\, d\omega \approx &
    \quart\Dx\Dy\Dtinv \left( h^{n+1,p+1}_{i-\quart, j-\quart} -  h^{n+1,n}_{i-\quart, j-\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( h^{n+1,p+1}_{i+\quart, j-\quart} -  h^{n+1,n}_{i+\quart, j-\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( h^{n+1,p+1}_{i+\quart, j+\quart} -  h^{n+1,n}_{i+\quart, j+\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( h^{n+1,p+1}_{i-\quart, j+\quart} -  h^{n+1,n}_{i-\quart, j+\quart} \right)
\end{align}
Just looking to $scv_3$ as part of the control volume for node $(i,j)$:
\begin{align}
    &\quart\Dx\Dy\Dtinv \left( h^{n+1,p+1}_{i+\quart, j+\quart} -  h^{n+1,n}_{i+\quart, j+\quart} \right) =
    \\*
    &= \quart\Dx\Dy\Dtinv \left( \frac{1}{16}\left( 9h^{n+1,p+1}_{i, j} + 3 h^{n+1,p+1}_{i+1,j}  + 3  h^{n+1,p+1}_{i, j+1} + h^{n+1,p+1}_{i+1, j+1}\right) \right. +
    \\*
    &\quad - \left. \frac{1}{16}\left( 9 h^{n+1,n}_{i, j} +  3 h^{n+1,n}_{i+1,j}  + 3  h^{n+1,n}_{i, j+1} + h^{n+1,n}_{i+1, j+1}\right)\right)
\end{align}
\notyet
%-------------------------------------------------------------------------------
\subsubsection{Mass flux}
\notyet
%-------------------------------------------------------------------------------
\subsection{Discretizations momentum equations}
The discretization of momentum \autoref{eq:pressure_dependent_on_h_b} will be presented term by term.
%--------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the momentum equation is only shown for the q-momentum equation, the time derivative for the r-momentum equation is similar. The time derivation for hte q-momentum equation reads:
\begin{align}
    \int_{\Omega} \pdiff{q}{t}\, d\omega
\end{align}
which will be approximated by the sum of the integral over the sub-control volumes.
On a structured grid one control volume ($cv$) around a node consist of four sub-control volumes ($scv_i$, $i\in\{1,2,3,4\}$).
\begin{align}
    \int_{cv} \pdiff{q}{t}\, d\omega =
    \int_{scv_1} \pdiff{q}{t}\, d\omega +
    \int_{scv_2} \pdiff{q}{t}\, d\omega +
    \int_{scv_3} \pdiff{q}{t}\, d\omega +
    \int_{scv_4} \pdiff{q}{t}\, d\omega
\end{align}
For a cartesian grid we get:
\begin{align}
    \int_{cv} \pdiff{q}{t}\, d\omega \approx &
    \quart\Dx\Dy\Dtinv \left( q^{n+1,p+1}_{i-\quart, j-\quart} -  q^{n+1,n}_{i-\quart, j-\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( q^{n+1,p+1}_{i+\quart, j-\quart} -  q^{n+1,n}_{i+\quart, j-\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( q^{n+1,p+1}_{i+\quart, j+\quart} -  q^{n+1,n}_{i+\quart, j+\quart} \right) +
    \nonumber \\*
    &\quart\Dx\Dy\Dtinv \left( q^{n+1,p+1}_{i-\quart, j+\quart} -  q^{n+1,n}_{i-\quart, j+\quart} \right)
\end{align}
Just looking to $scv_3$ as part of the control volume for node $(i,j)$:
\begin{align}
    &\quart\Dx\Dy\Dtinv \left( q^{n+1,p+1}_{i+\quart, j+\quart} -  q^{n+1,n}_{i+\quart, j+\quart} \right) =
    \\*
    &= \quart\Dx\Dy\Dtinv \left( \frac{1}{16}\left( 9 q^{n+1,p+1}_{i, j} + 3 q^{n+1,p+1}_{i+1,j}  + 3 q^{n+1,p+1}_{i, j+1} + q^{n+1,p+1}_{i+1, j+1}\right) \right. +
    \\*
    &\quad - \left. \frac{1}{16}\left( 9 q^{n+1,n}_{i, j} +  3 q^{n+1,n}_{i+1,j}  + 3  q^{n+1,n}_{i, j+1} + q^{n+1,n}_{i+1, j+1}\right)\right)
\end{align}
\notyet
%--------------------------------------------------------------------------------
\subsubsection{Pressure term} \label{sec:linearized_pressure_zeta}
In this section we use that the pressure term is dependent on $\zeta$.
\begin{align}
    \int_{\Omega_i} gh \nabla \zeta \, d\omega
\end{align}
The integral over a control volume will be a sum of integrals over the sub control volumes.
On a structured mesh it will be the sum over 4 sub control volumes.

Considering one control volume and only the $x$-direction (assuming a cartesian grid) it reads:
\begin{align}
    & \int_{\Omega_{\textit{scv}}} gh \nabla \zeta \, d\omega  \approx
    \\
    & \approx \quart \Dx\Dy\, g h^{n+\theta,p+1}_{qp} \pdiff{\zeta^{n+\theta,p+1}_{qp}}{x}
    \\
   & \approx \quart  \Dx\Dy\, g \left( h^{n+1,p}_{qp} + \theta \Delta h^{n+1,p+1}\right)  \pdiff{}{x}\left(\zeta^{n+1,p}_{qp} + \theta \Delta \zeta^{n+1,p+1}_{qp}\right)
\end{align}
with $qp$ the location of the quadrature point in the sub-control volume.
Assume that the higher order terms are negligible then the discretization for each of the 4 sub-control volumes reads:
\begin{align}
        \quart  \Dx\Dy\, g \left(
        h^{n+1,p}_{qp} \pdiff{\zeta^{n+1, p}_{qp}}{x}
        + \theta h^{n+1, p}_{qp} \pdiff{\Delta \zeta^{n+1, p+1}_{qp}}{x}
        + \theta \pdiff{\zeta^{n+1, p}_{qp}}{x} \Delta h^{n+1,p+1}_{qp}
          \right)
\end{align}

%--------------------------------------------------------------------------------
\subsubsection{Convection}
\notyet

%--------------------------------------------------------------------------------
\subsubsection{Bed shear stress}
\notyet

%--------------------------------------------------------------------------------
\subsubsection{Pressure term, dependent on $h$}
In this section we use that the pressure term is dependent on $h$.
\begin{align}
    \int_{\Omega_i} \half  \nabla \left( g h^2\right) \, d\omega & =
    \int_{\partial\Omega_i} \half  g h^2 \vec{\hat n}\, dl \label{eq:2d_press_term}
\end{align}
The linearization of the pressure term in the momentum equation around iteration level $p$ read:
\begin{align}
    \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2  & =
    \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2
    + g h^{n+\theta,p+1}_{\partial\Omega_i} \left({h}^{n+\theta,p+1} - {h}^{n+\theta,p}\right) =
    \\
    & = \half g \left(h^{n+\theta,p+1}_{\partial\Omega_i}\right)^2 + \theta  g h^{n+\theta,p+1}_{\partial\Omega_j} \Delta {h}^{n+1,p+1}
\end{align}

The component in $x$-direction read:
\begin{align}
    \int_{\partial\Omega_i} & \half  g h^2 \vec{\hat n} \dotp \vec{i_x}\, dl \approx
    \nonumber \\
    \approx  & \Dy \left( \half g \left(h^{n+\theta,p}_{i+\half,j}\right)^2 + \theta  g h^{n+\theta,p+1}_{i+\half,j} \Delta {h}^{n+1,p+1}_{i+\half,j}  \right) +
    \nonumber \\
    - & \Dy \left( \half g \left(h^{n+\theta,p}_{i-\half,j}\right)^2 + \theta  g h^{n+\theta,p+1}_{i-\half,j} \Delta {h}^{n+1,p+1}_{i-\half,j}  \right)
\end{align}
The component in $y$-direction read:
\begin{align}
    \int_{\partial\Omega_i} & \half  g h^2 \vec{\hat n} \dotp \vec{i_y}\, dl \approx
    \nonumber \\
    \approx  & \Dx \left( \half g \left(h^{n+\theta,p}_{i,j+\half}\right)^2 + \theta  g h^{n+\theta,p+1}_{i,j+\half} \Delta {h}^{n+1,p+1}_{i,j+\half}  \right) +
    \nonumber \\
    - & \Dx \left( \half g \left(h^{n+\theta,p}_{i,j-\half}\right)^2 + \theta  g h^{n+\theta,p+1}_{i,j-\half} \Delta {h}^{n+1,p+1}_{i,j-\half}  \right)
\end{align}
%%-------------------------------------------------------------------------------
%\section{Space discretization, unstructured}
%\notyet
%------------------------------------------------------------------------------
\subsection{Discretization at boundary}
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.80\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_along_straight_boundary_essential.pdf_tex}
        }
    \end{center}
    \caption[Definition of the grid to solve the 2D-shallow water equations at the boundary]{Coefficients of the mass-matrix in 2-dimensions on a structured grid along a straight boundary. The essential boundary condition is located at the cyan-colored line and the natural boundary condition at the orange line.}
    \label{fig:structured_grid_along_straight_boundary}
\end{figure}
For the 2D non-linear wave equations (\autoref{eq:pressure_dependent_on_zeta}) at each boundary boundary conditions need to be prescribed, the number of boundary conditions depends on the flow direction on the boundary.
Considering a hyperbolic system, if the flow is flowing into the domain two boundary conditions need to prescribed and when the flow is flowing out the domain just one boundary need to prescribed.
This is according the characteristic theory of 2D hyperbolic systems \citep{DaubertEtGraffe1967}.
The ingoing information is called the \textbf{essential} boundary condition (Dirichlet or Neumann condition).
And a boundary condition to handle the outgoing wave is called the \textbf{natural} boundary condition.
%------------------------------------------------------------------------------
\subsection{Discretization at corner}
\begin{figure}[H]
    \begin{center}
        \def\svgwidth{0.8\textwidth} % scaling text
        \resizebox{0.65\textwidth}{!}{
            \input{figures/cartesian_grid_at_corner_point_essential.pdf_tex}
        }
    \end{center}
    \caption{Coefficients for the mass-matrix in 2-dimensions on a structured grid at a corner. No line integrals are performed in the corner.}
    \label{fig:structured_grid_at_corner}
\end{figure}
%------------------------------------------------------------------------------
\subsubsection{Weakly reflective boundary conditions}
Consider the following weakly reflective boundary conditions:
\begin{align}
    q_{i+\half} + \sqrt{gh_{i+\half}} &= \sqrt{gh^\infty_{i+\half}}, \quad \text{inflow}
    \\
    r_{i+\half} &= 0, \quad \text{inflow}
\end{align}
\begin{align}
    \left.\pdiff{r}{y}\right|_{i+\half} &= 0, \quad \text{outflow}
    \\
    q_{i+\half} - \sqrt{gh_{i+\half}} & = 0, \quad \text{outflow}
\end{align}