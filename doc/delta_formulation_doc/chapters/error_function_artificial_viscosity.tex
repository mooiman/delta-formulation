%--------------------------------------------------------------------------------
\chapter{Error function needed to regularize the artificial viscosity} \label{sec:error_artificial_viscosity}
Regularization of the artificial viscosity $\Psi$ is described in \autoref{sec:regularization_artificial_viscosity}.
\begin{align}
    &\int_{\Omega_{\xi\eta}} \Psi\, d\omega - \alpha_{\psi} \int_{\Omega_{\xi\eta}} \nabla \dotp \nabla \Psi\, d\xi d\eta = \int_{\Omega_{\xi\eta}} \beta_{\psi} \mathit{Err}_{\psi}\, d\omega
    \label{eq:reg_artificial_viscosity}
    \\*
    &\int_{\Omega_{\xi\eta}} \Psi\, d\omega
    - \alpha_{\psi} \oint_{\partial\Omega_{\xi\eta}} \nabla \Psi\, dl
    = \int_{\Omega_{\xi\eta}} \beta_{\psi} \mathit{Err}_{\psi}\, d\omega
\end{align}
when $\Dxi = \Deta = 1$.

In this chapter the error function is derived for the 1-dimension (\autoref{sec:err_1dimensional}) and 2-dimension case (\autoref{sec:err_2dimensional}).
The 2D-dimensional case is derived for curvilinear coordinates.

The mentioned error-function $Err_{\psi}$ is derived in \autoref{sec:err_psi_2d} and is based on \citet[eq.\ 42]{Borsboom2001}.


%--------------------------------------------------------------------------------
\section{One dimensional shallow water equations}\label{sec:err_1dimensional}

We start from the continuity and momentum equation for non-linear waves (i.e. \autoref{eq:continuity_equation} and \eqref{eq:momentum_equation} and combine these two equations to one equation representing the energy.

The continuity and momentum equation read:
\begin{align}
    \pdiff{h}{t}  + \pdiff{q}{x} & = 0 \qquad \textit{continuity eq.}
    \\
    \pdiff{q}{t}  + \pdiff{}{x} \left( \frac{q^2}{h} \right) + g h \pdiff{h}{x} & = 0 \qquad \textit{momentum eq.}
\end{align}
a suitable combination of these two equations yields the energy equation.
The suitable combination is:
\begin{align}
    \left( \half \frac{q^2}{h^2} + g \zeta\right)\left(\textit{continuity eq.}\right)
    +
    \frac{q}{h} \left( \textit{momentum eq.} \right)= 0
\end{align}
and the energy equation reads (\label{sec:obtaining_1denergy_equation}):
\begin{align}
    \pdiff{}{t}\left( h \left(\half \frac{q^2}{h^2} + g \zeta - \half g h \right) \right) +
    \pdiff{}{x}\left( q \left( \half \frac{q^2}{h^2} + g\zeta  \right) \right)= 0
\end{align}
For a steady state solution ($\lpdiff{}{t} = 0$ and $q=\textit{Constant}$), when have:
\begin{align}
    &\pdiff{}{x}\left( \frac{1}{2} \frac{q^2}{h^2} + g\zeta  \right) = 0
% \frac{q}{h^2} \pdiff{q}{x} - \frac{q^2}{h^3}  \pdiff{h}{x} + g\pdiff{\zeta}{x} = 0
\end{align}

%--------------------------------------------------------------------------------
\subsection{1D Error function $\mathit{Err}_\psi$} \label{sec:err_psi_2d}

We assume that the artificial viscosity $\Psi$ is proportional to the numerical error of the gradient term of the energy equation.

To reach suitable velocities the square root is taken from the potential and kinetic energy.
\begin{align}
    \mathit{Err}_{\psi} = Err \left( \sqrt{g \hbar} \right) + Err \left( \sqrt{\half \frac{q^2}{h^2} } \right)
\end{align}
%
%--------------------------------------------------------------------------------
\paragraph*{Based on potential energy}
Looking to square root of the potential energy
\begin{align}
    {\mathit Err}\left(\sqrt{g\hhat}\right) & = \sqrt{g\hhat} - \sqrt{g\hbar} \approx
    \\
    & \approx \sqrt{g\left(\hbar + \frac{1}{8}\Dx^2\pdiff[2]{\hbar}{x}\right)} - \sqrt{g\hbar} =
    \\
    & = \sqrt{g\hbar\left(1 + \frac{1}{8\hbar}\Dx^2\pdiff[2]{\hbar}{x}\right)} - \sqrt{g\hbar} \approx
    \\
    &\approx \sqrt{g\hbar}\left(1 + \frac{1}{16\hbar}\Dx^2 \pdiff[2]{\hbar}{x}\right) - \sqrt{g\hbar} =
    \\
    & = \frac{1}{16} \Dx^2 \sqrt{\frac{g}{\hbar}}\pdiff[2]{\hbar}{x}
\end{align}
Because $\lpdiff[2]{z_b}{x}$ is negligible, due to the regularization of the bedlevel, we get:
\begin{align}
    {\mathit Err}\left(\sqrt{g\hhat}\right)  & = \frac{1}{16} \Dx^2 \sqrt{\frac{g}{\hbar}}\ \pdiff[2]{\zeta}{x}
    \\
    & \Rightarrow \frac{1}{16} \Dxi^2 \sqrt{\frac{g}{\hbar}}\pdiff[2]{\zeta}{\xi}, \quad \bunit{\metre\per\second}.
\end{align}
\phantom{text}
%
%--------------------------------------------------------------------------------
\paragraph*{Based on kinetic energy }
Looking to square root of the kinetic energy: $\sqrt{u^2/2} = \half\sqrt{2} \abs{u} = \half\sqrt{2} \abs{q/h}$:
\begin{align}
    {\mathit Err}\left( \half\sqrt{2}\frac{\qhat}{\hhat} \right) & =  \half\sqrt{2}\left(\frac{\qhat}{\hhat} - \frac{\qbar}{\hbar} \right) \approx
    \half\sqrt{2} \left( \frac{\qbar + \frac{1}{8}\Dx^2\pdiff[2]{\qbar}{x}}{\hbar + \frac{1}{8}\Dx^2\pdiff[2]{\hbar}{x}} - \frac{\qbar}{\hbar} \right) =
    \\
    & = \half\sqrt{2} \left( \frac{\qbar}{\hbar}\frac{1 + \frac{1}{8}\Dx^2\frac{1}{\qbar}\pdiff[2]{\qbar}{x}}{1+\frac{1}{8}\Dx^2\frac{1}{\hbar}\pdiff[2]{\hbar}{x}} - \frac{\qbar}{\hbar} \right) \approx
    \\
    & \approx \half\sqrt{2} \left( \frac{\qbar}{\hbar}
    \left( 1 + \frac{1}{8}\Dx^2\frac{1}{\qbar}\pdiff[2]{\qbar}{x} \right)
    \left( 1 - \frac{1}{8}\Dx^2\frac{1}{\hbar}\pdiff[2]{\hbar}{x} \right) - \frac{\qbar}{\hbar} \right) \approx
    \\
    & \approx
    \half\sqrt{2} \left( \frac{1}{8}\Dx^2\frac{1}{\hbar}\pdiff[2]{\qbar}{x}  -
    \frac{1}{8}\Dx^2\frac{\qbar}{\hbar^2}\pdiff[2]{\hbar}{x} \right)
    \\
    & \Rightarrow \frac{1}{16}\sqrt{2} \Dxi^2 \left( \frac{1}{\hbar} \pdiff[2]{\qbar}{\xi} -
    \frac{\qbar}{\hbar^2}\pdiff[2]{\hbar}{\xi} \right), \quad \bunit{\metre\per\second}.
\end{align}
The error function $\mathit{Err}_{\psi}$ for artificial viscosity as used in \autoref{eq:reg_artificial_viscosity}  for the one dimensional shallow water equations reads (comparable with \citet[eq.\ 42]{Borsboom2001}, differs by a factor of $1/8$):
\begin{align}
    \mathit{Err}_{\psi} = \Dxi \overline{x}_\xi  \left( \frac{1}{16} \sqrt{\frac{g}{\hbar}}\abs{D_\xi(\overline\zeta)} +
    \frac{\sqrt{2}}{16} \abs{\frac{1}{\hbar} D_\xi(\qbar) -
        \frac{\qbar}{\hbar^2}D_\xi(\hbar)} \right), \quad \bunit{\square\metre\per\second}
\end{align}
with $D_\xi$ defined as \citep[eq. 35]{Borsboom2001}:
\begin{align}
    D_\xi = \Dxi^2 \pdiff[2]{u}{\xi} \approx u_{i-1} - 2u_{i} + u_{i+1}, \quad u \in \{q, h, \zeta\}
\end{align}

%--------------------------------------------------------------------------------
\section{Two dimensional shallow water equations}\label{sec:err_2dimensional}
We start from the continuity and momentum equation for non-linear shallow water equations (i.e.\ \autoref{eq:continuity_equation_app}, \eqref{eq:q_momentum_equation_app} and \eqref{eq:r_momentum_equation_app}) and combine these three equations to one equation representing the energy.

The continuity and momentum equation read:
\begin{align}
    \pdiff{h}{t}  + \pdiff{q}{x} + \pdiff{r}{y} & = 0 \qquad \textit{continuity eq.} \label{eq:continuity_equation_app}
    \\
    \pdiff{q}{t}  + \pdiff{}{x} \left( \frac{q^2}{h} \right) + \pdiff{}{y} \left( \frac{qr}{h} \right) + g h \pdiff{\zeta}{x} & = 0 \qquad \textit{$q$-momentum eq.}
    \label{eq:q_momentum_equation_app}
    \\
    \pdiff{r}{t}  + \pdiff{}{x} \left( \frac{rq}{h} \right) + \pdiff{}{y} \left( \frac{r^2}{h} \right) + g h \pdiff{\zeta}{y} & = 0 \qquad \textit{$r$-momentum eq.}
    \label{eq:r_momentum_equation_app}
\end{align}
a suitable combination of these three equations yields the energy equation.
The suitable combination is:
\begin{align}
    &\left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g \zeta  \right) \left(\textit{continuity eq.}\right)
    +
    \nonumber \\*
    &\qquad
    + \frac{q}{h} \left( \textit{$q$-momentum eq.} \right)
    + \frac{r}{h} \left( \textit{$r$-momentum eq.} \right)
    = 0
    \label{eq:obtaining_2denergy_equation}
\end{align}
the energy equation reads (see \autoref{sec:obtaining_2denergy_equation}):
\begin{align}
    &  \half \pdiff{}{t} \left[ h \left( \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g\zeta -\half gh \right)
    \right] +
    \\*
    &
    + \pdiff{}{x} \left[
    q \left( \half \left( \frac{q^2}{h^2}  + \frac{r^2}{h^2}  \right)
    + g \zeta \right)
    \right]
    + \pdiff{}{y} \left[
    r \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)
    + g \zeta \right)
    \right] = 0
\end{align}
When a steady state solution is assumed ($\lpdiff{}{t}=0$, $q = r = \textit{Constant}$) it yields:
\begin{align}
    \nabla \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g \zeta \right) = 0
\end{align}
%--------------------------------------------------------------------------------
\subsection{2D Error function $\mathit{Err}_\psi$} \label{sec:err_psi_2d}
We assume that the artificial viscosity $\Psi$ is proportional to the numerical error of the gradient term of the energy equation.

To reach suitable velocities the square root is taken from the potential and kinetic energy.
\begin{align}
    \mathit{Err}_{\psi} =
    \mathit{Err} \left( \sqrt{g \hbar} \right)
    + \mathit{Err} \left( \sqrt{ \half \frac{q^2}{h^2} } \right)
    + \mathit{Err} \left( \sqrt{ \half \frac{r^2}{h^2} } \right)
\end{align}
%--------------------------------------------------------------------------------
\paragraph*{Based on potential energy}
Looking to square root of the potential energy
\begin{align}
    {\mathit Err} & \left( \sqrt{g \widehat{h}} \right) = \sqrt{g \widehat{h}}
    - \sqrt{g \overline{h}}
    \\*
    & \approx \sqrt{g
        \left(\hbar +
        \half
        \left( \frac{\Dx}{2} \right)^2 \pdiff[2]{\hbar}{x}
        + \frac{\Dx}{2} \frac{\Dy}{2}  \frac{\partial\kern 0.083333em^2 \hbar}{\partial x \partial y}
        + \half \left( \frac{\Dy}{2} \right)^2 \pdiff[2]{\hbar}{y}
        \right)
    }
    - \sqrt{g\hbar} =
    \\
    & = \sqrt{g\hbar\left(1 + \frac{1}{8\hbar}\Dx^2\pdiff[2]{\hbar}{x} +
        \frac{1}{4\hbar}\Dx\Dy\frac{\partial\kern 0.083333em^2 \hbar}{\partial x \partial y} +
        \frac{1}{8\hbar}\Dy^2\pdiff[2]{\hbar}{y}\right)}
    - \sqrt{g\hbar} \approx
    \\
    &\approx \sqrt{g\hbar}\left(1 + \frac{1}{16\hbar}\Dx^2\pdiff[2]{\hbar}{x} +
    \frac{1}{8\hbar}\Dx\Dy\frac{\partial\kern 0.083333em^2 \hbar}{\partial x \partial y} +
    \frac{1}{16\hbar}\Dy^2\pdiff[2]{\hbar}{y}\right)
    - \sqrt{g\hbar} =
    \\
    & = \sqrt{\frac{g}{\hbar}}\left( \frac{1}{16}\Dx^2\pdiff[2]{\hbar}{x} +
    \frac{1}{8}\Dx\Dy\frac{\partial\kern 0.083333em^2 \hbar}{\partial x \partial y} +
    \frac{1}{16}\Dy^2\pdiff[2]{\hbar}{y} \right)
\end{align}
The second derivatives written in curvilinear coordinates read:
\begin{align}
    F_1(\cdot) & = \Dx^2\pdiff[2]{\cdot}{x} =
    \\*
    & =
    \Dxi^2 x_\xi^2\Bigg(\xi_x^2 \pdiff[2]{\cdot}{\xi}
    + 2 \xi_x \eta_x \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}\,
    + \eta_x^2 \pdiff[2]{\cdot}{\eta}
    + \xi_{xx} \pdiff{\cdot}{\xi}
    + \eta_{xx} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdx2}
\end{align}
\begin{align}
    F_2(\cdot) & = \Dx\Dy\frac{\partial\kern 0.083333em^2 \cdot}{\partial x \partial y} =
    \\*
    & =
    \Dxi\Deta\, x_\xi y_\eta \Bigg(\xi_x \xi_y \pdiff[2]{\cdot}{\xi}
    + (\xi_x \eta_y + \eta_x \xi_y) \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}
    + \eta_x \eta_y \pdiff[2]{\cdot}{\eta}
    + \xi_{xy} \pdiff{\cdot}{\xi}
    + \eta_{xy} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdxdy}
\end{align}
\begin{align}
    F_3(\cdot) & = \Dy^2\pdiff[2]{\cdot}{y} =
    \\*
    & =
    \Deta^2 y_\eta^2 \Bigg(\xi_y^2   \pdiff[2]{\cdot}{\xi}
    + 2 \xi_y \eta_y \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}
    + \eta_y^2 \pdiff[2]{\cdot}{\eta}
    + \xi_{yy} \pdiff{\cdot}{\xi}
    + \eta_{yy} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdy2}
\end{align}

Because $\lpdiff[2]{z_b}{x}$ is negligible, due to the regularization of the bedlevel, and written in curvilinear coordinates we get:
%
\begin{align}
    {\mathit Err}&\left(\sqrt{g\hhat}\right)  = \sqrt{\frac{g}{\hbar}} \left(  \frac{1}{16} F_1(\hbar) +  \frac{1}{8} F_2(\hbar) + \frac{1}{16} F_3(\hbar) \right)
\end{align}

%--------------------------------------------------------------------------------
\paragraph*{Based on kinetic energy}
Looking to both square roots of the kinetic energy :
\begin{align}
 &{\mathit Err} \left( \sqrt{\half \frac{\widehat{q}^2}{\widehat{h}^2}} \right)
    +
    {\mathit Err}\left( \sqrt{\half \frac{\widehat{r}^2}{\widehat{h}^2}} \right)
\end{align}
%
First looking to the dependencies on $\qhat/\hhat$, for $\rhat/\hhat$ it is similar:
\begin{align}
    {\mathit Err}& \left( \sqrt{\half \frac{\widehat{q}^2}{\widehat{h}^2}} \right) =
    \half \sqrt{2} \left( \frac{\widehat{q}}{\widehat{h}}
    - \frac{\overline{q}}{\overline{h}} \right)
    \approx
    \\*
    & \approx
    \half\sqrt{2} \left(
    \frac{\qbar + \half\left(\frac{\Dx}{2}\right)^2\pdiff[2]{\qbar}{x}
        +  \frac{\Dx}{2} \frac{\Dy}{2} \frac{\partial\kern 0.083333em ^2 \qbar}{\partial x \partial y}
        + \half\left(\frac{\Dy}{2}\right)^2\pdiff[2]{\qbar}{y}}
    {\hbar + \half\left(\frac{\Dx}{2}\right)^2\pdiff[2]{\hbar}{x}
        +  \frac{\Dx}{2} \frac{\Dy}{2}
        \frac{\partial\kern 0.083333em ^2 \hbar}{\partial x \partial y}
        + \half\left(\frac{\Dy}{2}\right)^2\pdiff[2]{\hbar}{y}}
    - \frac{\qbar}{\hbar} \right) =
    \\*
    &
    =
    \half\sqrt{2} \left(
    \frac{\qbar}{\hbar}
    \frac{1 + \frac{1}{8\qbar}\Dx^2\pdiff[2]{\qbar}{x}
        +  \frac{1}{4\qbar} \Dx\Dy
        \frac{\partial\kern 0.083333em ^2 \qbar}{\partial x \partial y}
        + \frac{1}{8\qbar}\Dy^2\pdiff[2]{\qbar}{y}}
    {1 + \frac{1}{8\hbar}\Dx^2\pdiff[2]{\hbar}{x}
        +  \frac{1}{4\hbar}\Dx\Dy
        \frac{\partial\kern 0.083333em ^2 \hbar}{\partial x \partial y}
        + \frac{1}{8\hbar}\Dy^2\pdiff[2]{\hbar}{y}}
    - \frac{\qbar}{\hbar} \right) \approx
    \\*
    &
    \approx \half\sqrt{2} \Bigg[ \frac{\qbar}{\hbar}
    \left(1 + \frac{1}{8\qbar}\Dx^2\pdiff[2]{\qbar}{x}
    +  \frac{1}{4\qbar} \Dx\Dy
    \frac{\partial\kern 0.083333em ^2 \qbar}{\partial x \partial y}
    + \frac{1}{8\qbar}\Dy^2\pdiff[2]{\qbar}{y}\right) \times
    \\*
    & \qquad \times
    \left(1 - \frac{1}{8\hbar}\Dx^2\pdiff[2]{\hbar}{x}
    -  \frac{1}{4\hbar}\Dx\Dy
    \frac{\partial\kern 0.083333em ^2 \hbar}{\partial x \partial y}
    - \frac{1}{8\hbar}\Dy^2\pdiff[2]{\hbar}{y} \right)
    - \frac{\qbar}{\hbar} \Bigg]+
    \\*
    &\approx \half\sqrt{2} \Bigg[
    \left(\frac{1}{8\qbar}\Dx^2\pdiff[2]{\qbar}{x}
    +  \frac{1}{4\qbar} \Dx\Dy
    \frac{\partial\kern 0.083333em ^2 \qbar}{\partial x \partial y}
    + \frac{1}{8\qbar}\Dy^2\pdiff[2]{\qbar}{y}\right) \times
    \\*
    & \qquad \times
    \left( \frac{1}{8\hbar}\Dx^2\pdiff[2]{\hbar}{x}
    -  \frac{1}{4\hbar}\Dx\Dy
    \frac{\partial\kern 0.083333em ^2 \hbar}{\partial x \partial y}
    - \frac{1}{8\hbar}\Dy^2\pdiff[2]{\hbar}{y} \right) \Bigg]+
\end{align}
Because $\lpdiff[2]{z_b}{x}$ is negligible, due to the regularization of the bedlevel, and using \autoref{eq:d2hdx2}, \eqref{eq:d2hdxdy} and \eqref{eq:d2hdy2} which are  written in curvilinear coordinates, we get:
%
\begin{align}
    {\mathit Err}&\left( \sqrt{\half \frac{\widehat{q}^2}{\widehat{h}^2}} \right) =
    \half \sqrt{2} \left( \frac{\widehat{q}}{\widehat{h}}
    - \frac{\overline{q}}{\overline{h}} \right) \approx
    \\*
    &\approx \half\sqrt{2}\Bigg(
    \frac{1}{8\qbar} F_1(\qbar) + \frac{1}{4\qbar} F_2(\qbar) + \frac{1}{8\qbar} F_3(\qbar)
    \Bigg)
    \Bigg(
    \frac{1}{8\hbar} F_1(\hbar) - \frac{1}{4\hbar} F_2(\hbar) - \frac{1}{8\hbar} F_3(\hbar)
    \Bigg)
\end{align}
Similar for
\begin{align}
    {\mathit Err}&\left( \sqrt{\half \frac{\widehat{r}^2}{\widehat{h}^2}} \right) =
    \half \sqrt{2} \left( \frac{\widehat{r}}{\widehat{h}}
    - \frac{\overline{r}}{\overline{h}} \right) \approx
    \\*
    &\approx \half\sqrt{2}\Bigg(
    \frac{1}{8\rbar} F_1(\rbar) + \frac{1}{4\rbar} F_2(\rbar) + \frac{1}{8\rbar} F_3(\rbar)
    \Bigg)
    \Bigg(
    \frac{1}{8\hbar} F_1(\hbar) - \frac{1}{4\hbar} F_2(\hbar) - \frac{1}{8\hbar} F_3(\hbar)
    \Bigg)
\end{align}
The error function $\mathit{Err}_{\psi}$ for artificial viscosity as used in \autoref{eq:reg_artificial_viscosity}    for the two dimensional shallow water equations read:
\begin{align}
\mathit{Err}_{\psi}& =
%
% based on potential energy
%
\sqrt{\frac{g}{\hbar}} \left(  \frac{1}{16} F_1(\hbar) +  \frac{1}{8} F_2(\hbar) + \frac{1}{16} F_3(\hbar) \right)
\\*
%
% based ont kinetic energyy q-equation
%
& + \half\sqrt{2}\Bigg(
\frac{1}{8\qbar} F_1(\qbar) + \frac{1}{4\qbar} F_2(\qbar) + \frac{1}{8\qbar} F_3(\qbar)
\Bigg)
\Bigg(
\frac{1}{8\hbar} F_1(\hbar) - \frac{1}{4\hbar} F_2(\hbar) - \frac{1}{8\hbar} F_3(\hbar)
\Bigg)
\\*
%
% based ont kinetic energyy r-equation
%
& + \half\sqrt{2}\Bigg(
\frac{1}{8\rbar} F_1(\rbar) + \frac{1}{4\rbar} F_2(\rbar) + \frac{1}{8\rbar} F_3(\rbar)
\Bigg)
\Bigg(
\frac{1}{8\hbar} F_1(\hbar) - \frac{1}{4\hbar} F_2(\hbar) - \frac{1}{8\hbar} F_3(\hbar)
\Bigg)
\end{align}
with functions $F_1$, $F_2$ and $F_3$ defined as:
\begin{align}
    F_1(\cdot) & =
    \Dxi^2 x_\xi^2\Bigg(\xi_x^2 \pdiff[2]{\cdot}{\xi}
    + 2 \xi_x \eta_x \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}\,
    + \eta_x^2 \pdiff[2]{\cdot}{\eta}
    + \xi_{xx} \pdiff{\cdot}{\xi}
    + \eta_{xx} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdx2}
\end{align}
\begin{align}
    F_2(\cdot) & =
    \Dxi\Deta\, x_\xi y_\eta \Bigg(\xi_x \xi_y \pdiff[2]{\cdot}{\xi}
    + (\xi_x \eta_y + \eta_x \xi_y) \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}
    + \eta_x \eta_y \pdiff[2]{\cdot}{\eta}
    + \xi_{xy} \pdiff{\cdot}{\xi}
    + \eta_{xy} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdxdy}
\end{align}
\begin{align}
    F_3(\cdot) & =
    \Deta^2 y_\eta^2 \Bigg(\xi_y^2   \pdiff[2]{\cdot}{\xi}
    + 2 \xi_y \eta_y \frac{\partial\kern 0.083333em^2 \cdot}{\partial \xi \partial \eta}
    + \eta_y^2 \pdiff[2]{\cdot}{\eta}
    + \xi_{yy} \pdiff{\cdot}{\xi}
    + \eta_{yy} \pdiff{\cdot}{\eta}
    \Bigg)
    \label{eq:d2hdy2}
\end{align}
%--------------------------------------------------------------------------------
\subsection{Obtaining the 2D-energy equation}\label{sec:obtaining_2denergy_equation}
Applying the multiplications as given by \autoref{eq:obtaining_2denergy_equation} yields
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    &+ \frac{q}{h} \left(
    \pdiff{q}{t}
    + \pdiff{}{x} \left( \frac{q^2}{h} \right) + \pdiff{}{y} \left( \frac{qr}{h} \right)
    + g h \pdiff{\zeta}{x} \right) +
    \\*
    &+ \frac{r}{h} \left(
    \pdiff{r}{t} +  \pdiff{}{x} \left( \frac{rq}{h} \right) + \pdiff{}{y} \left( \frac{r^2}{h} \right)
    + g h \pdiff{\zeta}{y} \right) = 0
\end{align}
---1--- Convection term, write in linear function of the derivative
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    &+ \frac{q}{h} \left(
    \pdiff{q}{t}
    +  2 \frac{q}{h}\pdiff{q}{x} - \frac{q^2}{h^2}\pdiff{h}{x} + \frac{q}{h}\pdiff{r}{y}+ \frac{r}{h}\pdiff{q}{y} - \frac{qr}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{x} \right) +
    \\*
    &+ \frac{r}{h} \left(
    \pdiff{r}{t}
    +  \frac{q}{h}\pdiff{r}{x}+ \frac{r}{h}\pdiff{q}{x} - \frac{qr}{h^2}\pdiff{h}{x}
    + 2 \frac{r}{h}\pdiff{r}{y} - \frac{r^2}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{y} \right) = 0
\end{align}
---2--- Separate continuity equation
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    &+ \frac{q}{h} \left(
    \pdiff{q}{t}
    +  \frac{q}{h}\left( \pdiff{q}{x} + \pdiff{r}{y}   \right) +  \frac{q}{h}\pdiff{q}{x} - \frac{q^2}{h^2}\pdiff{h}{x} + + \frac{r}{h}\pdiff{q}{y} - \frac{qr}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{x} \right) +
    \\*
    &+ \frac{r}{h} \left(
    \pdiff{r}{t}
    + \frac{r}{h} \left(\pdiff{q}{x} + \pdiff{r}{y} \right)
    + \frac{q}{h}\pdiff{r}{x}  - \frac{qr}{h^2}\pdiff{h}{x}
    +  \frac{r}{h}\pdiff{r}{y} - \frac{r^2}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{y} \right) = 0
\end{align}
Using the continuity equation
\begin{align}
    \pdiff{q}{x} + \pdiff{r}{y} = -\pdiff{h}{t}
\end{align}
---3--- yields
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    &+ \frac{q}{h} \left(
    \pdiff{q}{t}
    - \frac{q}{h} \pdiff{h}{t} + \frac{q}{h}\pdiff{q}{x}
    - \frac{q^2}{h^2}\pdiff{h}{x} + \frac{r}{h}\pdiff{q}{y}
    - \frac{qr}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{x} \right) +
    \\*
    &+ \frac{r}{h} \left(
    \pdiff{r}{t}
    - \frac{r}{h} \pdiff{h}{t}
    + \frac{q}{h}\pdiff{r}{x} - \frac{qr}{h^2}\pdiff{h}{x}
    + \frac{r}{h}\pdiff{r}{y} - \frac{r^2}{h^2}\pdiff{h}{y}
    + g h \pdiff{\zeta}{y} \right) = 0
\end{align}
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    &+
    \frac{q}{h}\pdiff{q}{t}
    - \frac{q^2}{h^2}  \pdiff{h}{t} + \frac{q^2}{h^2}\pdiff{q}{x}
    - \frac{q^3}{h^3}  \pdiff{h}{x} + \frac{qr}{h^2}\pdiff{q}{y}
    - \frac{q^2r}{h^3} \pdiff{h}{y}
    + g q \pdiff{\zeta}{x} +
    \\*
    &+
    \frac{r}{h} \pdiff{r}{t}
    - \frac{r^2}{h^2} \pdiff{h}{t}
    + \frac{qr}{h^2}  \pdiff{r}{x} - \frac{qr^2}{h^3}\pdiff{h}{x}
    + \frac{r^2}{h^2} \pdiff{r}{y} - \frac{r^3}{h^3}\pdiff{h}{y}
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---4---\newline
assuming $\lpdiff{z_b}{t}=0$ and $\lpdiff{h}{t} = \lpdiff{\zeta}{t}$ and \newline
adding $-\half gh \lpdiff{h}{t} + gh \lpdiff{\zeta}{t} -\half gh \lpdiff{h}{t} = 0$
\begin{align}
    & \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{h}{t}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{q}{x}
    + \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)+ g\zeta  \right) \pdiff{r}{y} +
    \\*
    & -\half gh \pdiff{h}{t} + gh \pdiff{\zeta}{t} -\half gh \pdiff{h}{t} +
    \\*
    &+
    \frac{q}{h}\pdiff{q}{t}
    - \frac{q^2}{h^2}  \pdiff{h}{t} + \frac{q^2}{h^2}\pdiff{q}{x}
    - \frac{q^3}{h^3}  \pdiff{h}{x} + \frac{qr}{h^2}\pdiff{q}{y}
    - \frac{q^2r}{h^3} \pdiff{h}{y}
    + g q \pdiff{\zeta}{x} +
    \\*
    &+
    \frac{r}{h} \pdiff{r}{t}
    - \frac{r^2}{h^2} \pdiff{h}{t}
    + \frac{qr}{h^2}  \pdiff{r}{x} - \frac{qr^2}{h^3}\pdiff{h}{x}
    + \frac{r^2}{h^2} \pdiff{r}{y} - \frac{r^3}{h^3}\pdiff{h}{y}
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---5---
\begin{align}
    & \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{h}{t} + g\zeta  \pdiff{h}{t}
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{q}{x} + g\zeta \pdiff{q}{x}
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{r}{y} + g\zeta \pdiff{r}{y} +
    \\*
    & -\half gh \pdiff{h}{t} + gh \pdiff{\zeta}{t} -\half gh \pdiff{h}{t} +
    \\*
    &+
    \frac{q}{h}\pdiff{q}{t}
    - \frac{q^2}{h^2}  \pdiff{h}{t} + \frac{q^2}{h^2}\pdiff{q}{x}
    - \frac{q^3}{h^3}  \pdiff{h}{x} + \frac{qr}{h^2}\pdiff{q}{y}
    - \frac{q^2r}{h^3} \pdiff{h}{y}
    + g q \pdiff{\zeta}{x} +
    \\*
    &+
    \frac{r}{h} \pdiff{r}{t}
    - \frac{r^2}{h^2} \pdiff{h}{t}
    + \frac{qr}{h^2}  \pdiff{r}{x} - \frac{qr^2}{h^3}\pdiff{h}{x}
    + \frac{r^2}{h^2} \pdiff{r}{y} - \frac{r^3}{h^3}\pdiff{h}{y}
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---6---\newline
Rearranged equations, first $\lpdiff{}{t}$ then $\lpdiff{}{x}$ and $\lpdiff{}{y}$
\begin{align}
    & \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{h}{t} + g\zeta  \pdiff{h}{t}
    + \underbrace{\frac{q}{h}\pdiff{q}{t}
        - \frac{q^2}{h^2}  \pdiff{h}{t}}_{}
    + \underbrace{\frac{r}{h} \pdiff{r}{t}
        - \frac{r^2}{h^2} \pdiff{h}{t}}_{} +
    \\*
    & -\half gh \pdiff{h}{t} + gh \pdiff{\zeta}{t} -\half gh \pdiff{h}{t} +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{q}{x} + g\zeta \pdiff{q}{x}
    + \underbrace{\frac{q^2}{h^2}\pdiff{q}{x}
        - \frac{q^3}{h^3}  \pdiff{h}{x}}_{}
    + g q \pdiff{\zeta}{x}
    + \underbrace{\frac{qr}{h^2}  \pdiff{r}{x}
        - \frac{qr^2}{h^3}\pdiff{h}{x}}_{} +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{r}{y} + g\zeta \pdiff{r}{y}
    + \underbrace{\frac{qr}{h^2}\pdiff{q}{y}
        - \frac{q^2r}{h^3} \pdiff{h}{y}}_{}
    + \underbrace{\frac{r^2}{h^2} \pdiff{r}{y} - \frac{r^3}{h^3}\pdiff{h}{y}}_{}
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---7---
\begin{align}
    & \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{h}{t} + g\zeta  \pdiff{h}{t}
    -\half gh \pdiff{h}{t}
    + \half h \pdiff{}{t}\left(\frac{q^2}{h^2} \right)
    + gh \pdiff{\zeta}{t}  +
    \\*
    &
    -\half gh \pdiff{h}{t}
    + \half h \pdiff{}{t} \left( \frac{r^2}{h^2}  \right) +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{q}{x} + g\zeta \pdiff{q}{x}
    + \half q \pdiff{}{x}\left( \frac{q^2}{h^2} \right)
    + g q \pdiff{\zeta}{x}
    + \half q \pdiff{}{x} \left( \frac{r^2}{h^2}  \right) +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{r}{y} + g\zeta \pdiff{r}{y}
    + \half r \pdiff{}{y} \left( \frac{q^2}{h^2} \right)
    + \half r \pdiff{}{y} \left( \frac{r^2}{h^2} \right)
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---8---
\begin{align}
    & \half \left( \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g\zeta -\half gh \right) \pdiff{h}{t}
    + h \pdiff{}{t} \left( \half \left(\frac{q^2}{h^2}
    + \frac{r^2}{h^2} + g\zeta  - \half g h\right)
    \right) +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{q}{x} + g\zeta \pdiff{q}{x}
    + \half q \pdiff{}{x}\left( \frac{q^2}{h^2}  + \frac{r^2}{h^2}  \right)
    + g q \pdiff{\zeta}{x} +
    \\*
    &
    + \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) \pdiff{r}{y} + g\zeta \pdiff{r}{y}
    + \half r \pdiff{}{y} \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)
    + g r \pdiff{\zeta}{y} = 0
\end{align}
---9---
\begin{align}
    &  \half \pdiff{}{t} \left[ h \left( \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g\zeta -\half gh \right)
    \right] +
    \\*
    &
    + \pdiff{}{x} \left[
    q \left( \half \left( \frac{q^2}{h^2}  + \frac{r^2}{h^2}  \right)
    + g \zeta \right)
    \right] +
    \\*
    &
    + \pdiff{}{y} \left[
    r \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right)
    + g \zeta \right)
    \right] = 0
\end{align}



with steady state solution ($\lpdiff{}{t}=0$, $q=\textit{Constant}$ and $r=\textit{Constant}$):
\begin{align}
    \nabla \left( \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g \zeta \right) = 0
    \quad \Rightarrow \quad
    \half \left( \frac{q^2}{h^2} + \frac{r^2}{h^2} \right) + g \zeta =  \textit{Constant}, \bunit{\square\metre\per\square\second}
\end{align}
