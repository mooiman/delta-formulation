%------------------------------------------------------------------------------
\chapter{Towards the shallow water equations}\label{sec:1d_swe}
Consider the non-linear wave equation when the pressure gradient is explicitly expressed as the gradient of the water level ($\zeta$):
\begin{subequations}
    \begin{align}
        &\underbrace{\pdiff{h}{t}}_{\textsl{Time derivative}}  +
        \underbrace{\pdiff{q}{x}}_{\textsl{Mass flux}} =0,
        \\
        &\underbrace{\pdiff{q}{t}}_{\textsl{Time derivative}}  +
        \underbrace{\pdiff{q^2/h}{x}}_{\textsl{Convection}} +
        \underbrace{gh \pdiff{\zeta}{x}}_{\textsl{Pressure gradient}} +
        \nonumber \\*
        & \qquad \qquad +
        \underbrace{c_f\frac{q\abs{q}}{h^2}}_{\textsl{Bed shear stress}}
        -\underbrace{\pdiff{}{x}\left( \nu h \pdiff{q/h}{x}\right)}_{\textsl{Viscosity}} = 0,
        \\
        &\zeta = h + z_b
    \end{align}
    \label{eq:1d_non_linear_wave2}
\end{subequations}
%
with
\begin{symbollist}
    \item[$h$] Total water depth ($h = \zeta - z_b$), \bunit{\metre}.
    \item[$z_b$] Bed level w.r.t.\ reference plane, positive upward, \bunit{\metre}.
    \item[$q$] Flow ($q = hu$), \bunit{\square\metre\per\second}.
    \item[$\zeta$] Water level w.r.t.\ reference plane ($\zeta = h + z_b$), positive upward, \bunit{\metre}.
    \item[$u$] Velocity ($u = q/h$), \bunit{\metre\per\second}.
    \item[$g$] Acceleration due to gravity, \bunit{\metre\per\square\second}.
    \item[$\nu$] Kinematic viscosity, \bunit{\square\metre\per\second}.
\end{symbollist}

If $u$ is needed for other processes (like morphology and/or post processing) it can be computed according the next equation:
\begin{align}
    u & = \frac{q}{h}.
\end{align}
In the finite volume approach these equations read:
\begin{subequations}
    \begin{align}
        \int_\Omega \pdiff{h}{t}\, d\omega & +\int_\Omega \pdiff{q}{x}\, d\omega=0,
        \\
        \int_\Omega \pdiff{q}{t}\, d\omega & + \int_\Omega \pdiff{q^2/h}{x}\, d\omega + \int_\Omega gh \pdiff{\zeta}{x}\, d\omega  +
        \nonumber \\*
        & \qquad \qquad + \int_{\Omega} c_f\frac{q\abs{q}}{h^2} \, d\omega - \int_{\Omega} \pdiff{}{x}\left( \nu h \pdiff{q/h}{x}\right) \, d\omega= 0,
        \\
        \int_\Omega \zeta\, d\omega & = \int_\Omega h\, d\omega + \int_\Omega z_b\, d\omega
    \end{align}
\end{subequations}

In this document we will end up with an implementation description of the 1D shallow water equation.
We start a zero-dimensional implementation of a source term, representing the source and sink of external influences, like a power plant.
Here we will show the results of a Brusselator \citep{AultHolmgreen2003} and of a air pollution model \citep[ex.\ 1.1 pg.\ 7]{HundsdorferAndVerwer2003}.
Then we continue with the one dimensional advection/transport equation than a one dimensional wave equation without convection, then with convection and at last with a bottom friction term.
in this sequence we are missing the viscosity term, that term will be investigated by the advection-diffusion equation.

Because we will handle the shallow water equations in the variables $h$ and  $q$ and not in $\zeta$ and $u$ the equations does have always a non-linear behaviour, only for very small amplitude the behaviour is like a linear system.
For linear wave equations the behaviour is always linear, even for large amplitudes, which is not the case for the equations we consider.
%------------------------------------------------------------------------------
\section{0-D Source/sink term }\label{sec:0d_source_and_sink}
In this section a zero-dimensional model is implementation of the source term, representing the source and sink of external influences, like a power plant.
The main (simple) equation will look like:
\begin{align}
    \pdiff{\vec{u}}{t} = \vec{f}(\vec{u},t)
\end{align}
Here we will show the mathematical and implementation of an air pollution model, \autoref{sec:air_pollution} \citep[ex.\ 1.1 pg.\ 7]{HundsdorferAndVerwer2003} and a Brusselator, \autoref{sec:brusselator}  \citep{AultHolmgreen2003}.
Some results are shown in \autoref{sec:0d_numerical_experiments}.
%------------------------------------------------------------------------------
\subsection{Air pollution}\label{sec:air_pollution}
%------------------------------------------------------------------------------
\paragraph*{Analytic description}
We illustrate the mass action law by the following three reactions between oxygen $O_2$, atomic oxygen $O$, nitrogen oxide $NO$, and nitrogen dioxide $NO_2$ \citep[eq.\ 1.1, page 7]{HundsdorferAndVerwer2003}:
\begin{align}
    NO_2 + h\nu & \xrightarrow{k_1} NO + O, \\
    O + O_2 & \xrightarrow{k_2} O_3, \\
    NO + O_3 & \xrightarrow{k_3} O_2 + NO_2.
\end{align}
These reactions are basic to any tropospheric air pollution model.
The firstreaction is photochemical and says that $NO$ and $O$ are formed from $N02$ by
photo-dissociation caused by solar radiation, indicated by $h\nu$.
This depends on the time of the day and therefore $k_l = k_l(t)$.
We consider the concentrations $u_1 = \bunit{O}$, $u_2 = \bunit{NO}$, $u_3 = \bunit{NO2}$, $u_4 = \bunit{O3}$. The oxygen concentration $\bunit{O_2}$ is treated as constant, and we assume there is a constant source term $\sigma_2$ simulating emission of nitrogen oxide.
The rate functions and stoichiometric matrix are
\begin{align}
    g(t,u) =
    \begin{pmatrix}
        k_1(t) u_3 \\
        k_2u_1 \\
        k_3u_2u_4
    \end{pmatrix}
    ,
    \qquad
    S =
\begin{pmatrix}
    1 & -1 & 0 \\
    1 & 0 & -1 \\
    -1 & 0 & 1 \\
    0 & 1 & -1
\end{pmatrix}
\end{align}
The corresponding ODE system reads:
\begin{align}
    \pdiff{u_1}{t} & = k_1 u_3 -k_2 u_1
    \\
    \pdiff{u_2}{t} & = k_1 u_3 - k_3 u_2 u_4 +\sigma_2
    \\
    \pdiff{u_3}{t} & = k_3 u_2 u_4 - k_1 u_3
    \\
    \pdiff{u_4}{t} & = k_2 u_1 - k_3 u_2 u_4
\end{align}
We see that
\begin{align}
\pdiff{u_1}{t} + \pdiff{u_3}{t} + \pdiff{u_4}{t} = 0,
\end{align}
and
\begin{align}
\pdiff{u_2}{t} + \pdiff{u_3}{t} = \sigma_2 t
\end{align}
hence $\bunit{O} + \bunit{NO2} + \bunit{O3}$ is a conserved quantity while $\bunit{NO} + \bunit{NO2}$ growths
with $\sigma_2t$.
By considering the null-space of $S^T$ it is seen that these are the two
mass laws for this chemical model.

With $\vec{u}(0) = (0.0, \num{2.0e-1}, \num{2.0e-3}, \num{2.0e-1})^T$ and $\sigma_2 = \num{e-7}$, and the coefficients $k$ are defined as (this given conditions are different from the conditions as defined in \citet[pg.\ 8]{HundsdorferAndVerwer2003}:
\begin{align}
    k_1 & = \begin{cases}
        10^{-5} \exp{(7\ {\it g}(t))}
        \\
        \num{e-40}, \qquad \text{during  night}
    \end{cases}
    \\
    k_2 & = \num{2.0e-2}
    \\
    k_3 & = \num{1.0e-3}
\end{align}
with
\begin{align}
    {\it g}(t) =\left(\sin\left(\frac{\pi}{16} (t_h - 4)\right)\right)^{0.2}, \qquad t_h = \frac{t}{3600};
\end{align}
where $t_h$ is the time in hours.
How these equations are discretized is given in \autoref{sec:air_pollution_discretization}.
%
%-------------------------------------------------------------------------------
\paragraph*{Numerical discretization}\label{sec:air_pollution_discretization}
The discretization in $\Delta$-formulation reads:
\begin{align}
    \frac{1}{\Dt}\Delta u_1^{n+1, p+1} & = - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) + k_1 (u_3^{n+\theta,p+1}) - k_2 (u_1^{n+\theta,p+1})
    \\
    \frac{1}{\Dt}\Delta u_2^{n+1, p+1} & = - \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_1(u_3^{n+\theta,p+1}) - k_3 (u_2^{n+\theta,p+1}) (u_4^{n+\theta,p+1}) +\sigma_2
    \\
    \frac{1}{\Dt}\Delta u_3^{n+1, p+1} & = - \frac{1}{\Dt}(u_3^{n+1,p} - u_3^n) + k_3 (u_2^{n+\theta,p+1}) (u_4^{n+\theta,p+1}) - k_1(u_3^{n+\theta,p+1})
    \\
    \frac{1}{\Dt}\Delta u_4^{n+1, p+1} & = - \frac{1}{\Dt}(u_4^{n+1,p} - u_4^n) + k_2(u_1^{n+\theta,p+1}) - k_3 (u_2^{n+\theta,p+1}) (u_4^{n+\theta,p+1})
\end{align}
with linearization of $\vec{u}^{n+\theta,p+1}$ yields:
\begin{align}
    \frac{1}{\Dt}\Delta u_1^{n+1, p+1} & =
    - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) +
    \nonumber \\*
    & + k_1 (u_3^{n+\theta,p} + \theta \Delta u_3^{n+1, p+1}) - k_2 (u_1^{n+\theta,p} + \theta \Delta u_1^{n+1, p+1})
    \\
    %-----
    \frac{1}{\Dt}\Delta u_2^{n+1, p+1} & = - \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_1(u_3^{n+\theta,p} + \theta \Delta u_3^{n+1, p+1}) +
    \nonumber \\*
    & - k_3 (u_2^{n+\theta,p} + \theta \Delta u_2^{n+1, p+1}) (u_4^{n+\theta,p} + \theta \Delta u_4^{n+1, p+1}) +\sigma_2
    \\
    %-----
    \frac{1}{\Dt}\Delta u_3^{n+1, p+1} & = - \frac{1}{\Dt}(u_3^{n+1,p} - u_3^n) + k_3 (u_2^{n+\theta,p} + \theta \Delta u_2^{n+1, p+1}) (u_4^{n+\theta,p} +
    \nonumber \\*
    & +  \theta \Delta u_4^{n+1, p+1}) - k_1(u_3^{n+\theta,p} + \theta \Delta u_3^{n+1, p+1})
    \\
    %-----
    \frac{1}{\Dt}\Delta u_4^{n+1, p+1} & = - \frac{1}{\Dt}(u_4^{n+1,p} - u_4^n) + k_2(u_1^{n+\theta,p} + \theta \Delta u_1^{n+1, p+1}) +
    \nonumber \\*
    & - k_3 (u_2^{n+\theta,p} + \theta \Delta u_2^{n+1, p+1}) (u_4^{n+\theta,p} + \theta \Delta u_4^{n+1, p+1})
\end{align}
and rearrange the system of equations to $\mat{A}\vec{x}=\vec{b}$, yields
\begin{align}
    \frac{1}{\Dt}\Delta u_1^{n+1, p+1} &  - k_1  \theta \Delta u_3^{n+1, p+1} + k_2  \theta \Delta u_1^{n+1, p+1}  =
    \nonumber \\*
    & = - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) + k_1 u_3^{n+\theta,p} - k_2 u_1^{n+\theta,p}
    \\
    %-----
    \frac{1}{\Dt}\Delta u_2^{n+1, p+1} & - k_1 \theta \Delta u_3^{n+1, p+1}
    + k_3 \theta u_4^{n+1,p} \Delta u_2^{n+1, p+1} + k_3 \theta u_2^{n+1,p} \Delta u_4^{n+1, p+1}  =
    \nonumber \\*
    & = - \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_1 u_3^{n+\theta,p} - k_3 u_2^{n+\theta,p} u_4^{n+\theta,p} +\sigma_2
    \\
    %-----
    \frac{1}{\Dt}\Delta u_3^{n+1, p+1} & - k_3 u_2^{n+\theta,p} \theta \Delta u_4^{n+1, p+1} - k_3 u_4^{n+\theta,p} \theta \Delta u_2^{n+1, p+1} + k_1 \theta \Delta u_3^{n+1, p+1}  =
    \nonumber \\*
    & = - \frac{1}{\Dt}(u_3^{n+1,p} - u_3^n) + k_3 u_2^{n+\theta,p} u_4^{n+\theta,p} - k_1 u_3^{n+\theta,p}
    \\
    \frac{1}{\Dt}\Delta u_4^{n+1, p+1}&  - k_2 \theta \Delta u_1^{n+1, p+1}  + k_3 u_2^{n+\theta,p}\theta \Delta u_4^{n+1, p+1} +k_3 u_4^{n+\theta,p} \theta \Delta u_2^{n+1, p+1} =
    \nonumber \\*
    & = - \frac{1}{\Dt}(u_4^{n+1,p} - u_4^n) + k_2 u_1^{n+\theta,p} - k_3 u_2^{n+\theta,p} u_4^{n+\theta,p}
\end{align}
%------------------------------------------------------------------------------
\subsection{Brusselator}\label{sec:brusselator}
%------------------------------------------------------------------------------
\paragraph*{Analytic description}
The  ODE system for the Brusselator reads \citet[eq.\ 14,15]{AultHolmgreen2003}:
\begin{align}
    \pdiff{u_1}{t} & = 1 - (k_2 + 1) u_1 + k_1 u_1^2 u_2,
    \\
    \pdiff{u_2}{t} & = k_2 u_1 - k_1 u_1^2 u_2
    \label{eq:brusselator}
\end{align}
with $k_1 =1$ and  $k_2 = 2.5$ and initial values  $u_1(0)=0$ and $u_2(0) = 0$.
%-------------------------------------------------------------------------------
\paragraph*{Numerical discretization}\label{sec:brusselator_discretization}

The  ODE system for the brusselator reads \citep[eq.\ 14,15]{AultHolmgreen2003}:
\begin{align}
    \pdiff{u_1}{t} & = 1 - (k_2 + 1) u_1 + k_1 u_1^2 u_2,
    \\
    \pdiff{u_2}{t} & = k_2 u_1 - k_1 u_1^2 u_2
    \label{eq:brusselator}
\end{align}
The discretization in $\Delta$-formulation reads:
\begin{align}
    \frac{1}{\Dt}\Delta u_1^{n+1, p+1} & = - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) + 1 - (k_2 +1) u_1^{n+\theta,p+1} +
    \nonumber \\*
    &  + k_1 \left(u_1^{n+\theta,p+1}\right)^2 u_2^{n+\theta,p+1}
    \\
    \frac{1}{\Dt}\Delta u_2^{n+1, p+1} & = - \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_2(u_1^{n+\theta,p+1})  +
    \nonumber \\*
    & - k_1 \left(u_1^{n+\theta,p+1}\right)^2 u_2^{n+\theta,p+1}
\end{align}
with linearization of $\vec{u}^{n+\theta,p+1}$ yields:
\begin{align}
    \frac{1}{\Dt}\Delta u_1^{n+1, p+1} & =
    - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) + 1 - (k_2 +1) \left(u_1^{n+\theta,p} + \theta \Delta u_1^{n+1, p+1}\right)+
    \nonumber \\*
    &  + k_1 \left(u_1^{n+\theta,p}+\Delta u_1^{n+1, p+1}\right)^2 \left(u_2^{n+\theta,p}+ \Delta u_1^{n+1, p+1}\right)
    \\
    \frac{1}{\Dt}\Delta u_2^{n+1, p+1} & = - \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_2 (u_1^{n+\theta,p} + \theta \Delta u_1^{n+1, p+1}) +
    \nonumber \\*
    &
    - k_1 \left(u_1^{n+\theta,p}+\Delta u_1^{n+1, p+1}\right)^2 \left(u_2^{n+\theta,p}+ \Delta u_1^{n+1, p+1}\right)
\end{align}
and rearrange the system of equations to $\mat{A}\vec{x}=\vec{b}$ and omitting the second order terms, yields
\begin{align}
    &\frac{1}{\Dt}\Delta u_1^{n+1, p+1}
    - \theta \left(\left(k_2 +1\right) + 2  k_1 u_1^{n+\theta,p} u_2^{n+\theta,p}\right)\Delta u_1 ^{n+1, p+1}
    - \theta k_1 \left(u_1^{n+1, p+1}\right)^2 \Delta u_2 ^{n+1, p+1} =
    \nonumber \\*
    & = - \frac{1}{\Dt}(u_1^{n+1,p} - u_1^n) + 1 - (k_2 +1) u_1^{n+\theta,p} + k_1 \left(u_1^{n+\theta,p}\right)^2 u_2^{n+\theta,p}
    \\
    & \frac{1}{\Dt}\Delta u_2^{n+1, p+1}
    + \theta \left( k_2 + 2 k_1 u_1^{n+\theta,p} u_2^{n+\theta,p} \right) \Delta u_1 ^{n+1, p+1}
    + \theta k_1\left(u_1^{n+1, p+1}\right)^2 \Delta u_2 ^{n+1, p+1}
    = \nonumber \\*
    & =- \frac{1}{\Dt}(u_2^{n+1,p} - u_2^n) + k_2 u_1^{n+\theta,p}
    - k_1 \left(u_1^{n+\theta,p}\right)^2 u_2^{n+\theta,p}
\end{align}
This system can be implemented and solved, some results are presented in \autoref{sec:brusselator}.
%
%------------------------------------------------------------------------------
\section{1-D Advection-diffusion equation}
In this section we will discuss the discretization of an advection-diffusion equation when the constituent does not need to be positive and when the constiuent must be positive.

%------------------------------------------------------------------------------
\subsection{Not strictly positive constituent}\label{sec:1d_adv_diff_equation}
The considered advection-diffusion equation reads:
\begin{align}
    \pdiff{c}{t} + \pdiff{uc}{x} - \pdiff{}{x}\left( \eps \pdiff{c}{x}\right)= 0, \qquad u>0. \label{eq:1d_advection}
\end{align}
A constituent $c$ is transported from the left to the right with the constant  velocity $u\, \bunit{\meter\per\second}$.
Which is discretised on the grid
\begin{figure}[H]
    \centering
    \begin{center}
        \resizebox{0.8\textwidth}{!}{
            \input{figures/water_body_fve_bc_at_node.pdf_tex}
        }
    \end{center}
    \caption[Definition of the grid to solve the 1D-advection equation]{Water body (blue area), finite volumes (green boxes), computational points (open dots), virtual computational points (black dots), boundary points are at $x_{1}$ (inflow/west boundary) and $x_{I+\half}$ (outflow/east boundary).}\label{fig:water_body_fve_bc_at_node_1}
\end{figure}
The finite volume approach for control volume $\Dx_{i+\half}$ of \autoref{eq:1d_advection} reads:
\begin{align}
    \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{c}{t}\, dx
    + \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{uc}{x} \, dx
    - \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{}{x}\left( \eps\pdiff{c}{x} \right)\, dx &= 0
    \\
    \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{c}{t}\, dx + \left. (uc) \right|_{i+\half} -  \left. (uc) \right|_{i-\half}
    -  \left(
    \left. \eps\pdiff{c}{x}\right|_{i+\half} -
    \left. \eps\pdiff{c}{x}\right|_{i-\half}
     \right) & = 0
\end{align}

%------------------------------------------------------------------------------
\paragraph*{Discretization interior}
The discretization in \deltaformulation in the interior of domain $\Omega$ and
for equidistant grid and the mass-matrix as given in \autoref{eq:definition_mass_matrix} reads
\begin{align}
    & \Dx \Dt_{inv} \left(\frac{1}{8} \Delta c^{n+1,p+1}_{i-1} + \frac{6}{8} \Delta c^{n+1,p+1}_{i} + \frac{1}{8} \Delta c^{n+1,p+1}_{i+1}\right)  +
    \nonumber \\*
    &
    + \left\{ \Dx \Dt_{inv} \left( \frac{1}{8}\left( c^{n+1,p}_{i-1} - c^{n}_{i-1} \right) + \frac{6}{8}\left( c^{n+1,p}_{i} - c^{n}_{i} \right) + \frac{1}{8}\left( c^{n+1,p}_{i+1} - c^{n}_{i+1} \right) \right)  \right\} +
    \nonumber \\*
    &\quad  +  u \left( \half (c^{n+\theta, p+1}_{i} + c^{n+\theta,p+1}_{i+1}) -  \half (c^{n+\theta, p+1}_{i-1} +c^{n+\theta,p+1}_{i}) \right) +
    \nonumber \\*
    &\quad - \left( \eps_{i+\half} \frac{c^{n+\theta, p+1}_{i+1} - c^{n+\theta, p+1}_{i}}{\Dx} - \eps_{i-\half} \frac{c^{n+\theta, p+1}_{i} - c^{n+\theta, p+1}_{i-1}}{\Dx}\right) = 0
\end{align}
After linearization of $c^{n+\theta,p+1}$ the discretization reads:
\begin{align}
    \Dx & \Dt_{inv}  \left(\frac{1}{8} \Delta c^{n+1,p+1}_{i-1} + \frac{6}{8} \Delta c^{n+1,p+1}_{i} + \frac{1}{8} \Delta c^{n+1,p+1}_{i+1}\right)
    \nonumber \\*
    & \half \theta u \left(  \Delta c^{n+1,p+1}_{i} + \Delta c^{n+1,p+1}_{i+1} - \left( \Delta c^{n+1,p+1}_{i-1} + \Delta c^{n+1,p+1}_{i}  \right)\right) +
    \nonumber \\*
    & - \theta \frac{\eps_{i+\half}}{\Dx} \Delta c^{n+1, p+1}_{i+1}
    + \theta \left( \frac{\eps_{i+\half}}{\Dx} + \frac{\eps_{i-\half}}{\Dx} \right) \Delta c^{n+1, p+1}_{i} - \theta \frac{\eps_{i-\half}}{\Dx} \Delta c^{n+1, p+1}_{i-1}
    =
    \nonumber \\*
    & = -\left\{ \Dx \Dt_{inv} \left( \frac{1}{8}\left( c^{n+1,p}_{i-1} - c^{n}_{i-1} \right) + \frac{6}{8}\left( c^{n+1,p}_{i} - c^{n}_{i} \right) + \frac{1}{8}\left( c^{n+1,p}_{i+1} - c^{n}_{i+1} \right)\right) + \right.
    \nonumber \\*
    & \qquad + \half u \left((c^{n+\theta, p}_{i} + c^{n+\theta,p}_{i+1}) -  (c^{n+\theta, p}_{i-1} +c^{n+\theta,p}_{i}) \right) +
    \nonumber \\*
    &\qquad - \left. \left( \eps_{i+\half} \frac{c^{n+\theta,p}_{i+1} - c^{n+\theta,p}_{i}}{\Dx} - \eps_{i-\half} \frac{c^{n+\theta,p}_{i} - c^{n+\theta,p}_{i-1}}{\Dx}\right) \right\}
\end{align}

%------------------------------------------------------------------------------
\paragraph*{Discretization at boundaries}
An \textbf{essential} boundary condition at the inflow boundary is needed, left side of the domain.
And, at the right side an outflow boundary 'condition' is required for numerical reasons (called  a \textbf{natural} boundary condition), i.e.\ a discretization of the model equation at the outflow boundary.
The natural boundary conditions is fully determined by the outgoing signal and therefor we use the equation of the outgoing signal, i.e.\ \autoref{eq:left_right_going_equations}.
For the 1-D advection-diffusion equation when omitting the viscosity term it reads:
\begin{align}
    \pdiff{c}{t} + \pdiff{uc}{x}  = 0, \qquad u>0. \label{eq:1d_adv_nat_boundary}
\end{align}

The \textbf{essential} boundary condition at the inflow boundary reads:
\begin{align}
    c(0,t) = c_0(t), \quad t > 0 \qquad \text{(essential boundary)}
\end{align}
The essential boundary condition is supplied at $x_1$ with the following discretization (\autoref{eq:stencil_ess})
\begin{align}
    &\frac{1}{12} \Delta c^{n+1,p+1}_0 + \frac{10}{12} \Delta c^{n+1,p+1}_1 + \frac{1}{12}\Delta c^{n+1,p+1}_2 =
    \nonumber \\*
    &\qquad =c_0(t) - \left( \frac{1}{12} c^{n+1,p}_0 + \frac{10}{12} c^{n+1,p}_1 + \frac{1}{12} c^{n+1,p}_2 \right)
\end{align}
\todo{The implementation is not stable, check implementation!}
The \textbf{natural} is chosen in that way that as less as possible left going spurious numerical waves are generated at the outflow boundary, i.e.\ nearly no reflection.
The natural boundary condition is supplied at $x_I$ with the discretization constants as determined by \autoref{eq:stencil_nat} and boundary condition \autoref{eq:1d_adv_nat_boundary} which yields:
\begin{align}
    &\left( \frac{1+\alpha_{\it bnd}}{\Dt} + \theta \frac{u}{\Dx} \right) \Delta c^{n+1,p+1}_{I+1} +
     \left( \frac{1-2\alpha_{\it bnd}}{\Dt} - \theta \frac{u}{\Dx} \right) \Delta c^{n+1,p+1}_I +
      \frac{\alpha_{\it bnd}}{\Dt}  \Delta c^{n+1,p+1}_{I-1}  =
    \\
    & = - \left\{
          \frac{1+\alpha_{\it bnd}}{\Dt} \left( c^{n+1,p}_{I+1} - c^n_{I+1} \right)
        + \frac{1-2\alpha_{\it bnd}}{\Dt} \left( c^{n+1,p}_{I} - c^n_{I} \right)
        + \frac{\alpha_{\it bnd}}{\Dt} \left( c^{n+1,p}_{I-1}- c^n_{I-1} \right) +
        \right. \\
    & \left. + \frac{u}{\Dx} \left(c^{n+\theta,p}_{I+1} - c^{n+\theta,p}_{I} \right)
        \right\}
\end{align}
where $\alpha_{\it bnd} = 2\alpha -\half$ ($\alpha_{\it bnd} = -\quart$ when $\alpha = \frac{1}{8}$)

%------------------------------------------------------------------------------
\subsection{Strictly positive constituent}\label{sec:1d_adv_diff_poss_equation}

When $c$ needs a strickly positive value (like a concentration) then due to numerical discretization the value $c$ could become negative, even if the initial and boundary values are positive.
In certain applications a positive value is required and even small negative are not allowed.
To ensure the positivity of the constituent $c$ we will write the equation with variable $\phi$, where $\phi$ is defined as:
\begin{align}
    c = \exp(\ln(c)) =  \exp(\phi), \quad \text{with} \quad \phi = \ln(c)
\end{align}
The considered advection-diffusion equation than reads:
\begin{align}
    \int_\Omega\pdiff{{e^\phi}}{t} \, d\omega
    + \int_\Omega\pdiff{\left(u{e^\phi}\right)}{x} \, d\omega
    - \int_\Omega\pdiff{}{x}\left(\eps \pdiff{{e^\phi}}{x}\right)\, d\omega = 0,\label{eq:1d_advec_phi}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Discretization interior}
\notyet
%------------------------------------------------------------------------------
\paragraph*{Discretization at boundaries}
\notyet
%------------------------------------------------------------------------------
\section{1-D wave equation}

The hyperbolic part of the one dimensional shallow water equations (assuming that the viscosity term vanish) are diagonalized to separate the left and right going wave.
We start from the follwoing equations, with convection
for flat bottom ($\half g\, \lpdiff{h^2}{x} = gh\, \lpdiff{h}{x}$ and $\lpdiff{z_b}{x} = 0$), reads
%
\begin{align}
    \pdiff{h}{t}  + \pdiff{q}{x} & = 0 \qquad \textit{continuity eq.} \label{eq:continuity_equation}\\
    \pdiff{q}{t}  + \pdiff{}{x} \left( \frac{q^2}{h} \right) + g h \pdiff{h}{x} & = 0 \qquad \textit{momentum eq.}
    \label{eq:momentum_equation}
\end{align}
These one dimensional shallow water equations can be written in matrix and vector notation as:
\begin{align}
    \pdiff{\vec{u}}{t} + \mat{A} \pdiff{\vec{u}}{x} = 0
\end{align}
To find the characteristic equations this set of equations should be written in a set of equation representing left and right going waves.
The diagonalisation is performed as follows:
\begin{align}
    &\pdiff{\vec{u}}{t} + \mat{P}\underbrace{\mat{P^{-1}}\mat{A}\mat{P}}_{\mat{\Lambda}}\mat{P^{-1}} \pdiff{\vec{u}}{x} = 0
\end{align}
multiply this with $\mat{P^{-1}}$
\begin{align}
    &\mat{P^{-1}}\pdiff{\vec{u}}{t} + \mat{\Lambda}\mat{P^{-1}} \pdiff{\vec{u}}{x} = 0
\end{align}
with $\mat{\Lambda}$ a diagonal matrix and thus the left and right going signals are independent.
For the one dimensional shallow water equations the two independent equations read:
\begin{align}
    \begin{matrix}
        \quad \text{right going} \\
        \quad \text{left going}
    \end{matrix}
    \qquad
    \begin{pmatrix}
        \sqrt{gh} + \frac{q}{h}  &  -1 \\
        \sqrt{gh} - \frac{q}{h}  &  1
    \end{pmatrix}
    \begin{pmatrix} \textit{continuity eq.} \\ \textit{momentum eq.} \end{pmatrix}    = 0
    \label{eq:left_right_going_equations}
\end{align}
See for a derivation \autoref{sec:diagonalise_conservative_wave_with_convection}.

We have split the hyperbolic wave equation into a right and left going wave.
Now we are able to apply the \textbf{natural} boundary conditions as described in \autoref{sec:1d_adv_diff_equation} for each of the waves.
The \textbf{essential} boundary condition is chosen to be an absorbing boundary, so no reflections at the boundaries will appear.

For the space discretizations of an arbitrary function $u$, the following space interpolations are used:
\begin{align}
    u_{i+\half} & = \half \left( u_{i+1} + u_{i} \right) &\textit{interface of control volume}
    \\
    u_{i+\quart} & = \quart \left( 3 u_{i} + u_{i+1} \right) &\textit{quadrature point of sub-control volume}
    \\
    u_{i-\quart} & = \quart \left( 3 u_{i} + u_{i-1} \right) &\textit{quadrature point of sub-control volume}
\end{align}
These formulas are visualized in \autoref{fig:1d_integration}.


%------------------------------------------------------------------------------
\subsection{Discretizations continuity equation}
The discretization of the continuity equation will be presented term by term of \autoref{eq:continuity_equation}.
%------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the continuity equation reads:
\begin{align}
    & \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{h}{t}\, dx
\end{align}
which will be approximated by
\begin{align}
    &\half \Delta x_{i-\half} \left( \frac{1}{4}\pdiff{h_{i-1}}{t} + \frac{3}{4}\pdiff{h_{i}}{t}  \right) +
    \half \Delta x_{i+\half} \left( \frac{3}{4}\pdiff{h_{i}}{t} + \frac{1}{4}\pdiff{h_{i+1}}{t} \right) \approx
    \nonumber \\*
    & \approx
    \frac{\Delta x_{i-\half}}{\Dt} \left(
    \frac{1}{8}\left(\Delta h^{n+1,p+1}_{i-1} + h^{n+1,p}_{i-1} - h^{n}_{i-1} \right) + \frac{3}{8}\left(\Delta h^{n+1,p+1}_{i} + h^{n+1,p}_{i}- h^{n}_{i}\right)
    \right) +
    \nonumber \\*
    & +
    \frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\left(\Delta h^{n+1,p+1}_{i} + h^{n+1,p}_{i+1}- h^{n}_{i}\right) + \frac{1}{8}\left(\Delta h^{n+1,p+1}_{i+1} + h^{n+1,p}_{i+1}- h^{n}_{i+1}\right)
    \right)
\end{align}
after rearranging the equation into an implicit left hand side and an explicit right hand side  it reads:
\begin{align}
    &  \frac{\Delta x_{i-\half}}{\Dt} \left(
    \frac{1}{8}\Delta h^{n+1,p+1}_{i-1} + \frac{3}{8}\Delta h^{n+1,p+1}_{i}
    \right) +
    \frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\Delta h^{n+1,p+1}_{i} + \frac{1}{8}\Delta h^{n+1,p+1}_{i+1}
    \right) =
    \nonumber \\
    &  = -\left\{
    \frac{\Delta x_{i-\half}}{\Dt} \left(
\frac{1}{8}\left(h^{n+1,p}_{i-1} - h^{n}_{i-1} \right) + \frac{3}{8}\left(h^{n+1,p}_{i}- h^{n}_{i}\right)
\right) + \right.
\nonumber \\*
& \left. +
\frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\left(h^{n+1,p}_{i+1}- h^{n}_{i}\right) + \frac{1}{8}\left(h^{n+1,p}_{i+1}- h^{n}_{i+1}\right)
\right)\right\}
\end{align}

%------------------------------------------------------------------------------
\subsubsection{Mass flux}
The discretization of the mass flux term of the continuity equation reads:
\begin{align}
    \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{q}{x} \,dx
\end{align}
which will be approximated by the $\theta$-method and using Green's theorem:
\begin{align}
q^{n+\theta, p+1}_{i+\half} - q^{n+\theta, p+1}_{i-\half}.
\end{align}
The linearization of the flux $q$ around iteration level $p$ reads then:
\begin{align}
    q^{n+\theta,p}_{i+\half}  + \theta \Delta q^{n+1, p+1}_{i+\half}
    - q^{n+\theta,p}_{i-\half}  - \theta \Delta q^{n+1, p+1}_{i-\half}
\end{align}
after rearranging the equation into an implicit left hand side and an explicit right hand side  it reads:
\begin{align}
\half  \theta \Delta q^{n+1, p+1}_{i} - \half \theta \Delta q^{n+1, p+1}_{i-1} + \left\{ \half q^{n+\theta,p}_{i+1}  - \half q^{n+\theta,p}_{i-1} \right\}
\end{align}

%------------------------------------------------------------------------------
\subsection{Discretizations momentum equation}
The discretization of the momentum equation will be presented term by term of \autoref{eq:momentum_equation}.
%------------------------------------------------------------------------------
\subsubsection{Time derivative}
The discretization of the time derivative term of the momentum equation reads and is similar as for the continuity equation:
\begin{align}
    & \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{q}{t}\, dx
\end{align}
which will be approximated by
\begin{align}
    &\half \Delta x_{i-\half} \left( \frac{1}{4}\pdiff{q_{i-1}}{t} + \frac{3}{4}\pdiff{q_{i}}{t}  \right) +
    \half \Delta x_{i+\half} \left( \frac{3}{4}\pdiff{q_{i}}{t} + \frac{1}{4}\pdiff{q_{i+1}}{t} \right) \approx
    \nonumber \\*
    & \approx
    \frac{\Delta x_{i-\half}}{\Dt} \left(
    \frac{1}{8}\left(\Delta q^{n+1,p+1}_{i-1} + q^{n+1,p}_{i-1} - q^{n}_{i-1} \right) + \frac{3}{8}\left(\Delta q^{n+1,p+1}_{i} + q^{n+1,p}_{i}- h^{n}_{i}\right)
    \right) +
    \nonumber \\*
    & +
    \frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\left(\Delta q^{n+1,p+1}_{i} + q^{n+1,p}_{i+1}- q^{n}_{i}\right) +
    \frac{1}{8}\left(\Delta q^{n+1,p+1}_{i+1} + q^{n+1,p}_{i+1}- q^{n}_{i+1}\right)
    \right)
\end{align}
after rearranging the equation into an implicit left hand side and an explicit right hand side  it reads:
\begin{align}
    &  \frac{\Delta x_{i-\half}}{\Dt} \left(
    \frac{1}{8}\Delta q^{n+1,p+1}_{i-1} + \frac{3}{8}\Delta q^{n+1,p+1}_{i}
    \right) +
    \frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\Delta q^{n+1,p+1}_{i} + \frac{1}{8}\Delta q^{n+1,p+1}_{i+1}
    \right) +
    \nonumber \\
    & + \left\{
    \frac{\Delta x_{i-\half}}{\Dt} \left(
    \frac{1}{8}\left(q^{n+1,p}_{i-1} - q^{n}_{i-1} \right) + \frac{3}{8}\left(q^{n+1,p}_{i}- q^{n}_{i}\right)
    \right) + \right.
    \nonumber \\*
    & \qquad \left. +
    \frac{\Delta x_{i+\half}}{\Dt} \left( \frac{3}{8}\left(q^{n+1,p}_{i+1}- q^{n}_{i}\right) + \frac{1}{8}\left(q^{n+1,p}_{i+1}- q^{n}_{i+1}\right)
    \right)\right\}
\end{align}

%--------------------------------------------------------------------------------
\subsubsection{Pressure term} \label{sec:pressure_dependent_on_zeta}
The pressure term is dependent on the gradient of the water level $\zeta$ and reads:
\begin{align}
    & \int_{i-\half}^{i+\half} gh\pdiff{\zeta}{x} \,dx.
\end{align}
The acceleration due to gravity is assumed to be constant ($g={\it{constant}}$).
We first linearize the equation and then discretize in space.
The linearization of the pressure term around iteration level $p$ reads:
\begin{align}
    & g h \left. \pdiff{\zeta}{x} \right|^{n+\theta,p+1}  \approx
    \\
    & \approx g h^{n+\theta,p} \pdiff{\zeta^{n+\theta,p}}{x} +
    \theta g \pdiff{\zeta^{n+\theta,p}}{x} \Delta h^{n+1, p+1} +
    \theta g h^{n+\theta,p} \pdiff{}{x} \Delta \zeta^{n+1, p+1} \label{eq:pres_grad_zeta}
\end{align}
Computing the integral over the finite volume:
\begin{align}
    \int_{x_{i-\half}}^{x_{i+\half}} gh\pdiff{\zeta}{x} \,dx & = \int_{x_{i-\half}}^{x_{i}} gh\pdiff{\zeta}{x} \,dx +
    \int_{x_{i}}^{x_{i+\half}} gh\pdiff{\zeta}{x} \,dx
    \label{eq:pres_grad_zeta_fv}
\end{align}
with piecewise linear $h$ en piecewise linear $\zeta$, thus piecewise constant $\lpdiff{\zeta}{x}$.
The first term of \autoref{eq:pres_grad_zeta} becomes:
\begin{align}
    & \int_{x_{i-\half}}^{x_{i}} g h^{n+\theta,p} \pdiff{\zeta^{n+\theta,p}}{x} \,dx +
    \int_{x_{i}}^{x_{i+\half}} g h^{n+\theta,p} \pdiff{\zeta^{n+\theta,p}}{x} \,dx \approx
    \nonumber \\*
    & \approx \frac{\Dx_{i-\half}}{2}  g  h^{n+\theta,p}_{i-\quart} \frac{\zeta^{n+\theta,p}_i- \zeta^{n+\theta,p}_{i-1}}{\Dx_{i-\half}} +
    \frac{\Dx_{i+\half}}{2} g h^{n+\theta,p}_{i+\quart} \frac{\zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i}}{\Dx_{i+\half}}
    \\
    & = \half g h^{n+\theta,p}_{i-\quart} \left(\zeta^{n+\theta,p}_i- \zeta^{n+\theta,p}_{i-1}\right)
    +
    \half g h^{n+\theta,p}_{i+\quart} \left(\zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i}\right)
\end{align}
The second term of \autoref{eq:pres_grad_zeta}
\begin{align}
    & \int_{x_{i-\half}}^{x_{i}} \theta g \pdiff{\zeta^{n+\theta,p}}{x}\Delta h^{n+1, p+1}_{i-\quart} \, dx +
    \int_{x_{i}}^{x_{i+\half}} \theta g \pdiff{\zeta^{n+\theta,p}}{x}\Delta h^{n+1, p+1}_{i+\quart} \,dx \approx
    \\
    & \approx
     \half \theta g  (\zeta^{n+\theta,p}_{i}- \zeta^{n+\theta,p}_{i-1}) \Delta h^{n+1, p+1}_{i-\quart} +
     \half \theta g (\zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i}) \Delta h^{n+1, p+1}_{i+\quart}
\end{align}
The third term of \autoref{eq:pres_grad_zeta}
\begin{align}
    &\int_{x_{i-\half}}^{x_{i}} \theta g h^{n+\theta,p}_{i-\quart} \pdiff{}{x} \Delta \zeta^{n+1, p+1} \,dx + \int_{x_{i+\half}}^{x_{i}} \theta g h^{n+\theta,p}_{i+\quart} \pdiff{}{x} \Delta \zeta^{n+1, p+1} \,dx =
    \\
    & = \half \theta g h^{n+\theta,p}_{i-\quart}
    \left(\Delta\zeta^{n+1,p+1}_{i}-\Delta\zeta^{n+1,p+1}_{i-1} \right) +
    \half \theta g h^{n+\theta,p}_{i+\quart}
    \left(\Delta\zeta^{n+1,p+1}_{i+1}-\Delta\zeta^{n+1,p+1}_{i} \right)
\end{align}
In a formulation of the shallow-water equations, where the water level is expressed as $\zeta = h + z_b$.
The equations can be simplified, because
\begin{align}
    \Delta \zeta = \Delta (h + z_b) = \Delta h + \Delta z_b.
\end{align}
and if $\Delta z_b=0$, i.e.\ time independent, the contributions to the $\Delta \zeta$-equations need to be incorporated in the $\Delta h$-equations.
Adjusting the matrix coefficients and right-hand side change accordingly.
%------------------------------------------------------------------------------
\subsubsection{Convection}
The convection term read:
\begin{align}
    &  \int_{x_{i-\half}}^{x_{i+\half}} \pdiff{q^2/h}{x} \,dx
    = \left. \frac{q^2}{h}\right|^{n+\theta, p+1}_{i+\half}
    - \left. \frac{q^2}{h}\right|^{n+\theta, p+1}_{i-\half}
\end{align}

The linearization of the convection term around iteration level $p$ reads:
\begin{align}
    \left. \frac{q^2}{h}\right|^{n+\theta, p+1}
    &\approx
    \frac{(q^{n+\theta,p})^2}{h^{n+\theta,p}} +
    2 \frac{q^{n+\theta,p}}{h^{n+\theta,p}} \theta \Delta q^{n+1,p+1}
    - \frac{(q^{n+\theta,p})^2}{(h^{n+\theta,p})^2}  \theta \Delta h^{n+1,p+1}
\end{align}
(where $\Delta q^{n+\theta,p+1} = \theta \Delta q^{n+1,p+1}$ and $\Delta h^{n+\theta,p+1} = \theta \Delta h^{n+1,p+1}$, see \autoref{eq:delta_n_theta}).
%------------------------------------------------------------------------------
\subsubsection{Bed shear stress}
The bed shear stress term reads:
\begin{align}
    \int_{x_{i-\half}}^{x_{i+\half}} c_f\frac{q\abs{q}}{h^2} \,dx  & = \int_{x_{i-\half}}^{x_{i}} c_f\frac{q\abs{q}}{h^2} \,dx +
    \int_{x_{i}}^{x_{i+\half}} c_f\frac{q\abs{q}}{h^2} \,dx \approx
    \\
    & \approx \frac{\Dx_{i-\half}}{2} \left( {c_f}_{i-\quart}\frac{q_{i-\quart}\abs{q_{i-\quart}}}{(h_{i-\quart})^2}  \right)  +
    \frac{\Dx_{i+\half}}{2} \left( {c_f}_{i+\quart}\frac{q_{i+\quart}\abs{q_{i+\quart}}}{(h_{i+\quart})^2} \right)
\end{align}
To avoid the discontinue derivative of the abs-function, this function is replaced by the following  $C^2$-continue function:
\begin{align}
    \abs{q} = \Fabs{q} \approx \left( q^4 + \eps^4 \right)^{1/4}, \qquad \eps = 0.01
    \label{eq:continue_abs}
\end{align}
We first linearize the equation and then discretize/integrate in space.
The linearization of the bed shear stress term around iteration level $p$ reads expressed at $x_{i-\quart}$:
%
\begin{align}
    & \left.  {c_f}_{i-\quart} \Fabs{q_{i-\quart}} \frac{q_{i-\quart}}{(h_{i-\quart})^2} \right|^{n+\theta, p+1} \approx
    \\
    & \approx {c_f}_{i-\quart} \Fabs{q^{n+\theta, p}_{i-\quart}}  \frac{q^{n+\theta, p}_{i-\quart}}{(h^{n+\theta, p}_{i-\quart})^2} +
    \nonumber \\
    & + {c_f}_{i-\quart} \pdiff{}{q}\left\{ \Fabs{q^{n+\theta, p}_{i-\quart}} \right\}   \frac{q^{n+\theta, p}_{i-\quart}}{(h^{n+\theta, p}_{i-\quart})^2} \theta \Delta q^{n+1, p+1}_{i-\quart} +
    \nonumber \\
    & + {c_f}_{i-\quart} \Fabs{q^{n+\theta, p}_{i-\quart}}\,  \frac{ 1 }{ (h^{n+\theta, p}_{i-\quart})^2 } \theta \Delta q^{n+1, p+1}_{i-\quart} +
    \nonumber \\
    & - {c_f}_{i-\quart} \Fabs{q^{n+\theta, p}_{i-\quart}}\, \frac{2 q^{n+\theta, p}_{i-\quart}}{(h^{n+\theta, p}_{i-\quart})^3} \theta \Delta h^{n+1, p+1}_{i-\quart}
\end{align}
and
\begin{align}
    \pdiff{}{q}\left\{ \Fabs{q^{n+\theta, p}_{i-\quart}} \right\} =
    (q^{n+\theta, p}_{i-\quart})^3\,((q^{n+\theta, p}_{i-\quart})^4 + \eps^4)^{-3/4}
\end{align}
The integral was split into two parts, both parts are integrated separately.
For the left part ($x_{i-\quart}$) we use:
\begin{align}
    {c_f}_{i-\quart} & = \quart \left( {c_f}_{i-1} + 3 {c_f}_{i} \right),
    \\
    h^{n+\theta, p}_{i-\frac{1}{4}} & = \frac{1}{4} \left( h^{n+\theta, p}_{i-1} + 3 h^{n+\theta, p}_{i} \right),
    \\
    q^{n+\theta, p}_{i-\frac{1}{4}} & = \frac{1}{4} \left( q^{n+\theta, p}_{i-1} + 3 q^{n+\theta, p}_{i} \right),
\end{align}
and for the right part ($x_{i+\quart}$) we use
\begin{align}
    {c_f}_{i+\quart} & = \quart \left( 3{c_f}_{i} + {c_f}_{i+1} \right),
    \\
    h^{n+\theta, p}_{i+\frac{1}{4}} & = \frac{1}{4} \left( 3 h^{n+\theta, p}_{i} + h^{n+\theta, p}_{i+1} \right),
    \\
    q^{n+\theta, p}_{i+\frac{1}{4}} & = \frac{1}{4} \left( 3 q^{n+\theta, p}_{i} + q^{n+\theta, p}_{i+1} \right).
\end{align}


%------------------------------------------------------------------------------
\subsubsection{Viscosity}
The viscosity term read:
\begin{align}
    &  \int^{x_{i+\half}}_{x_{i-\half}} \pdiff{}{x} \left( \nu h \pdiff{(q/h)}{x} \right)\ dx & =
    \left. \nu \left( \pdiff{q}{x} - \frac{q}{h} \pdiff{h}{x} \right) \right|_{i+\half} - \left. \nu \left( \pdiff{q}{x} - \frac{q}{h} \pdiff{h}{x} \right) \right|_{i-\half}
\end{align}
The linearization of the viscosity term ($\nu = {\it constant}$) around iteration level $p$ reads (see \autoref{sec:linearisation_viscosity} for a derivation):
\begin{align}
    &\nu \left(\pdiff{q^{n+\theta, p+1}_{i+\half}}{x} - \frac{q^{n+\theta, p+1}_{i+\half}}{h^{n+\theta, p+1}_{i+\half}} \pdiff{h^{n+\theta, p+1}_{i+\half}}{x} \right) \approx
    \\
    & \approx \nu  \pdiff{q^{n+\theta, p}_{i+\half}}{x}   -  \nu \frac{q^{n+\theta, p}_{i+\half}}{h^{n+\theta, p}_{i+\half}} \pdiff{h^{n+\theta, p}_{i+\half}}{x}  +
    \nonumber \\
    & + \theta \underbrace{\nu}_{\cal{A}} \pdiff{\Delta q^{n+1 p+1}_{i+\half}}{x}
    -  \theta \underbrace{\nu \frac{1}{h^{n+\theta, p}}\pdiff{h^{n+\theta, p}_{i+\half}}{x}}_{\cal{B}} \Delta q^{n+1 p+1}_{i+\half}  +
    \nonumber \\
    & + \theta \underbrace{\nu \frac{q^{n+\theta, p}_{i+\half}}{(h^{n+\theta, p}_{i+\half})^2} \pdiff{h^{n+\theta, p}_{i+\half}}{x}}_{\cal{C}} \Delta h^{n+1 p+1}_{i+\half}
    - \theta \underbrace{\nu \frac{q^{n+\theta, p}_{i+\half}}{h^{n+\theta, p}_{i+\half}}}_{\cal{D}} \pdiff{\Delta h^{n+1, p+1}_{i+\half}}{x}
\end{align}
where $\theta \cal{A}$, $\theta \cal{B}$, $\theta \cal{C}$ and $\theta \cal{D}$ are coefficients in the matrix of the \deltaformulation.
For the part at $x_{i-\half}$ a similar expression is feasible.

%------------------------------------------------------------------------------
\subsection{Discretizations at boundary}
For the 1D linear wave equations (\autoref{eq:1d_non_linear_wave2}) at each boundary one boundary condition need to be prescribed, that is the ingoing wave, called \textbf{essential} boundary condition (Dirichlet or Neumann condition).
And one boundary condition to handle the outgoing wave, called \textbf{natural} boundary condition.

The boundary conditions are presented for the left/west boundary.
First the \textbf{natural} boundary is discussed and after that the \textbf{essential} boundary condition.
A similar derivation can be given for right/east boundary.

The \textbf{essential} boundary condition is to be assumed somewhere in the first control volume, ($x_{i_{bc}}$ with $i_{bc} \in [i-\half, i+\half]$ ).
For simplicity the boundary condition is chosen to be on node $i=1$ (location $x_{1}$).

%------------------------------------------------------------------------------
\subsubsection{Natural boundary condition}

The \textbf{natural} boundary condition for the left/west boundary, describing the undisturbed outgoing wave, reads (\autoref{eq:left_right_going_equations}):
\begin{align}
- \left(\sqrt{gh} + \frac{q}{h}\right) \underbrace{ \left(\pdiff{h}{t} + \pdiff{q}{x} + \ldots \right) }_{\text{continuity eq.}} + \underbrace{\left(\pdiff{q}{t} + g h \pdiff{\zeta}{x}+\ldots\right)}_{\text{momentum eq.}} = 0
\end{align}
For the \textbf{natural} boundary the values at the boundary ($x_{i+\half}$ with $i=0$) of $h$ and $q$ are computed as follows:
%
\begin{align}
    h_{i+\half} & = \frac{1}{2} \left( h_{i} +  h_{i+1} \right) +
    \frac{\alpha_{\it bnd}}{2} \left( h_{i}
    - 2 h_{i+1} + h_{i+2} \right)
    \nonumber \\*
    & = \half \left( 1 + \alpha_{\it bnd} \right) h_{i} +
    \half \left( 1 - 2\alpha_{\it bnd} \right) h_{i+1} +
    \half \alpha_{\it bnd} h_{i+2}\label{eq:h_at_left_boundary}
    \\
    q_{i+\half} & =  \frac{1}{2} \left( q_{i} + q_{i+1}\right)
    + \frac{\alpha_{\it bnd}}{2} \left( q_{i}
    - 2 q_{i+1} + q_{i+2} \right)
    \nonumber \\*
    & = \half \left( 1 + \alpha_{\it bnd} \right) q_{i} +
    \half \left( 1 - 2\alpha_{\it bnd} \right) q_{i+1} +
    \half \alpha_{\it bnd} q_{i+2}\label{eq:q_at_left_boundary}
\end{align}

%------------------------------------------------------------------------------
\paragraph*{Time derivative, continuity equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the time discretization of the continuity equation for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \pdiff{h}{t} & \approx \frac{1}{\Dt} \left(  h^{n+1}_{i+\half} - h^{n}_{i+\half} \right)
\end{align}
A diffusion like term is added to the boundary equation to damp the reflection of spurious waves.
A coefficient $\alpha_{\it bnd}$ is placed before that extra term, the optimal value of this coefficient is taken from the analysis in \citet{JanMooiman2025}.
\begin{align}
    & \frac{1}{\Dt}\left( \frac{1}{2} \left( h^{n+1,p+1}_{i} + h^{n+1,p+1}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2} \left( h^{n+1,p+1}_{i} - 2 h^{n+1,p+1}_{i+1} + h^{n+1,p+1}_{i+2}  \right) \right. +
    \nonumber \\*
    & \qquad  - \left. \left(
    \frac{1}{2} \left( h^{n}_{i} + h^{n}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( h^{n}_{i} - 2 h^{n}_{i+1} + h^{n}_{i+2}  \right) \right)
    \right)
\end{align}
After rearranging the equation into an implicit and an explicit part it reads:
\begin{align}
    & \frac{1}{\Dt}  \left( \half \left( \Delta h^{n+1, p+1}_{i} + \Delta h^{n+1, p+1}_{i+1} \right) \right. +
    \nonumber \\*
    & \qquad + \left. \frac{\alpha_{\it bnd}}{2}\left( \Delta h^{n+1,p+1}_{i} - 2 \Delta h^{n+1,p+1}_{i+1} + \Delta h^{n+1,p+1}_{i+2} \right) \right) +
    \nonumber \\
    & \qquad + \frac{1}{\Dt} \left\{ \half \left( h^{n+1, p}_{i} + h^{n+1, p}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2}\left(  h^{n+1,p}_{i} - 2 h^{n+1,p}_{i+1}  + h^{n+1,p}_{i+2} \right) + \right.
    \nonumber \\*
    &
    \qquad \left. - \left( \frac{1}{2} \left( h^{n}_{i} + h^{n}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( h^{n}_{i} - 2 h^{n}_{i+1} + h^{n}_{i+2}  \right) \right) \right\}
\end{align}

%------------------------------------------------------------------------------
\paragraph*{Mass flux, continuity equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the discretization of the mass flux for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \pdiff{q}{x} & \approx \frac{1}{\Dx} \left(  q^{n+\theta, p+1}_{i+1} - q^{n+\theta, p+1}_{i} \right)
\end{align}
which will be approximated by
\begin{align}
&\frac{1}{\Dx} \left( \left( q^{n+\theta, p}_{i+1} + \theta \Delta q^{n+1, p+1}_{i+1}\right)
- \left( q^{n+\theta, p+1}_{i} + \theta \Delta q^{n+1, p+1}_{i}\right) \right)
\\
\Leftrightarrow &
\\
&\frac{\theta }{\Dx} \left( \Delta q^{n+1, p+1}_{i+1} - \Delta q^{n+1, p+1}_{i}\right) +
\frac{1}{\Dx} \left\{ q^{n+\theta, p}_{i+1} - q^{n+\theta, p+1}_{i} \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Time derivative, momentum equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the time discretization of the momentum equation for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \pdiff{q}{t} & \approx \frac{1}{\Dt} \left(  q^{n+1}_{i+\half} - q^{n}_{i+\half} \right)
\end{align}
A diffusion like term is added to the boundary equation to damp the reflection of spurious waves.
A coefficient $\alpha_{\it bnd}$ is placed before that extra term, the optimal value of this coefficient is taken from the analysis in \citet{JanMooiman2025}.
\begin{align}
    & \frac{1}{\Dt}\left( \frac{1}{2} \left( q^{n+1,p+1}_{i} + q^{n+1,p+1}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2} \left( q^{n+1,p+1}_{i} - 2 q^{n+1,p+1}_{i+1} + q^{n+1,p+1}_{i+2}  \right) \right. +
    \nonumber \\*
    & \qquad  - \left. \left(
    \frac{1}{2} \left( q^{n}_{i} + q^{n}_{i+1} \right)
    + \frac{\alpha_{\it bnd}}{2}  \left( q^{n}_{i} - 2 q^{n}_{i+1} + q^{n}_{i+2}  \right) \right)
    \right)
\end{align}
After rearranging the equation into an implicit and an explicit part it reads:
\begin{align}
    & \frac{1}{\Dt}  \left( \half \left( \Delta q^{n+1, p+1}_{i} + \Delta q^{n+1, p+1}_{i+1} \right) \right. +
    \nonumber \\*
    & \qquad + \left. \frac{\alpha_{\it bnd}}{2}\left( \Delta q^{n+1,p+1}_{i} - 2 \Delta q^{n+1,p+1}_{i+1} + \Delta q^{n+1,p+1}_{i+2} \right) \right) +
    \nonumber \\
    & \qquad +  \frac{1}{\Dt} \left\{ \half \left( q^{n+1, p}_{i} + q^{n+1, p}_{i+1} \right) + \frac{\alpha_{\it bnd}}{2}\left( q^{n+1,p}_{i} - 2 q^{n+1,p}_{i+1}  + q^{n+1,p}_{i+2} \right) + \right.
    \nonumber \\*
    & \qquad
    \left.  - \frac{1}{2} \left( q^{n}_{i} + q^{n}_{i+1} \right) - \frac{\alpha_{\it bnd}}{2} \left( q^{n}_{i} - 2 q^{n}_{i+1} + q^{n}_{i+2}  \right) \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Pressure term, momentum equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the discretization of the pressure term for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    gh \pdiff{\zeta}{x} \approx
& g h^{n+\theta,p+1}_{i+\half} \pdiff{}{x} \left( \zeta^{n+\theta,p+1}_{i+\half}\right)
\end{align}
In a formulation of the shallow-water equations, where the equation for the free-surface level $\zeta$ reduces to $\zeta = h + z_b$ (excluding drying and flooding), the equations can be simplified, because $\Delta \zeta = \Delta h$ (when $z_b$ is not time dependent).
In this case, the contributions to the $\Delta \zeta$-equations need to be incorporated in the $\Delta h$-equations.
The pressure term will then be approximated by
\begin{align}
& \frac{1}{\Dx} g h^{n+\theta,p}_{i+\half} \left( \zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i}  \right) +
\nonumber \\*
& \qquad + \frac{1}{\Dx}  g \left(  \zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i} \right) \theta \Delta h^{n+1, p+1}_{i+\half} +
\nonumber \\*
& \qquad +   \frac{1}{\Dx} g h^{n+\theta, p}_{i+\half}
\theta \left( \Delta \zeta^{n+1,p+1}_{i+1}  - \Delta \zeta^{n+1,p+1}_{i}\right)
\end{align}
After rearranging the equation into an implicit and an explicit part it reads:
\begin{align}
& \frac{1}{\Dx}  g \left(  \zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i} \right) \theta \Delta h^{n+1, p+1}_{i+\half} +   \frac{1}{\Dx} g h^{n+\theta, p}_{i+\half}
\theta \left( \Delta \zeta^{n+1,p+1}_{i+1}  - \Delta \zeta^{n+1,p+1}_{i}\right) +
\nonumber \\*
& \qquad + \left\{
\frac{1}{\Dx} g h^{n+\theta,p}_{i+\half} \left( \zeta^{n+\theta,p}_{i+1} - \zeta^{n+\theta,p}_{i}  \right)  \right\}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Convection term, momentum equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the discretization of the convection term for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    \pdiff{q^2/h}{x} & = \frac{2q}{h}\pdiff{q}{x} - \frac{q^2}{h^2}\pdiff{h}{x} \approx
    \nonumber \\*
    & \approx \frac{2q^{n+\theta, p+1}_{i+\half}}{h^{n+\theta, p+1}_{i+\half}}\pdiff{q^{n+\theta, p+1}_{i+\half}}{x} - \frac{(q^{n+\theta, p+1}_{i+\half})^2}{(h^{n+\theta, p+1}_{i+\half})^2}\pdiff{h^{n+\theta, p+1}_{i+\half}}{x}
\end{align}
which will be approximated by
\begin{align}
    & \left. \frac{2q}{h}\pdiff{q}{x}\right|_{i+\half} - \left. \frac{q^2}{h^2}\pdiff{h}{x}\right|_{i+\half}
    \approx
    \\
    & \qquad \approx \underbrace{\frac{2q^{n+\theta, p}_{i+\half}}{ h^{n+\theta, p}_{i+\half}} \pdiff{}{x}\left( q^{n+\theta, p}_{i+\half} \right)
        - \frac{(q^{n+\theta, p}_{i+\half})^2}{(h^{n+\theta, p}_{i+\half})^2} \pdiff{}{x} \left( h^{n+\theta, p}_{i+\half} \right)}_{\textit{ to right handside}} +
    \nonumber \\
    & \qquad + \theta\ \underbrace{\left( -\frac{2q^{n+\theta, p}_{i+\half}}{ (h^{n+\theta, p}_{i+\half})^2}  \pdiff{}{x} \left( q^{n+\theta,p}_{i+\half}  \right)
        + \frac{2(q^{n+\theta, p}_{i+\half})^2}{(h^{n+\theta, p}_{i+\half})^3} \pdiff{}{x} \left( h^{n+\theta,p} _{i+\half} \right)
        \right)}_{\cal A} \Delta h^{n+1, p+1}_{i+\half} +
    \nonumber \\
    & \qquad + \theta\ \underbrace{\left( \frac{2}{ h^{n+\theta, p}_{i+\half}} \pdiff{}{x} \left( q^{n+\theta, p}_{i+\half} \right)
        -  \frac{2q^{n+\theta, p}_{i+\half}}{(h^{n+\theta, p}_{i+\half})^2} \pdiff{}{x} \left( h^{n+\theta, p}_{i+\half} \right)
        \right)}_{\cal B} \Delta q^{n+1, p+1}_{i+\half} +
    \nonumber \\
    &
    \qquad + \theta \underbrace{\left(- \frac{(q^{n+\theta, p}_{i+\half})^2}{(h^{n+\theta, p}_{i+\half})^2} \right)}_{\cal C} \pdiff{}{x} \left( \Delta h^{n+1, p+1}_{i+\half} \right)
    + \theta \underbrace{\frac{2q^{n+\theta, p}_{i+\half}}{ h^{n+\theta, p}_{i+\half}}}_{\cal D} \pdiff{}{x} \left( \Delta q^{n+1, p+1}_{i+\half} \right)
\end{align}
where $\theta\cal{A}$, $\theta\cal{B}$, $\theta\cal{C}$ and $\theta\cal{D}$ are coefficients in the matrix of the \deltaformulation.
%------------------------------------------------------------------------------
\paragraph*{Bed shear stress term, momentum equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the discretization of the bed shear stress term for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
\begin{align}
    c_f \frac{q\abs{q}}{h^2} \approx
    {c_f}_{i+\half} \frac{q^{n+\theta,p+1}_{i+\half}\abs{q^{n+\theta,p+1}_{i+\half}}}{(h^{n+\theta,p+1}_{i+\half})^2}
\end{align}
To avoid the discontinue derivative of the abs-function, this function is replaced by a $C^2$-continue function (\autoref{eq:continue_abs})
%
\begin{align}
    \abs{q} \approx \Fabs{q} = \left( q^4 + \eps^4 \right)^{1/4}, \qquad \eps = 0.01
\end{align}
which will be approximated by
\begin{align}
    & {c_f}_{i+\half} \frac{q^{n+\theta,p}_{i+\half}\Fabs{q^{n+\theta,p}_{i+\half}}}{(h^{n+\theta,p}_{i+\half})^2}
    +
    \nonumber \\*
    & \qquad + {c_f}_{i+\half} \frac{\Fabs{q^{n+\theta,p}_{i+\half}}}{(h^{n+\theta,p}_{i+\half})^2} \theta \Delta q^{n+1,p+1}_{i+\half}
    +
    \nonumber \\*
    & \qquad + {c_f}_{i+\half} \frac{q^{n+\theta,p}_{i+\half}}{(h^{n+\theta,p}_{i+\half})^2} \pdiff{}{q}\left(\Fabs{q^{n+\theta,p}_{i+\half}}\right)  \theta \Delta q^{n+1,p+1}_{i+\half}
    +
    \nonumber \\*
    & \qquad - {c_f}_{i+\half} \frac{2 q^{n+\theta,p}_{i+\half}\Fabs{q^{n+\theta,p}_{i+\half}}}{(h^{n+\theta,p}_{i+\half})^3} \theta \Delta h^{n+1,p+1}_{i+\half}
\end{align}
with
\begin{align}
    \pdiff{}{q}\left(\Fabs{q^{n+\theta,p}_{i+\half}}\right) =
    (q^{n+\theta, p}_{i+\half})^3\,((q^{n+\theta, p}_{i+\half})^4 + \eps^4)^{-3/4}
\end{align}
%------------------------------------------------------------------------------
\paragraph*{Viscosity term, momentum equation}
At the left/west boundary ($x_{i+\half}$ with $i=0$) the discretization of the viscosity term for the \textbf{natural} boundary condition, describing the outgoing wave, reads:
%
\begin{Remark}
    \item Strictly spoken there is no separation between left and right going waves when there is a viscosity term.
\end{Remark}
\begin{align}
&\pdiff{}{x}\left(\nu h \pdiff{(q/h)}{x}\right) =
\\
%& = \pdiff{\nu}{x} h \pdiff{(q/h)}{x} + \nu \pdiff{h}{x} \pdiff{(q/h)}{x} + \nu h \pdiff{}{x}\pdiff{(q/h)}{x} =
%\\
%& = \pdiff{\nu}{x} \left(\pdiff{q}{x} - \frac{q}{h}\pdiff{h}{x}\right) +
%\nu \pdiff{h}{x} \left( \frac{1}{h} \pdiff{q}{x} - \frac{q}{h^2}\pdiff{h}{x} \right) + \nu h \pdiff{}{x} \left( \frac{1}{h} \pdiff{q}{x} - \frac{q}{h^2}\pdiff{h}{x} \right) =
%\\
& = \pdiff{\nu}{x} \left(\pdiff{q}{x} - \frac{q}{h}\pdiff{h}{x}\right) +
\nu \pdiff{h}{x} \left( \frac{1}{h} \pdiff{q}{x} - \frac{q}{h^2}\pdiff{h}{x} \right) +
\nonumber \\*
%&
%- \nu \frac{1}{h}  \pdiff{q}{x} \pdiff{h}{x} +\nu \pdiff[2]{q}{x} +
%\\
%&- \left[ \nu \frac{1}{h} \pdiff{h}{x}\pdiff{q}{x} +
%\nu \frac{2q}{h^2} \pdiff{h}{x}\pdiff{h}{x}
%-
%\nu \frac{q}{h} \pdiff[2]{h}{x}
%\right]
%\nonumber \\
& \phantom{=}
- \nu \frac{1}{h}  \pdiff{q}{x} \pdiff{h}{x} +\nu \pdiff[2]{q}{x}
-  \nu \frac{1}{h} \pdiff{h}{x}\pdiff{q}{x} -
\nu \frac{2q}{h^2} \pdiff{h}{x}\pdiff{h}{x}
+
\nu \frac{q}{h} \pdiff[2]{h}{x}
\end{align}
which will be approximated by the following discretizations:
\begin{align}
    \pdiff{\nu}{x} & \approx \frac{\nu_{i+1} - \nu_{i}}{\Dx}
    \\
    \pdiff{q}{x} & \approx \frac{q^{n+\theta,p+1}_{i+1} - q^{n+\theta, p+1}_{i}}{\Dx}
    \\
    \pdiff{h}{x} & \approx \frac{h^{n+\theta,p+1}_{i+1} - h^{n+\theta, p+1}_{i}}{\Dx}
    \\
    \pdiff[2]{q}{x} & \approx \frac{q^{n+\theta,p+1}_{i-1} - 2 q^{n+\theta, p+1}_{i} + q^{n+\theta, p+1}_{i+1}}{\Dx}
    \\
    \pdiff[2]{h}{x} & \approx \frac{h^{n+\theta,p+1}_{i-1} - 2 h^{n+\theta, p+1}_{i} + h^{n+\theta, p+1}_{i+1}}{\Dx}
\end{align}
\todo{Natural boundary: viscosity term}
%------------------------------------------------------------------------------
\subsubsection{Essential boundary condition}
The \textbf{essential} boundary condition is to be assumed somewhere in the first control volume, ($x_{i_{bc}}$ with $i_{bc} \in [i-\half, i+\half]$ ).
For simplicity the boundary condition is chosen to be on node $i=1$ (location $x_{1}$).

The \textbf{essential} boundary condition for the left/west boundary at $x_{1}$ reads, describing the ingoing wave (indicated with $h^+$, $q^+$) with as less as possible disturbing the outgoing wave (\autoref{eq:left_right_going_equations}):
\begin{align}
    \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} & = F(t)
    \label{eq:essential_conv_1}
    \\
    \left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h^{+}}{t} - \pdiff{q^{+}}{t} & = 0
    \label{eq:essential_conv_2}
\end{align}
\Autoref{eq:essential_conv_2} means that the ingoing wave does not disturb the outgoing wave.

The essential boundary condition for the right/east boundary at $x_{I+\half}$ reads, describing the ingoing wave (indicated with $h^-$, $q^-$) with as less as possible disturbing the outgoing wave (\autoref{eq:left_right_going_equations}):\begin{align}
    \left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h^{-}}{t} - \pdiff{q^{-}}{t} & = G(t)
    \label{eq:essential_conv_3}
    \\
    \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{-}}{t} + \pdiff{q^{-}}{t} & = 0
    \label{eq:essential_conv_4}
\end{align}
\Autoref{eq:essential_conv_4} means that the ingoing wave does not disturb the outgoing wave.


%
%--------------------------------------------------------------------------------
\subsection*{Given water level at left/west boundary}

% \todo{Is the following assumption correct: if $\zeta_{\textit{given}} = f(t)$  is then $\lpdiff{q}{t}=0$}

Adding the equations (\eqref{eq:essential_conv_1} $+$ \eqref{eq:essential_conv_2}) yields
\begin{align}
    2 \sqrt{gh} \pdiff{h}{t} & = F(t)
\end{align}
%
So the essential boundary condition for incoming signal (if $\lpdiff{z_b}{t} = 0$) reads
\begin{align}
    {\boxed{
        \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  = 2 \sqrt{gh} \pdiff{\zeta_{\textit{given}}}{t}  + \eps(\zeta_{\textit{given}} - \zeta)
        }}\label{eq:essential_bc_zeta}
\end{align}
a correction term is added, to prevent drifting away of the solution (an integration constant is missing).
The variable $\eps$ has dimension \bunit{\metre\per\square\second}.

The discretization of  boundary \autoref{eq:essential_bc_zeta} at $x=i+\half$ reads
\begin{align}
    &\left(\sqrt{gh^{n+\theta,p+1}} - \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t}  =
    \nonumber \\*
    & = 2 \sqrt{gh^{n+\theta,p+1}} \pdiff{\zeta_{\textit{given}}}{t}
    + \eps \left( (\zeta_{\textit{given}} -z_b) - h^{n+1,p}   \right)
\end{align}

%
%--------------------------------------------------------------------------------
\subsection*{Given water flux at left/west boundary}
Subtracting the equations (\eqref{eq:essential_conv_1} $-$ \eqref{eq:essential_conv_2}), yields:
\begin{align}
    - 2 \frac{q}{h}\pdiff{h}{t}  + 2 \pdiff{q}{t} & =  F(h, q, t)
\end{align}
and using \autoref{eq:essential_conv_2} (ingoing information does not disturb outgoing information)
\begin{align}
    &\left(\sqrt{gh} + \frac{q}{h}\right) \pdiff{h}{t} - \pdiff{q}{t}  =0
    \\
    & \pdiff{h}{t}   =
    \frac{1}{\sqrt{gh} + \frac{q}{h}}\pdiff{q}{t}
    %\frac{h}{h\sqrt{gh} + q} \pdiff{q}{t} \label{eq:essential_conv_4}
\end{align}
So the essential boundary condition for incoming signal reads
\begin{align}
    & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    - 2 \frac{q}{h}\pdiff{h}{t}  + 2 \pdiff{q}{t}
    %        \\
    %       & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %       - 2 \frac{q}{h} \frac{h}{h\sqrt{gh} + q} \pdiff{q}{t}   + 2 \pdiff{q}{t}
    %       \\
    %       & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    %- 2 \frac{q}{h\sqrt{gh} + q} \pdiff{q}{t}   + 2 \pdiff{q}{t}
\end{align}
substituting \autoref{eq:essential_conv_4} into the right hand side, yields
\begin{align}
%        & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
%        2 \left( 1 -  \frac{q}{h\sqrt{gh} + q} \right)\pdiff{q}{t}
%        \\
%        & \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
%    2 \left( \frac{h\sqrt{gh} + q}{h\sqrt{gh} + q} -  \frac{q}{h\sqrt{gh} + q} \right)\pdiff{q}{t}
%        \\
&{\boxed{
    \left(\sqrt{gh} - \frac{q}{h}\right) \pdiff{h^{+}}{t} + \pdiff{q^{+}}{t} =
    2 \left( \frac{\sqrt{gh}}{\sqrt{gh} + \frac{q}{h}} \right)\pdiff{q_{\textit{given}}}{t} + \eps(q_{\textit{given}} - q)
}}\label{eq:essential_bc_q}
\end{align}
a correction term is added, to prevent drifting away of the solution (an integration constant is missing).
The variable $\eps$ has dimension \bunit{\per\second}.
The discretization of  boundary \autoref{eq:essential_bc_q} at $x=i+\half$ reads
\begin{align}
    &\left(\sqrt{gh^{n+\theta,p+1}} - \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}} \right) \pdiff{h}{t} + \pdiff{q}{t} =
    \nonumber \\*
    & = 2 \left(  \frac{\sqrt{gh^{n+\theta,p+1}}}{\sqrt{gh^{n+\theta,p+1}} + \frac{q^{n+\theta,p+1}}{h^{n+\theta,p+1}}} \right) \pdiff{q_{\textit{given}}}{t} + \eps \left( q_{\textit{given}} - q^{n+1,p}   \right)
\end{align}


